*%! NO_TIENE_TIMESTAMP = TRUE
*%! NO_HDR_CST = TRUE
*%! PGM_GDO = TRUE
*% FMT_CHI = TRUE
*% GEN_BCI = TRUE
*%! IF PGM_DTC
*%! INCLUDE 'GARSRC:GNSVSIDTC.SRC'
*%! END
*%! HASTA AQUI PARA MANEJAR VSAM EN AMBIENTE DTC
*%! IF NOT PGM_MCP
*% PGM_PTC = TRUE
*%! END
*% FRM = 'GDO'
*% REG = 'GDO'
*% HIJ = 'GDG'
*% CAIREG = 'GDO-CAI-GTIA'
*% IICREG = 'GDO-IIC-GTIA'
*% CAIFLD = 'GDO-CAI-GTIA'
*% IICFLD = 'GDO-IIC-GTIA'
*% SISREG = 'GAR'
*% IF NOT PGM_MCP AND PGM_PQ
*%! Codigo adicional para Funcion GARPPVCG = PF5
*% INCLUDE 'GARSRC:PFALL5.SRC'
*%! Codigo adicional para archivo
*% END
*% IF PGM_DTC
*% IF EOF
      *<<<< EOF
      *MHM-INI 23-OCT-2003
       COPY GNSBGCPT.
      *MHM-FIN 23-OCT-2003
       COPY GNSBGVSM.
       COPY GNSBHVSM.
      *>>>> END EOF
*% END
*% END
*% IF FIN_SCR_VARI
           03 CMA-VARI.
               05 GAR-CAI-GTIA                     PIC X(04).
               05 GAR-IIC-GTIA                     PIC X(08).
               05 GDG-FEC-FSOL.
                  07 GDG-NUM-SSOL                  PIC 9(02).
                  07 GDG-NUM-ASOL                  PIC 9(02).
                  07 GDG-NUM-MSOL                  PIC 9(02).
                  07 GDG-NUM-DSOL                  PIC 9(02).
               05 CMA-CIC-TGAR                     PIC X(06).
*% END
*% IF WSS
      *MHM-INI 23-OCT-2003
       COPY GNSWGCPT.
      *MHM-FIN 23-OCT-2003
       COPY GARBRGDG.
       COPY GARBRTAG.
       COPY GARWGVCG.
      *MHM-INI 31-JUL-2003
       COPY USPC113.
      *MHM-FIN 31-JUL-2003
*% IF PGM_CLB OR PGM_MEX
       COPY TABBRIVB.
       COPY GARBRGAP.
       COPY GARBRGDD.
       COPY GARBRGDP.
       COPY GARBRGES.
       COPY GARBRGIN.
       COPY GARBRGLE.
       COPY GARBRGMO.
       COPY GARBRGSE.
       COPY GARBRGSI.
       COPY GARBRGTP.
       COPY GARBRGUB.
       COPY GARBRGVT.
       COPY GARBRGIM.
       COPY GARBRGVE.
       COPY GARWVVCG.
*% END
      *REGISTRADO YA COMO GARANTIA. 
       COPY GARWGVDO.
      *
*% IF PGM_DTC
      *<<<< WSS AND PGM_DTC
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-GDG-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TAG-REQA==.
      *>>>>
*% END
*% IF PGM_VAX
           03 WSS-REG                          PIC X(03).
*% END
      *RRM-INI 8-SEP-2001 
      *01  WSS-COD-SOPE                        PIC X(03).
       01  WSS-COD-CGTA.
           03  WSS-COD-TOPE                            PIC X(03).
           03  WSS-COD-SOPE                            PIC X(03).
               88 DEPOSITO-A-PLAZO  VALUE '080'.
      *RRM-FIN 8-SEP-2001 
       01  WSS-VARI.
           03 WSS-CIV-SIV.
              05 WSS-COD-INEM                     PIC X(03).
              05 WSS-COD-SIEM                     PIC X(03).
           03 WSS-COD-DOC-VAL.
              05 WSS-SUC-VAL                      PIC 9(03).
              05 WSS-SUF-VAL                      PIC 9(01).
              05 WSS-COD-VAL                      PIC 9(06).
              05 WSS-TIT-VAL                      PIC 9(06).
      *MHM-INI 23-OCT-2003
           03 WSS-GLS-CGTA.
              05 WSS-GLS-TOPE                   PIC X(40).
              05 WSS-GLS-SOPE                   PIC X(40).
      *MHM-FIN 23-OCT-2003

*% END
*% CMA_USR = TRUE
*% IF CMA AND NOT PGM_VAX
*% IF NOT PGM_MCP
           02 FILLER                       PIC X(276).
*% ELSE
       01 FILLER                           PIC X(276).
*% END
*% END
*% IF INI_FIO AND NOT PGM_VAX
      *<<<< INI_FIO
           MOVE +276 TO SCR-TCMA.
      *>>>>
*% END
*% IF INI_FIO AND PGM_VAX
      *<<<< INI_FIO

           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           MOVE 'TAB'        TO FIO-SIST.
           PERFORM GNS-FIO-TAB.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM GNS-FIO-TAB.

           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           MOVE 'TAB'        TO FIO-SIST.
           PERFORM TAB-FIO-OFI.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM TAB-FIO-OFI.

           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           MOVE 'GAR'        TO FIO-SIST.
           PERFORM GAR-FIO-GDG.
           MOVE FIO-UPD TO FIO-CMND.
           PERFORM GAR-FIO-GDG.

           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           MOVE 'GAR'        TO FIO-SIST.
           PERFORM GAR-FIO-TAG.
           MOVE FIO-UPD TO FIO-CMND.
           PERFORM GAR-FIO-TAG.

      *>>>>
*% END
*% IF INI_FND_KEY
      *<<<< INI_FND_KEY
      *MHM-INI 31-JUL-2003
      * Llama a Subrutina Validacion Consistencia Garantia
           IF FRM-FFLD = FRM-FFLD-PF5
               PERFORM GAR-PRO-VCG
               GO TO FIN-FND-KEY.
      
      *MHM-FIN 31-JUL-2003
*% FIN_BUS_HIJ = TRUE
       BUS-GDG.
           MOVE GDO-CAI-GTIA IN GDO-FLD TO GDG-CAI-GTIA IN GDG.
           MOVE GDO-IIC-GTIA IN GDO-FLD TO GDG-IIC-GTIA IN GDG.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM GAR-FIO-GDG.
           MOVE FIO-STAT TO PGM-STAT-GDG.
           IF NOT FIO-STAT-OKS
               MOVE 'GDG    NEX' TO MSG-COD-MENS
               GO TO ERR-FND-KEY.
*% IF PGM_CHI
      *<<<< PGM_CHI
           IF SCR-CCPP = 'ACC' AND SCR-STAT = SCR-STAT-CON
               GO TO FIN-VAL-OFI-USP-GDO.

           MOVE 'TAB'          TO FIO-SIST.
           MOVE 'VSN'          TO TAB-COD-TTAB IN TAB.
           MOVE 'OFIUSP'       TO TAB-COD-CTAB IN TAB.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM GNS-FIO-TAB.
           IF NOT ( FIO-STAT-OKS AND TAB-MSC-STAT IN TAB = 'S' )
               GO TO FIN-VAL-OFI-USP-GDO.
      *MHM-INI 31-JUL-2003
      *ALD-BCI-INI/07032000
           COPY USPC143.
           MOVE 'GARGTUCG/CEN' TO USP-PTA-STR.
           COPY USPC103.
           IF USP-PERMISO = 'P'
               GO TO FIN-VAL-OFI-USP-GDO.
      *    COPY USPC143.
      *ALD-BCI-FIN/07032000
      *MHM-FIN 31-JUL-2003
           IF USP-COD-OFICINA NOT = GDG-COD-OFIC IN GDG 
               MOVE 'USRNODEOFI' TO MSG-COD-MENS
               GO TO ERR-FND-KEY.

       FIN-VAL-OFI-USP-GDO.
      *>>>>
*% END
*% IF PGM_PER AND PGM_GVT
      *<<<< PGM_PER AND PGM_GVT
       COPY GARBVUOF.
           IF MSG-COD-MENS > SPACES
               GO TO ERR-FND-KEY.
      *>>>>
*% END

       FIN-BUS-GDG.
      *RRM-INI 8-SEP-2001
      *    MOVE GDG-COD-TOPE IN GDG TO GDG-COD-TOPE IN GDO-FLD.
      *    MOVE GDG-COD-SOPE IN GDG TO GDG-COD-SOPE IN GDO-FLD.
*% IF FMT_CHI
      *<<<< FMT_CHI
           MOVE GDG-TIP-CGTA IN GDG TO GDG-TIP-CGTA IN GDO-FLD.
           MOVE GDG-STP-CGTA IN GDG TO GDG-STP-CGTA IN GDO-FLD.
      *>>>>
*% ELSE
           MOVE GDG-COD-CGTA IN GDG TO GDG-COD-CGTA IN GDO-FLD.
*% END
      *RRM-INI 8-SEP-2001

      *BUS-TAB Busca codigo de tabla
           MOVE 'TAB' TO TAB-COD-SIST.
*% IF GEN_BCI
      *<<<< GEN_BCI
           MOVE 'AUX' TO TAB-COD-TTAB IN TAB.
      *>>>>
*% ELSE
           MOVE 'GTA' TO TAB-COD-TTAB IN TAB.
*% END
           MOVE SPACES TO TAB-COD-CTAB IN TAB.
      *RRM-FIN 8-SEP-2001
      *    MOVE GDG-COD-TOPE IN GDO-FLD TO TAG-COD-TOPE IN TAG.
      *    MOVE GDG-COD-SOPE IN GDO-FLD TO TAG-COD-SOPE IN TAG.
*% IF FMT_CHI
      *<<<< FMT_CHI
           MOVE GDG-TIP-CGTA IN GDO-FLD TO TAG-TIP-AGTA IN TAG.
           MOVE GDG-STP-CGTA IN GDO-FLD TO TAG-STP-AGTA IN TAG.
      *>>>>
*% ELSE
           MOVE GDG-COD-CGTA IN GDO-FLD TO TAG-COD-AGTA IN TAG.
*% END
      *RRM-INI 8-SEP-2001
           MOVE TAG-COD-AGTA IN TAG     TO TAB-COD-CTAB IN TAB.
           PERFORM BUS-TAB.
           IF MSG-COD-MENS = SPACES
      *         MOVE TAB-CIC-CTAB IN TAB TO CMA-CIC-TGAR IN CMA-VARI
               MOVE TAB-GLS-DESC IN TAB TO
                    FRM-GLS-CGTA IN GDO-FLD
           ELSE
      *         MOVE SPACES TO CMA-CIC-TGAR IN CMA-VARI
               MOVE SPACES TO FRM-GLS-CGTA IN GDO-FLD.

      * Busca Glosa Tabla Real/no Real
           MOVE FIO-GET-KEY    TO FIO-CMND.
           PERFORM GAR-FIO-TAG.
           IF NOT FIO-STAT-OKS
                MOVE 'TAG    NEX' TO MSG-COD-MENS
                MOVE 'GAR' TO MSG-COD-SIST
                PERFORM GET-MSG
           ELSE
                MOVE SPACES TO MSG-COD-MENS
                MOVE 'GAR' TO TAB-COD-SIST
                MOVE 'RAL' TO TAB-COD-TTAB IN TAB
                MOVE TAG-IND-TREA IN TAG TO TAB-COD-CTAB IN TAB
                     
                PERFORM BUS-TAB
                IF MSG-COD-MENS = SPACES
                    MOVE TAB-GLS-DESC IN TAB TO 
                         FRM-GLS-TREA IN GDO-FLD
                ELSE
                    MOVE SPACES TO FRM-GLS-TREA IN GDO-FLD.


           MOVE GDG-CAI-GTIA IN GDG TO GAR-CAI-GTIA IN CMA-VARI.
           MOVE GDG-IIC-GTIA IN GDG TO GAR-IIC-GTIA IN CMA-VARI.
           IF SCR-CMND = 'ING'
               PERFORM PUT-GDG-GDO.

      * Valida Este permitido esta Entidad para Tipo-Subtipo
           IF TAG-IND-EGDO IN TAG = 'N'
               MOVE 'TAG    NOPGM' TO MSG-COD-MENS
               GO TO ERR-FND-KEY.

           MOVE GDG-FEC-FSOL IN GDG TO GDG-FEC-FSOL IN CMA-VARI.
      *>>>>
*% END
*% IF FIN_FND_KEY
      *<<<< FIN_FND_KEY
*% IF PGM_PER
           IF CMA-CIC-TGAR IN CMA-VARI = 'DOCVAL'
              AND ( SCR-CCPP = 'MOD' OR 'ELI' )
               MOVE GDO-COD-DOCU IN GDO TO WSS-COD-DOC-VAL IN WSS-VARI
               MOVE 'GAR'                   TO FIO-SIST
               MOVE 'SVM'                   TO TAB-COD-TTAB IN TAB
               MOVE WSS-SUC-VAL IN WSS-VARI TO TAB-COD-CTAB IN TAB
               MOVE FIO-GET-KEY             TO FIO-CMND
               PERFORM GNS-FIO-TAB
               IF NOT FIO-STAT-OKS
                   MOVE 'GAR'      TO MSG-COD-SIST
                   MOVE 'BCPDOCNO' TO MSG-COD-MENS 
                   GO TO ERR-FND-KEY.

           IF CMA-CIC-TGAR IN CMA-VARI = ( 'DOCCBR' OR 'DOCCEX' OR 
              'DOCDPN' OR 'DOCFCC' )
                 AND (SCR-CCPP = 'ING'  OR  'MOD')
              MOVE 'GAR'      TO MSG-COD-SIST
              MOVE 'BCPDOCNO' TO MSG-COD-MENS 
              GO TO ERR-FND-KEY.
*% END
      * Comando Consulta Error lo trata el GENESIS
           IF SCR-CCPP = 'ACC' AND SCR-STPP = SCR-STAT-CON
               GO TO FIN-FND-KEY.

      * Garantia Alzada
           IF GDG-IND-EST1 IN GDG > '19'
               MOVE 'GDGALZ' TO MSG-COD-MENS
               GO TO ERR-FND-KEY.

      * Garantia Completa
           IF SCR-CCPP = 'ELI' AND
              GDG-IND-GTAC IN GDG = 'S'
               MOVE 'GAR    CPL' TO MSG-COD-MENS
               GO TO ERR-FND-KEY.

           GO TO FIN-FND-KEY.
       ERR-FND-KEY.
           MOVE 'GAR' TO MSG-COD-SIST.
           PERFORM GET-MSG.
           MOVE MSG-GLS-DESC TO FRM-MENS.
           MOVE SCR-STAT-ABT TO SCR-STAT.
           IF SCR-CCPP = 'ING'
               MOVE '00' TO FIO-STAT
           ELSE
               MOVE FIO-STAT-NEX TO FIO-STAT.

      *>>>>
*% END
*% IF FND_KEY
      *<<<< FND_KEY
           IF SCR-CCPP = 'ING'
               PERFORM BUS-COR-GDO
               GO TO CON-FND-KEY.

           IF GDO-NUM-IGDO IN GDO NOT > ZEROES
               PERFORM BUS-COR-GDO.
       CON-FND-KEY.
      *>>>>
*% END
*% IF INI_CMN_ING
      *<<<< INI_CMN_ING
           MOVE SPACES TO GDO-GLS-FLAG IN GDO.
           MOVE SPACES TO GDO-MSC-TACC IN GDO.
           MOVE SPACES TO GDO-CIC-UING IN GDO.
      *    MOVE SPACES TO GDO-CIC-UACT IN GDO.
           MOVE 'I'    TO GDO-MSC-STAT IN GDO.


      *>>>>
*% END
*% IF CMN_ING OR CMN_MOD
      *<<<< INI_CMN_ING OR INI_CMN_MOD
           PERFORM GET-FHOY.
           IF SCR-CCPP = 'ING'
              OR SCR-CMND = 'COP'
               MOVE 'I'      TO GDO-MSC-TACC    IN GDO

               MOVE HOY-FHOY TO GDO-FEC-FING IN GDO
*% IF PGM_MVS
               MOVE SCR-USER TO GDO-CIC-UING IN GDO
*% END
           ELSE
*% IF PGM_MVS
      *         MOVE SCR-USER TO GDO-CIC-UACT IN GDO
*% END
               MOVE 'M'      TO GDO-MSC-TACC    IN GDO.
*% IF PGM_MVS
*% END
      *>>>>
*% END
*% IF FIN_CMN_MOD
      *<<<< FIN_CMN_MOD
           IF NOT FIO-STAT-OKS                                                  
      *        Error inconsistencia en la modificacion : informar               
               MOVE FIO-MENS TO FRM-MENS
               GO TO FIN-CMN-MOD.
      *>>>>
*% END
*% IF FIN_CMN_ING
      *<<<< FIN_CMN_ING
           IF NOT FIO-STAT-OKS                                                  
      *        Error inconsistencia en el ingreso : informar                    
               MOVE FIO-MENS TO FRM-MENS
               GO TO FIN-CMN-ING. 

           MOVE GDO-CAI-GTIA IN GDO TO GDG-CAI-GTIA IN GDG.
           MOVE GDO-IIC-GTIA IN GDO TO GDG-IIC-GTIA IN GDG.
           MOVE FIO-GET-KEY-UPD TO FIO-CMND.
           PERFORM GAR-FIO-GDG.
           IF FIO-STAT-OKS
               MOVE 'S' TO GDG-IND-EGDO IN GDG
               MOVE FIO-MOD TO FIO-CMND
               PERFORM GAR-FIO-GDG.

      *>>>>
*% END
*% IF FIN_CMN_ELI
      *<<<< FIN_CMN_ELI
           IF NOT FIO-STAT-OKS
      *        Error inconsistencia en la eliminacion : informar
               MOVE FIO-MENS TO FRM-MENS
               GO TO FIN-CMN-ELI.

           MOVE GDO-CAI-GTIA IN GDO TO GDG-CAI-GTIA IN GDG.
           MOVE GDO-IIC-GTIA IN GDO TO GDG-IIC-GTIA IN GDG.
           MOVE FIO-GET-KEY-UPD TO FIO-CMND.
           PERFORM GAR-FIO-GDG.
           IF FIO-STAT-OKS
               MOVE ' ' TO GDG-IND-EGDO IN GDG
               MOVE FIO-MOD TO FIO-CMND
               PERFORM GAR-FIO-GDG.
      *>>>>
*% END
*% IF EOF
      *<<<< EOF
       BUS-COR-GDO SECTION.
       INI-BUS-COR-GDO.
           MOVE 999 TO GDO-NUM-IGDO IN GDO.
           MOVE FIO-GET-LEQ TO FIO-CMND.
           PERFORM GAR-FIO-GDO.
           IF NOT ( FIO-STAT-OKS AND
                    GDO-CAI-GTIA IN GDO-FLD = GDO-CAI-GTIA IN GDO AND
                    GDO-IIC-GTIA IN GDO-FLD = GDO-IIC-GTIA IN GDO )
               PERFORM KEY-ALL-GDO
               MOVE ZEROES TO GDO-NUM-IGDO IN GDO.
           IF SCR-CCPP = 'ING'
               ADD 1 TO GDO-NUM-IGDO IN GDO
               MOVE GDO-NUM-IGDO IN GDO TO GDO-NUM-IGDO IN GDO-FLD
           ELSE
               MOVE GDO-NUM-IGDO IN GDO TO GDO-NUM-IGDO IN GDO-FLD.
       FIN-BUS-COR-GDO.
           EXIT.
      *************
       COPY GNSBVCOD.
       COPY GNSBVTAB.
      ***************
       COPY GARBFGDG.
       COPY GARBFTAG.
*% IF PGM_CLB OR PGM_MEX
       COPY TABBFIVB.
       COPY GARBFGAP.
       COPY GARBFGSE.
       COPY GARBFGDD.
       COPY GARBFGES.
       COPY GARBFGDP.
       COPY GARBFGIN.
       COPY GARBFGLE.
       COPY GARBFGMO.
       COPY GARBFGSI.
       COPY GARBFGTP.
       COPY GARBFGUB.
       COPY GARBFGVT.
       COPY GARBFGIM.
       COPY GARBFGVE.
       COPY GARBGVC2.
*% END
*% IF PGM_PU 
      *<<<< PGM_PU
       COPY GARBGVDO.
      *>>>>
*% END
      *>>>>
       COPY GARBKVCG.
       COPY GARBGVCG.
*% END
