       IDENTIFICATION DIVISION.
      *=======================
       PROGRAM-ID.      GARPGPA3.
       AUTHOR.          R. CHIANG.
       DATE-WRITTEN     19-JUN-2003.
      
       ENVIRONMENT DIVISION.
      *====================
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
      *        DECIMAL-POINT IS COMMA.
      
       DATA DIVISION.
      *=============
       WORKING-STORAGE SECTION.
      *-----------------------
      
       COPY GARBRRS1.
       COPY GARBRDDS.
       COPY GARBRDS2.
      
       COPY TABBRCAM.
       COPY GNSBRTAB.
       COPY GNSBRMSG.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-CAM-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSG-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TAB-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TAG-REQA==.
       COPY GNSWGRQA.
       COPY GNSWGUIB.
       COPY GNSWGELS.
       COPY GNSWVIDD.
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGSYS.
      
       01  VARIABLES.
           03 WSS-LEIDOS-RS1    VALUE ZEROES      PIC 9(08).
           03 WSS-LEIDOS-DDS    VALUE ZEROES      PIC 9(08).
           03 WSS-GRABAR-DS2    VALUE ZEROES      PIC 9(08).
           03 WSS-YALEIDO       VALUE ZEROES      PIC 9(01).
           03 WSS-TOT-ARR       VALUE 1000        PIC 9(04).
           03 WSS-IND-ARR       VALUE ZEROES      PIC 9(04).
           03 WSS-AUX-ARR       VALUE ZEROES      PIC 9(04).
           03 WSS-CIC-ICLI.
              05 WSS-CAI-ICLI   VALUE SPACES      PIC X(04).
              05 WSS-IIC-ICLI   VALUE ZEROES      PIC 9(08).
           03 WSS-RSP-RS1       VALUE SPACES      PIC X(40).
      
       01  ARREGLO.
           03 WSS-BKP-RS1  OCCURS  1000      PIC X(40).
       PROCEDURE DIVISION.
      *==================
      
       MAIN SECTION.
       INI-MAIN.
       COPY GNSBGEDB.
           ENTRY 'DBMSCBL'
           MOVE 'GARPGPA3' TO FIO-PROG.
           PERFORM GNS-BUS-IDD.
           PERFORM OPEN-FILE.
           MOVE 0 TO WSS-YALEIDO.
           PERFORM PROCESO.
           PERFORM ESTADISTICAS.
           PERFORM CLOSE-FILE.
           PERFORM GNS-PRO-END.
       FIN-MAIN.
           EXIT.
      *
      ******************************************************************
      *
       OPEN-FILE SECTION.
       INI-OPEN-FILE.
      *    DISPLAY 'INI-OPEN-FILE'.
           MOVE 'GAR'   TO FIO-SIST.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM GAR-FIO-RS1.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM GAR-FIO-DDS.
           MOVE FIO-OUT TO FIO-CMND.
           PERFORM GAR-FIO-DS2.
      *    DISPLAY 'FIN-OPEN-FILE'.
       FIN-OPEN-FILE.
           EXIT.
      *
      ******************************************************************
      *
       PROCESO SECTION.
       INI-PROCESO.
           PERFORM LEER-GARDDS.
           IF NOT FIO-STAT-OKS
              GO TO FIN-PROCESO.
      
           IF GDD-CIC-ICLI IN DDS = WSS-CIC-ICLI
              PERFORM BKP-RS1
              GO TO INI-PROCESO.
      
           MOVE GDD-CIC-ICLI IN DDS TO WSS-CIC-ICLI.
           MOVE ZEROES              TO WSS-IND-ARR.
      
       UNO-PROCESO.
           IF WSS-YALEIDO = 0
              PERFORM LEER-GARRS1
              IF NOT FIO-STAT-OKS
                 GO TO FIN-PROCESO.
           IF GDD-CIC-ICLI IN DDS = RS1-CIC-ICLI IN RS1
              PERFORM GRB-RS1
              PERFORM GRABAR-DS2
              MOVE 0 TO WSS-YALEIDO
              GO TO UNO-PROCESO.
           IF GDD-CIC-ICLI IN DDS > RS1-CIC-ICLI IN RS1
              MOVE 0 TO WSS-YALEIDO
              GO TO UNO-PROCESO
           ELSE
              MOVE 1 TO WSS-YALEIDO
              GO TO INI-PROCESO.
       FIN-PROCESO.
           EXIT.
      
       BKP-RS1 SECTION.
       INI-BKP-RS1.
           MOVE ZEROES TO WSS-AUX-ARR.
           MOVE RS1    TO WSS-RSP-RS1.
       LUP-BKP-RS1.
      
           ADD 1                         TO WSS-AUX-ARR.
           IF WSS-AUX-ARR > WSS-IND-ARR
              MOVE WSS-RSP-RS1 TO RS1
              GO TO FIN-BKP-RS1.
      
           MOVE WSS-BKP-RS1(WSS-AUX-ARR) TO RS1.
           PERFORM GRABAR-DS2.
           GO TO LUP-BKP-RS1.
      
       FIN-BKP-RS1.
           EXIT.
      *
      ******************************************************************
      *
       GRB-RS1 SECTION.
       INI-GRB-RS1.
      
           IF WSS-IND-ARR = WSS-TOT-ARR
              DISPLAY 'CLIENTE SUPERO MAXIMO :' GDD-CIC-ICLI IN DDS
              GO TO FIN-GRB-RS1.
      
           ADD 1    TO WSS-IND-ARR.
           MOVE RS1 TO WSS-BKP-RS1(WSS-IND-ARR).
      
       FIN-GRB-RS1.
           EXIT.
      *
      ******************************************************************
      *
       LEER-GARDDS SECTION.
       INI-LEER-GARDDS.
           MOVE FIO-GET-NXT     TO FIO-CMND.
           PERFORM GAR-FIO-DDS.
           ADD 1 TO WSS-LEIDOS-DDS.
       FIN-LEER-GARDDS.
           EXIT.
      *
      ******************************************************************
      *
       LEER-GARRS1 SECTION.
       INI-LEER-GARRS1.
           MOVE FIO-GET-NXT     TO FIO-CMND.
           PERFORM GAR-FIO-RS1
           ADD 1 TO WSS-LEIDOS-RS1.
       FIN-LEER-GARRS1.
           EXIT.
      *
      *****************************************************************
      *
       GRABAR-DS2 SECTION.
       INI-GRABAR-DS2.
           MOVE GAR-NUM-SIS     IN DDS TO DS2-NUM-SIS     IN DS2
           MOVE GAR-COD-CRR     IN DDS TO DS2-COD-CRR     IN DS2
           MOVE RS1-CAI-ICLI    IN RS1 TO DS2-CAI-ICLI    IN DS2.
           MOVE RS1-IIC-ICLI    IN RS1 TO DS2-IIC-ICLI    IN DS2.
           MOVE RS1-CAI-IOPC    IN RS1 TO DS2-CAI-IOPC    IN DS2.
           MOVE RS1-IIC-IOPC    IN RS1 TO DS2-IIC-IOPC    IN DS2.
           MOVE RS1-MSC-STAT    IN RS1 TO DS2-MSC-STAT    IN DS2.
           MOVE RS1-VAL-SCRE    IN RS1 TO DS2-VAL-SCRE    IN DS2.
           MOVE FIO-PUT                TO FIO-CMND.
           PERFORM GAR-FIO-DS2.
           ADD 1 TO WSS-GRABAR-DS2.
        FIN-GRABAR-DS2.
           EXIT.
      *
      ******************************************************************
      *
       ESTADISTICAS SECTION.
       INI-ESTADISTICAS.
           DISPLAY 'REGISTROS LEIDOS DE DDS     : ' WSS-LEIDOS-DDS
           DISPLAY 'REGISTROS LEIDOS DE RS1     : ' WSS-LEIDOS-RS1
           DISPLAY 'REGISTROS GRABADOS DE DS2   : ' WSS-GRABAR-DS2.
       FIN-ESTADISTICAS.
           EXIT.
      *
      ******************************************************************
      *
       CLOSE-FILE SECTION.
       INI-CLOSE-FILE.
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM GAR-FIO-DDS.
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM GAR-FIO-RS1.
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM GAR-FIO-DS2.
       FIN-CLOSE-FILE.
           EXIT.
      *
      ******************************************************************
      *
       PRG-ABT SECTION.
       INI-PRG-ABT.
            DISPLAY 'ABORTANDO EN PRG-ABT '.
            DISPLAY 'FIO-MENS : ' FIO-MENS.
            MOVE 100 TO RETURN-CODE.
            GOBACK.
       FIN-PRG-ABT.
            EXIT.
      *
      ******************************************************************
      *
       COPY GARBFDDS.
       COPY GARBFRS1.
       COPY GARBFDS2
       .
      
       COPY GNSBGDTC.
       COPY GNSBGIDD.
       COPY GNSBGEND.
       COPY GNSBGABT.
       COPY GNSBVTAB.
      
       COPY GNSBFTAB.
       COPY TABBFCAM.
       COPY GNSBFMSG.
       COPY GNSBBMSG.
       COPY GNSBBTAB.
       COPY GNSBBSYS.
      *
      
