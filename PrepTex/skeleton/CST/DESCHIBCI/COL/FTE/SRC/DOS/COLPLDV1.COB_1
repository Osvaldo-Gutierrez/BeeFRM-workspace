       IDENTIFICATION DIVISION.
      *=======================
       PROGRAM-ID.      COLPLDV1.
       AUTHOR.          CONSIST (RBG).
       DATE-WRITTEN.    06-Nov-96 04:17 PM.

      * Programa Listador de Reporte DV1 con Sort.

      *<<<< CMT_ID
      *>>>>

       ENVIRONMENT DIVISION.
      *====================
       CONFIGURATION SECTION.
      *---------------------
       SPECIAL-NAMES.
            DECIMAL-POINT IS COMMA.
       INPUT-OUTPUT SECTION.
      *--------------------
       FILE-CONTROL.
      *DOS SELECT GNSSRT         ASSIGN TO SYS001-DA-3330-S-SORTWK1.
      *MVS SELECT GNSSRT         ASSIGN TO        DA-S-SORTWK1.
      *DOS SELECT RPTDV1         ASSIGN TO SYS011-UR-1403-S.
      *MVS SELECT RPTDV1         ASSIGN TO        UT-S-RPTDV1.
           SELECT GNSSRT         ASSIGN TO        DA-S-SORTWK1.
           SELECT RPTDV1         ASSIGN TO        UT-S-RPTDV1.
      *<<<< IOS
      *>>>>

       DATA DIVISION.
      *=============
       FILE SECTION.
      *------------
       SD  GNSSRT.
       COPY COLRRDV1.
      *<<<< RR
      *>>>>
       FD  RPTDV1 LABEL RECORDS OMITTED
           REPORT IS RPT-DV1
      *<<<< FD_RPT
      *>>>>
           .
      *<<<< FLS
      *>>>>

       WORKING-STORAGE SECTION.
      *-----------------------
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-DVG-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TAB-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSG-REQA==.
       COPY COLBRDVG.
       COPY GNSWGRQA.
       COPY GNSWGUIB.
       COPY GNSWGELS.
       COPY GNSWVIDD.
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGRPT.
       COPY GNSBRTAB.
       COPY GNSBRMSG.
       COPY COLRWDV1.
      *<<<< RW
      *>>>>
       COPY GNSWGSYS.
       01  PGM-STAT.
           03 PGM-STAT-SRT            VALUE ' ' PIC X(01).
              88 PGM-STAT-SRT-OKS     VALUE ' '.
              88 PGM-STAT-SRT-MAL     VALUE 'M'.
           03 PGM-SOKS                VALUE ' ' PIC X(01).
           03 PGM-SMAL                VALUE 'M' PIC X(01).
      *<<<< WSS
       01  WSS-VARI.
           03 WSS-OPEC                 VALUE SPACES PIC X(08).
      *>>>>
      *<<<< WSS_DTC
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-CAN-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TOC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-VEN-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-ICG-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-OPC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-DLC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-RDC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-DBC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-OFI-REQA==.
       COPY COLBRCAN.
       COPY COLBRVEN.
       COPY COLBRICG.
       COPY COLBROPC.
       COPY COLBRDLC.
       COPY COLBRTOC.
       COPY COLBRRDC.
       COPY SGCBRDBC.
       COPY TABBROFI.
      *>>>>

       REPORT SECTION.
      *--------------
       COPY COLRFDV1.
      *<<<< RF
      *>>>>
           .
       COPY COLRTDV1.
      *<<<< RT
      *>>>>

       PROCEDURE DIVISION.
      *==================
       DECLARATIVES.
       DEC-CF-DV1-DVG-COD-TOOC SECTION.
           USE BEFORE REPORTING CF-DV1-DVG-COD-TOOC.
       INI-CF-DV1-DVG-COD-TOOC.
      *<<<< CF_DV1_DVG_COD_TOOC
      *>>>>
       FIN-CF-DV1-DVG-COD-TOOC.
           EXIT.
       DEC-CF-DV1-DVG-COD-OFOC SECTION.
           USE BEFORE REPORTING CF-DV1-DVG-COD-OFOC.
       INI-CF-DV1-DVG-COD-OFOC.
      *<<<< CF_DV1_DVG_COD_OFOC
      *>>>>
       FIN-CF-DV1-DVG-COD-OFOC.
           EXIT.
       DEC-PH-DV1 SECTION.
           USE BEFORE REPORTING PH-DV1.
       INI-PH-DV1.
      *<<<< PH_DV1
      *>>>>
       FIN-PH-DV1.
           EXIT.
      *<<<< FIN_DEC
      *>>>>
       END DECLARATIVES.

       MAIN SECTION.
      *------------
       INI-MAIN.
       COPY GNSBGEDB.
           MOVE 'COLPLDV1' TO FIO-PROG.
           PERFORM GNS-BUS-IDD.

           MOVE FIO-INP      TO FIO-CMND.
           MOVE 'GNS'        TO FIO-SIST.
           PERFORM GNS-FIO-TAB.
      *<<<< INI
           MOVE FIO-INP TO FIO-CMND.
           PERFORM COL-FIO-TOC.
      *>>>>
           SORT GNSSRT
       COPY COLRSDV1.
      *<<<< RS
      *>>>>
           INPUT  PROCEDURE IS INP-SRT
           OUTPUT PROCEDURE IS OUT-SRT.
       FIN-MAIN.
      *<<<< FIN
      *>>>>
           IF PGM-STAT-SRT-MAL OR SORT-RETURN > 0
               PERFORM GNS-PRO-ABT
           ELSE
               PERFORM GNS-PRO-END.

       INP-SRT SECTION.
      *---------------
       INI-INP-SRT.
      *<<<< INI_INP
           MOVE FIO-INP TO FIO-CMND.
           PERFORM COL-FIO-CAN.

           MOVE FIO-INP TO FIO-CMND.
           PERFORM COL-FIO-ICG.

           MOVE FIO-INP TO FIO-CMND.
           PERFORM COL-FIO-OPC.

           MOVE FIO-INP TO FIO-CMND.
           PERFORM COL-FIO-DLC.

           MOVE FIO-INP TO FIO-CMND.
           PERFORM SGC-FIO-DBC.

           MOVE FIO-INP TO FIO-CMND.
           PERFORM SGC-FIO-VEN.
      *>>>>
           MOVE FIO-INP TO FIO-CMND.
           PERFORM COL-FIO-DVG.
       FST-INP-SRT.
      *<<<< INI_FST_INP
      *>>>>
           MOVE FIO-GET-FST TO FIO-CMND.
           PERFORM COL-FIO-DVG.
      *<<<< FIN_FST_INP
      *>>>>
       LUP-INP-SRT.
           IF NOT FIO-STAT-OKS
              GO TO FIN-INP-SRT.
      *<<<< LUP_INP
      *Lee registro OPC
           PERFORM LEE-OPC.
           IF NOT FIO-STAT-OKS
               DISPLAY 'FALLO LECTURA OPC'
               GO TO NXT-INP-SRT.

      *Lee registro DLC
           PERFORM LEE-DLC.
           IF NOT FIO-STAT-OKS
               DISPLAY 'FALLO LECTURA DLC'
               GO TO NXT-INP-SRT.

      *Lee registro DBC
           PERFORM LEE-DBC.
           IF NOT FIO-STAT-OKS
               DISPLAY 'FALLO LECTURA DBC'
               GO TO NXT-INP-SRT.

      *Lee registro ICG para obtener Tasa de Interes
           PERFORM LEE-ICG.
           IF NOT FIO-STAT-OKS
               DISPLAY 'FALLO LECTURA ICG'
               GO TO NXT-INP-SRT.
      *>>>>
       MOV-INP-SRT.
       COPY COLRMDV1.
      *<<<< RM
      *>>>>
           RELEASE SRT.
       NXT-INP-SRT.
      *<<<< INI_NXT_INP
      *>>>>
           MOVE FIO-GET-NXT TO FIO-CMND.
           PERFORM COL-FIO-DVG.
      *<<<< FIN_NXT_INP
      *>>>>
           GO TO LUP-INP-SRT.
       FIN-INP-SRT.
      *<<<< FIN_INP
      *>>>>
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM COL-FIO-DVG.

       OUT-SRT SECTION.
      *---------------
       INI-OUT-SRT.
           IF PGM-STAT-SRT-MAL
               GO TO EXT-OUT-SRT.
      *<<<< INI_OUT
      *>>>>
           OPEN OUTPUT RPTDV1.
      *     MOVE 'COLPLDV1' TO RPT-NPGM.
           CALL 'GNSPLHDR' USING RPT-VARI.
           INITIATE RPT-DV1.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
      *<<<< FST_OUT
      *>>>>
       LUP-OUT-SRT.
      *<<<< LUP_OUT
      * Obtiene glosa de oficina
           IF DVG-COD-OFOC IN SRT > SPACES
               MOVE DVG-COD-OFOC IN SRT TO OFI-COD-OFIC IN OFI
               PERFORM BUS-OFI
               MOVE OFI-GLS-DESC IN OFI TO WSS-GLS-OFOC IN WSS-DV1.

      * BUS-TAB busca glosa de codigo en tabla
           IF DVG-COD-TOOC IN SRT > SPACES
               MOVE 'TAB' TO TAB-COD-SIST
               MOVE 'TIO' TO TAB-COD-TTAB IN TAB
               MOVE DVG-COD-TOOC IN DVG TO TAB-COD-CTAB IN TAB
               PERFORM BUS-TAB
               MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-TOOC IN WSS-DV1.
      *Busca Dato " Opera como = WSS-OPEC "
           MOVE DVG-COD-TOOC IN SRT TO TOC-COD-TOCR IN TOC.
           MOVE FIO-GET-KEY  TO FIO-CMND.
           PERFORM COL-FIO-TOC.
           IF NOT FIO-STAT-OKS
               DISPLAY 'ERROR LECTURA TOC ' TOC-COD-TOCR IN TOC
               GO TO OTRO-VEN.
           MOVE TOC-MSC-OPEC IN TOC TO WSS-OPEC IN WSS-VARI.
           IF WSS-OPEC IN WSS-VARI = 'D'
      * Voy a leer la ven.
               MOVE DVG-CAI-IOPC IN DVG TO VEN-CAI-IOPC IN VEN
               MOVE DVG-IIC-IOPC IN DVG TO VEN-IIC-IOPC IN VEN
               MOVE 1                   TO VEN-NUM-IVEN IN VEN
               MOVE FIO-GET-KEY TO FIO-CMND
               PERFORM COL-FIO-VEN
               IF FIO-STAT-OKS
                 SUBTRACT VEN-VAL-SCAP IN VEN FROM VEN-VAL-SFIN IN VEN 
                                        GIVING WSS-VAL-INTV IN WSS-DV1.
       OTRO-VEN.
      *>>>>
       GEN-OUT-SRT.
           GENERATE DL-DV1.
      *<<<< FIN_GEN_OUT
      *>>>>
       NXT-OUT-SRT.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
           GO TO LUP-OUT-SRT.
       FIN-OUT-SRT.
      *<<<< FIN_OUT
      *>>>>
           TERMINATE RPT-DV1.
      *<<<< FIN_TMT
      *>>>>
           CLOSE RPTDV1.
       EXT-OUT-SRT.
      *<<<< EXT_OUT
      *>>>>
           EXIT.
       COPY COLBFDVG.
       COPY GNSBGDTC.
       COPY GNSBGIDD.
       COPY GNSBTABT.
       COPY GNSBBSYS.
       COPY GNSBFTAB.
       COPY GNSBFMSG.
       COPY GNSBGEND.
       COPY GNSBGABT.

      *<<<< EOF
       COPY COLBFCAN.
       COPY COLBFTOC.
       COPY COLBFVEN.
       COPY COLBFICG.
       COPY COLBFOPC.
       COPY COLBFDLC.
       COPY COLBFRDC.
       COPY SGCBFDBC.
       COPY TABBBOFI.
       COPY TABBFOFI.
       COPY GNSBBTAB.
       COPY GNSBBMSG.

      ******************************************************************
       LEE-OPC SECTION.
      *****************
       INI-LEE-OPC.
           MOVE DVG-CIC-IOPC IN DVG TO OPC-CIC-IOPC IN OPC.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM COL-FIO-OPC.
           IF NOT FIO-STAT-OKS
               DISPLAY 'ERROR LECTURA OPC ' OPC-CIC-IOPC IN OPC.
       FIN-LEE-OPC.
           EXIT.

      ******************************************************************
       LEE-DLC SECTION.
      ****************
       INI-LEE-DLC.
           MOVE DVG-CIC-IOPC IN DVG TO DLC-CIC-IOPC IN DLC.
           MOVE ZEROES              TO DLC-NUM-IDLC IN DLC.
           MOVE FIO-GET-NLS TO FIO-CMND.
           PERFORM COL-FIO-DLC.
           IF NOT (FIO-STAT-OKS AND
                   DVG-CIC-IOPC IN DVG = DLC-CIC-IOPC IN DLC)
               DISPLAY 'ERROR LECTURA DLC ' DLC-KEY-IDLC IN DLC.
       FIN-LEE-DLC.
           EXIT.

      ******************************************************************
       LEE-DBC SECTION.
      ****************
       INI-LEE-DBC.
           MOVE DLC-CIC-IOPC IN DLC TO RDC-CIC-IOPC IN RDC.
           MOVE DLC-NUM-IDLC IN DLC TO RDC-NUM-IDLC IN RDC.
           MOVE FIO-GET-KEY TO FIO-CMND.
           MOVE 'RDC-KEY-IDLC' TO FIO-AKEY.
           PERFORM COL-FIO-RDC.
           IF NOT (FIO-STAT-OKS AND
                   DLC-KEY-IDLC IN DLC = RDC-KEY-IDLC IN RDC)
               DISPLAY 'ERROR LECTURA RDC ' RDC-KEY-IDLC IN RDC
               GO TO FIN-LEE-DBC.

           MOVE RDC-CIC-ICLI IN RDC TO DBC-CIC-ICLI IN DBC.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM SGC-FIO-DBC.
           IF NOT (FIO-STAT-OKS AND
                   RDC-CIC-ICLI IN RDC = DBC-CIC-ICLI IN DBC)
               DISPLAY 'ERROR LECTURA DBC ' DBC-CIC-ICLI IN DBC.
       FIN-LEE-DBC.
           EXIT.

      ******************************************************************
       LEE-ICG SECTION.
      ****************
       INI-LEE-ICG.
      *Lee primero la CAN para obtener llave de ICG
           MOVE DVG-CIC-IOPC IN DVG TO CAN-CIC-IOPC IN CAN.
           MOVE ZEROES              TO CAN-NUM-ICAN IN CAN.
           MOVE FIO-GET-NLS TO FIO-CMND.
           PERFORM COL-FIO-CAN.
           IF NOT (FIO-STAT-OKS AND
                   DVG-CIC-IOPC IN DVG = CAN-CIC-IOPC IN CAN)
               DISPLAY 'ERROR LECTURA CAN ' OPC-CIC-IOPC IN CAN
               GO TO FIN-LEE-ICG.

           MOVE CAN-CIC-IOPC IN CAN TO ICG-CIC-IOPC IN ICG.
           MOVE CAN-NUM-ICAN IN CAN TO ICG-NUM-ICAN IN ICG.
           MOVE CAN-CIC-IOPC IN CAN TO ICG-CIC-IOPV IN ICG
           MOVE ZEROES              TO ICG-NUM-IVCT IN ICG
           MOVE 'INT'               TO ICG-IND-TTAS IN ICG.
           MOVE ZEROES              TO ICG-FEC-FINI IN ICG.
           MOVE FIO-GET-NLS TO FIO-CMND.
           PERFORM COL-FIO-ICG.
           IF FIO-STAT-OKS AND
              CAN-CIC-IOPC IN CAN = ICG-CIC-IOPC IN ICG AND
              CAN-NUM-ICAN IN CAN = ICG-NUM-ICAN IN ICG
               DISPLAY 'ERROR LECTURA ICG ' ICG-CIC-IOPC IN ICG.
       FIN-LEE-ICG.
           EXIT.
      *>>>>
