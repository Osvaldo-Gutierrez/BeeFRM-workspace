       IDENTIFICATION DIVISION.
      *=======================
       PROGRAM-ID.      COLPGISC.
       AUTHOR.          BEE-TEAM.
       DATE-WRITTEN.    16-OCT-1997.
      * Graba Datos Archivo Opc con Cuentas Contables y Saldo Cuenta

       ENVIRONMENT DIVISION.
      *====================
       CONFIGURATION SECTION.
      *---------------------
       SPECIAL-NAMES.
            DECIMAL-POINT IS COMMA.

       DATA DIVISION.
      *=============
       WORKING-STORAGE SECTION.
      *-----------------------
      *<<<< WSS_DTC
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TAB-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-DCC-REQA==.
      *ALD-BCI-INI/12.01.1999
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-VEN-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-EVC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TOC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-OPC-REQA==.
      *ALD-BCI-FIN/12.01.1999
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-DLC-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-CAM-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSG-REQA==.
       COPY GNSBRMSG.
       COPY GNSBRTAB.
       COPY COLBROPS.
       COPY COLBRDCC.
       COPY COLBRDLC.
      *ALD-BCI-INI/12.01.1999
       COPY GNSBRMSC.
       COPY COLBRVEN.
       COPY COLBROPC.
       COPY COLBRTOC.
       COPY COLBREVC.
      *ALD-BCI-FIN/12.01.1999
       COPY COLBRISC.
       COPY TABBRCAM.

       COPY GNSWGRQA.
       COPY GNSWGUIB.
       COPY GNSWGELS.
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGSYS.
       COPY GNSWGFEC.
       COPY GNSWGHOY.
       COPY GNSWGPES.
       COPY GNSWVIDD.

       01  WSS-VARI.
      *ALD-BCI-INI/12.01.1999
           03  WSS-OPEC          VALUE SPACES     PIC X(01).
           03  WSS-IND-SLFI  VALUE 'N'            PIC X(01).
           03  WSS-FEC-FORI.
               05  WSS-NUM-SORI                   PIC 9(02).
               05  WSS-NUM-AORI                   PIC 9(02).
               05  WSS-NUM-MORI                   PIC 9(02).
               05  WSS-NUM-DORI                   PIC 9(02).
      *ALD-BCI-INI/12.01.1999
           03 WSS-OPC-RECH           VALUE ZEROS PIC 9(06).
           03 WSS-OPC-LEID           VALUE ZEROS PIC 9(06).
           03 WSS-ISC-REG            VALUE ZEROS PIC 9(06).
           03 WSS-COD-PESO                       PIC X(06).
           03 WSS-SGV-VCAM           VALUE ZEROS PIC S9(11)V9(04).
           03 WSS-TOT-SALD           VALUE ZEROS PIC 9(14)V9(04).
           03 WSS-FEC-FPRO.
              05 WSS-NUM-SPRO        VALUE ZEROS  PIC 9(02).
              05 WSS-NUM-APRO        VALUE ZEROS  PIC 9(02).
              05 WSS-NUM-MPRO        VALUE ZEROS  PIC 9(02).
              05 WSS-NUM-DPRO        VALUE ZEROS  PIC 9(02).
           03 VEC-OPC-CTA OCCURS 500 TIMES INDEXED BY MOV-I MOV-TOPE.
              05 VEC-CUENTA          PIC X(09).
231098*       05 VEC-COD-OFOC        PIC X(03).
      *VLB-INI-23-SEP-1997
              05 VEC-COD-COOC.
                 07 VEC-COD-TOOC     PIC X(03).
                 07 VEC-COD-AOOC     PIC X(03).
      *VLB-FIN-23-SEP-1997
              05 VEC-VAL-CRED        PIC 9(14)V9(04).
231098     03 VEC-COD-OFOC        PIC X(03).

       PROCEDURE DIVISION.
      *==================
       MAIN SECTION.
      *------------
       INI-MAIN.
           COPY GNSBGEDB.
           MOVE 'COLPGISC' TO FIO-PROG.
           PERFORM GNS-BUS-IDD.
           PERFORM OPEN-FILE.
      *    PERFORM OBT-PARAM.
           PERFORM OBT-MONEDA.
231098*    PERFORM LIMPIA-VECTOR.
           PERFORM LEE-OPC.
           PERFORM GRABA-VEC-ARCH.
231098*    PERFORM LIMPIA-VECTOR.
           PERFORM CLOSE-FILE.
       FIN-MAIN.
       COPY GNSBGGBK.

       OPEN-FILE SECTION.
      *-----------------
       INI-OPEN-FILE.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM COL-FIO-OPS.
           PERFORM COL-FIO-DLC.
           PERFORM COL-FIO-DCC.
           PERFORM TAB-FIO-CAM.
           MOVE FIO-OUT TO FIO-CMND.
           PERFORM COL-FIO-ISC.
       FIN-OPEN-FILE.
           EXIT.
       CLOSE-FILE SECTION.
      *------------------
       INI-CLOSE-FILE.
           DISPLAY ' '.
           DISPLAY '      ESTADISTICAS DE PROCESO'.
           DISPLAY '      ======================='.
           DISPLAY ' '.
           DISPLAY 'OPC LEIDAS    : ' WSS-OPC-LEID IN WSS-VARI.
           DISPLAY 'OPC RECHAZADAS: ' WSS-OPC-RECH IN WSS-VARI.
           DISPLAY 'ISC GRABADAS  : ' WSS-ISC-REG IN WSS-VARI.
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM COL-FIO-OPS.
           PERFORM COL-FIO-DLC.
           PERFORM COL-FIO-DCC.
           PERFORM COL-FIO-ISC.
           PERFORM TAB-FIO-CAM.
       FIN-CLOSE-FILE.
           EXIT.
       OBT-PARAM SECTION.
      *------------------
       INI-OBT-PARAM.
           PERFORM GET-FHOY.
           MOVE HOY-DHOY TO WSS-NUM-DPRO IN WSS-VARI.
           MOVE HOY-MHOY TO WSS-NUM-MPRO IN WSS-VARI.
           MOVE HOY-SHOY TO WSS-NUM-SPRO IN WSS-VARI.
           MOVE HOY-AHOY TO WSS-NUM-APRO IN WSS-VARI.
           DISPLAY 'FECHA PARAMETRO : ' WSS-FEC-FPRO IN WSS-VARI.
       FIN-OBT-PARAM.
           EXIT.

       OBT-MONEDA SECTION.
      *------------------
       INI-OBT-MONEDA.
      * Valida Tipo de Moneda
           MOVE 'TAB'    TO FIO-SIST.
           MOVE 'VLR'    TO TAB-CIC-TTAB IN TAB.
           MOVE '0999  ' TO TAB-CIC-CTAB IN TAB.
           MOVE 'TAB-CIC-TABL' TO FIO-AKEY.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM GNS-FIO-TAB.
           IF NOT FIO-STAT-OKS
              MOVE 'COL' TO MSG-COD-SIST
              MOVE 'CICPESONEX' TO MSG-COD-MENS IN MSG
              PERFORM GET-MSG
              DISPLAY MSG-GLS-DESC TAB-CIC-CTAB
              PERFORM GNS-PRO-ABT.
           MOVE TAB-COD-CTAB IN TAB TO WSS-COD-PESO IN WSS-VARI.
       FIN-OBT-MONEDA.
           EXIT.

       LEE-OPC SECTION.
      *--------------
       INI-LEE-OPC.
      *Programacin de Ciclo para Leer Archivo Opc
      *    MOVE WSS-FEC-FPRO IN WSS-VARI TO OPC-FEC-FINP IN OPC.
      *    MOVE FIO-GET-NLS TO FIO-CMND.
      *    MOVE 'OPC-FEC-FINP' TO FIO-AKEY.
      *Lectura Archivo Opc en forma secuencial
           MOVE FIO-GET-FST TO FIO-CMND.
           PERFORM COL-FIO-OPS.
           IF NOT (FIO-STAT-OKS)
              GO TO FIN-LEE-OPC.
      *    ELSE
      *       IF OPC-FEC-FINP IN OPS NOT = WSS-FEC-FPRO IN WSS-VARI
      *          GO TO FIN-LEE-OPC.
231098     MOVE OPC-COD-OFOC IN OPS TO VEC-COD-OFOC.

231098 INICIO-OFICINA.
231098     PERFORM LIMPIA-VECTOR.
           SET MOV-TOPE TO 1.

       LUP-LEE-OPC.
           ADD 1 TO WSS-OPC-LEID IN WSS-VARI.
           PERFORM LEE-DLC.
           IF NOT (FIO-STAT-OKS AND
           OPC-CIC-IOPC IN OPS = DLC-CIC-IOPC IN DLC)
              ADD 1 TO WSS-OPC-RECH IN WSS-VARI
              DISPLAY 'ERROR EN LEER DLC OPC : ' OPC-CIC-IOPC IN OPS
              GO TO NXT-LEE-OPC.
      *ALD-BCI-INI/12.01.1999
           MOVE OPC-FEC-FCOL IN OPS TO WSS-FEC-FORI.
           PERFORM PRO-PRO.

           MOVE OPC-COD-TOOC IN OPS TO TOC-COD-TOCR IN TOC.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM COL-FIO-TOC.
      *Obtiene Como Opera
           MOVE 'COL'               TO MSC-COD-SIST FIO-SIST.
           MOVE 'OPEC'              TO MSC-COD-TMSC IN MSC.
           MOVE TOC-MSC-OPEC IN TOC TO MSC-COD-CMSC IN MSC.
           MOVE FIO-GET-KEY         TO FIO-CMND.
           PERFORM GNS-FIO-MSC.
           MOVE MSC-CIC-CMSC IN MSC TO WSS-OPEC IN WSS-VARI.
      *
           MOVE OPC-CIC-IOPC IN OPS TO EVC-CIC-IOPC IN EVC.
           MOVE ZEROES              TO EVC-NUM-IEVC IN EVC.
           MOVE FIO-GET-NLS         TO FIO-CMND.
           MOVE 'N'                 TO WSS-IND-SLFI IN WSS-VARI.
       LUP-LEE-EVC.
           PERFORM COL-FIO-EVC.
           IF FIO-STAT-OKS AND
              OPC-CIC-IOPC IN OPS = EVC-CIC-IOPC IN EVC
               IF EVC-MSC-TCVE IN EVC = 'FI'
                 MOVE 'S'           TO WSS-IND-SLFI IN WSS-VARI
                 MOVE FIO-GET-NXT   TO FIO-CMND
                 GO TO LUP-LEE-EVC
               ELSE
                 MOVE 'N'           TO WSS-IND-SLFI IN WSS-VARI.

           IF WSS-OPEC IN WSS-VARI     = 'D' OR
              WSS-IND-SLFI IN WSS-VARI = 'S'
               PERFORM LEE-PRA-VEN.

      *ALD-BCI-FIN/12.01.1999

           PERFORM OBT-CUENTA-DCC.
           IF NOT (FIO-STAT-OKS)
              ADD 1 TO WSS-OPC-RECH IN WSS-VARI
              DISPLAY 'ERROR EN LEER DCC  : ' DCC-KEY-IREG IN DCC '  '
              OPC-CIC-IOPC IN OPS
              GO TO NXT-LEE-OPC.


           IF OPC-COD-VCOC IN OPS = WSS-COD-PESO IN WSS-VARI
              MOVE 1 TO WSS-SGV-VCAM IN WSS-VARI
           ELSE
              MOVE OPC-COD-VCOC IN OPS TO CAM-COD-VCAM IN CAM(1)
              MOVE WSS-COD-PESO IN WSS-VARI TO CAM-COD-VCAM IN CAM(2)
      *ALD-BCI-INI/12.01.1999
      *        MOVE OPC-FEC-FCOL IN OPS TO CAM-FEC-FCAM IN CAM(1)
      *        MOVE OPC-FEC-FCOL IN OPS TO CAM-FEC-FCAM IN CAM(2)
              MOVE WSS-FEC-FORI         TO CAM-FEC-FCAM IN CAM(1)
              MOVE WSS-FEC-FORI         TO CAM-FEC-FCAM IN CAM(2)
      *ALD-BCI-INI/12.01.1999
              MOVE FIO-GET-KEY TO FIO-CMND
              PERFORM TAB-FIO-CAM
              IF NOT FIO-STAT-OKS AND CAM-IND-VIGE NOT = 'S'
                 MOVE 'COL' TO MSG-COD-SIST
                 MOVE 'CAMVCAMNEX' TO MSG-COD-MENS
                 PERFORM GET-MSG
                 DISPLAY MSG-GLS-DESC CAM-KEY-CAMB IN CAM
                 GO TO NXT-LEE-OPC
              ELSE
                 MOVE CAM-SGV-VCAM IN CAM TO
                 WSS-SGV-VCAM IN WSS-VARI.

      *     MULTIPLY WSS-SGV-VCAM IN WSS-VARI BY OPC-VAL-SCRE IN OPS
      *     GIVING WSS-TOT-SALD IN WSS-VARI.

           MULTIPLY WSS-SGV-VCAM IN WSS-VARI
                    BY OPC-VAL-SCRE IN OPS
                    GIVING PES-SGV-DECI IN PES-VARI ROUNDED.

           PERFORM PES-SCTV
           MOVE PES-SGV-ENTE IN PES-VARI TO WSS-TOT-SALD IN WSS-VARI.

      * Inserta En La Matriz
           SET MOV-I TO 1.
           SEARCH VEC-OPC-CTA AT END GO TO SIG1-INS-MAT
           WHEN VEC-CUENTA(MOV-I)    = DCC-GLS-CCSB IN DCC
231098*    AND  VEC-COD-OFOC(MOV-I)  = OPC-COD-OFOC IN OPS
      *VLB-INI 23-SEP-1997
           AND  VEC-COD-COOC(MOV-I)  = OPC-COD-COOC IN OPS
      *VLB-FIN 23-SEP-1997
                GO TO SIG2-INS-MAT.
       SIG1-INS-MAT.
      * Se Graba Registro Por 1 Vez
           IF MOV-TOPE > 500
              DISPLAY 'VECTOR FUERA DE RANGO. . .'
              PERFORM GNS-PRO-ABT.

           MOVE DCC-GLS-CCSB IN DCC TO VEC-CUENTA(MOV-TOPE).
231098*    MOVE OPC-COD-OFOC IN OPS TO VEC-COD-OFOC(MOV-TOPE).
      *VLB-INI  23-SEP-1997
           MOVE OPC-COD-COOC IN OPS TO VEC-COD-COOC(MOV-TOPE).
      *VLB-FIN  23-SEP-1997
           MOVE WSS-TOT-SALD IN WSS-VARI TO VEC-VAL-CRED(MOV-TOPE).
           SET MOV-TOPE UP BY 1.
           GO TO NXT-LEE-OPC.
       SIG2-INS-MAT.
      * Actualiza Registro En La Matriz
           ADD WSS-TOT-SALD IN WSS-VARI TO VEC-VAL-CRED(MOV-I).
       NXT-LEE-OPC.
           MOVE FIO-GET-NXT TO FIO-CMND.
      *    MOVE 'OPC-FEC-FINP' TO FIO-AKEY.
           PERFORM COL-FIO-OPS.
           IF NOT (FIO-STAT-OKS)
              GO TO FIN-LEE-OPC.
231098     IF OPC-COD-OFOC IN OPS = VEC-COD-OFOC
              GO TO LUP-LEE-OPC.
231098 FIN-OFICINA.
231098     PERFORM GRABA-VEC-ARCH.
231098     MOVE OPC-COD-OFOC IN OPS TO VEC-COD-OFOC
231098     GO TO INICIO-OFICINA.
       FIN-LEE-OPC.
           EXIT.
       LEE-DLC SECTION.
      *---------------
       INI-LEE-DLC.
           MOVE OPC-CIC-IOPC IN OPS TO DLC-CIC-IOPC IN DLC.
           MOVE ZEROES TO DLC-NUM-IDLC IN DLC.
           MOVE FIO-GET-NLS TO FIO-CMND.
           PERFORM COL-FIO-DLC.
       FIN-LEE-DLC.
           EXIT.
       OBT-CUENTA-DCC SECTION.
      *----------------------
       INI-OBT-CUENTA-DCC.
           IF DLC-IND-SCTB IN DLC = 'MUL'
               MOVE SPACES TO DLC-IND-SCTB IN DLC.

           MOVE 'DCC'        TO DCC-COD-TTAB IN DCC.
           MOVE 'CAP'        TO DCC-MSC-TCCT IN DCC.
           MOVE OPC-COD-VCOC IN OPS TO DCC-COD-VCAM IN DCC.
           MOVE OPC-COD-COOC IN OPS TO DCC-COD-COCR IN DCC.
           MOVE DLC-IND-SCBZ IN DLC TO DCC-IND-SCBZ IN DCC.
           MOVE DLC-IND-SCRT IN DLC TO DCC-IND-SCRT IN DCC.
           MOVE DLC-IND-SCTB IN DLC TO DCC-IND-SCTB IN DCC.
           MOVE DLC-COD-PLZO IN DLC TO DCC-COD-PLZO IN DCC.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM COL-FIO-DCC.
           IF NOT FIO-STAT-OKS
      * Bsqueda Generica.
              MOVE '*' TO DCC-COD-PLZO IN DCC.
              MOVE FIO-GET-KEY TO FIO-CMND
              PERFORM COL-FIO-DCC
              IF NOT FIO-STAT-OKS
                 MOVE '*     ' TO DCC-COD-COCR IN DCC
                 MOVE FIO-GET-KEY TO FIO-CMND
                 PERFORM COL-FIO-DCC
                 IF NOT FIO-STAT-OKS
                    GO TO FIN-OBT-CUENTA-DCC.
       FIN-OBT-CUENTA-DCC.
           EXIT.
       GRABA-VEC-ARCH SECTION.
      *----------------------
       INI-GRABA-VEC-ARCH.
           SET MOV-I TO 1.
       LUP-GRABA-VEC-ARCH.
           IF MOV-I NOT < MOV-TOPE
              GO TO FIN-GRABA-VEC-ARCH.
           MOVE VEC-CUENTA(MOV-I)   TO ISC-GLS-CCSB IN ISC.
231098*    MOVE VEC-COD-OFOC(MOV-I) TO ISC-COD-OFOC IN ISC.
231098     MOVE VEC-COD-OFOC        TO ISC-COD-OFOC IN ISC.
      *VLB-INI  23-SEP-1997
           MOVE VEC-COD-COOC(MOV-I) TO ISC-COD-COOC IN ISC.
      *VLB-FIN  23-SEP-1997
           MOVE VEC-VAL-CRED(MOV-I) TO ISC-VAL-SCRE IN ISC.
           MOVE FIO-PUT TO FIO-CMND.
           PERFORM COL-FIO-ISC.
           SET MOV-I UP BY 1.
           ADD 1 TO WSS-ISC-REG IN WSS-VARI.
           GO TO LUP-GRABA-VEC-ARCH.
       FIN-GRABA-VEC-ARCH.
           EXIT.
       LIMPIA-VECTOR SECTION.
      *---------------------
       INI-LIMPIA-VECTOR.
           SET MOV-I TO 1.
       LUP-LIMPIA-VECTOR.
           IF MOV-I > 500
              SET MOV-I TO 1
              GO TO FIN-LIMPIA-VECTOR.

           MOVE SPACES TO VEC-CUENTA(MOV-I).
231098*    MOVE SPACES TO VEC-COD-OFOC(MOV-I).
      *VLB-INI  23-SEP-1997
           MOVE SPACES TO VEC-COD-COOC(MOV-I).
      *VLB-FIN  23-SEP-1997
           MOVE ZEROES TO VEC-VAL-CRED(MOV-I).
           SET MOV-I UP BY 1.
           GO TO LUP-LIMPIA-VECTOR.
       FIN-LIMPIA-VECTOR.
           EXIT.

       COPY COLBFOPS.
       COPY COLBFDCC.
      *ALD-BCI-INI/12.01.1999
       COPY GNSBFMSC.
       COPY COLBFVEN.
       COPY COLBFTOC.
       COPY COLBFOPC.
       COPY COLBFEVC.
      *ALD-BCI-FIN/12.01.1999
       COPY COLBFDLC.
       COPY GNSBFMSG.
       COPY GNSBFTAB.
       COPY COLBFISC.

       COPY TABBFCAM.
       COPY GNSBBMSG.
       COPY GNSBBTAB.
       COPY GNSBGDTC.
       COPY GNSBGIDD.
       COPY GNSBTABT.
       COPY GNSBBSYS.
       COPY GNSBGFEC.
       COPY GNSBPFEC.
       COPY GNSBGHOY.
       COPY GNSBGEND.
       COPY GNSBGABT.
       COPY GNSBGPES.
      *ALD-BCI-INI/12.01.1999
       PRO-PRO SECTION.
       INI-PRO-PRO.
      * Obtiene valor renovado si opc es ingreso de prorroga.
      * Conversion a pesos se efectua a la fcol original.
           IF OPC-IND-RENO IN OPS NOT = 'PRO'
              GO TO FIN-PRO-PRO.
      * Lee OPC original para rescatar la fecha de origen.
           MOVE DLC-CIC-IOCO IN DLC TO OPC-CIC-IOPC IN OPC.
           MOVE FIO-GET-KEY  TO FIO-CMND.
           PERFORM COL-FIO-OPC.
           IF NOT FIO-STAT-OKS
              MOVE 'COL'        TO MSG-COD-SIST
              MOVE 'OPCORIGNEX' TO MSG-COD-MENS
              PERFORM GET-MSG
              DISPLAY MSG-GLS-DESC   OPC-CIC-IOPC IN OPC
           ELSE
      * Mueve fecha de OPC original para la conversion a valor origen
              MOVE OPC-FEC-FCOL IN OPC TO WSS-FEC-FORI IN WSS-VARI.
       FIN-PRO-PRO.
           EXIT.
       LEE-PRA-VEN SECTION.
       INI-LEE-PRA-VEN.
           MOVE OPC-CIC-IOPC IN OPS TO VEN-CIC-IOPC IN VEN.
           MOVE 1                   TO VEN-NUM-IVEN IN VEN.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM COL-FIO-VEN.
           IF NOT FIO-STAT-OKS
               MOVE 'VEN   INEX' TO  MSG-COD-MENS IN MSG
               GO TO FIN-LEE-PRA-VEN.
           MOVE VEN-VAL-CAPI IN VEN TO OPC-VAL-SCRE IN OPS.
       FIN-LEE-PRA-VEN.
           EXIT.
      *ALD-BCI-INI/12.01.1999
