       IDENTIFICATION DIVISION.
      *=======================
       PROGRAM-ID.      CTBPLCPR.
       AUTHOR.          CONSIST.
       DATE-WRITTEN.    27-Sep-89 11:57 AM.

      * Programa Listador de Reporte CPR sin Sort.

       ENVIRONMENT DIVISION.
      *====================
       CONFIGURATION SECTION.
      *---------------------
       SPECIAL-NAMES.
            DECIMAL-POINT IS COMMA.
       INPUT-OUTPUT SECTION.
      *--------------------
       FILE-CONTROL.
           SELECT RPTCPR       ASSIGN TO RPTCPR.

       DATA DIVISION.
      *=============
       FILE SECTION.
      *------------
       FD  RPTCPR LABEL RECORD OMITTED
           REPORT IS RPT-CPR
           .

       WORKING-STORAGE SECTION.
      *-----------------------
       COPY CTBBRPOP.
       COPY CTBRRCPR.
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGRPT.
       COPY CTBRWCPR.
       COPY GNSWGSYS.
       01  PGM-STAT.
           03 PGM-STAT-SRT            VALUE ' ' PIC X(01).
              88 PGM-STAT-SRT-OKS     VALUE ' '.
              88 PGM-STAT-SRT-MAL     VALUE 'M'.
           03 PGM-SOKS                VALUE ' ' PIC X(01).
           03 PGM-SMAL                VALUE 'M' PIC X(01).
       COPY CTBBRCDC.
       COPY CTBBRCTB.
       COPY CTBBRBGR.
       01  WSS-VARI.
           03 WSS-FEC-FACC.
              05 WSS-NUM-DACC                  PIC 9(02).
              05 WSS-NUM-MACC                  PIC 9(02).
              05 WSS-NUM-SACC                  PIC 9(02).
              05 WSS-NUM-AACC                  PIC 9(02).
              05 WSS-IND-CCDC    VALUE 1       PIC 9(01).
              05 WSS-IND-CCTB    VALUE 1       PIC 9(01).
              05 WSS-IND-MAYD    VALUE 1       PIC 9(01).

       REPORT SECTION.
      *--------------
       COPY CTBRFCPR.
           .
       COPY CTBRTCPR.

       PROCEDURE DIVISION.
      *==================
       DECLARATIVES.
       DEC-CH-CPR-POP-NUM-CCDC SECTION.
           USE BEFORE REPORTING CH-CPR-POP-NUM-CCDC.
       INI-CH-CPR-POP-NUM-CCDC.
           MOVE 1 TO WSS-IND-MAYD.
           MOVE SPACES TO CDC.
           MOVE POP-NUM-CCDC IN SRT TO CDC-NUM-CCDC IN CDC.
           MOVE FIO-GET-KEY TO FIO-CMND.
      *     PERFORM CTB-FIO-CDC.
           CALL 'CTBPFCDC' USING FIO-VARI CDC.
           IF NOT FIO-STAT-OKS
               MOVE 'CENTRO DE COSTOS INEXISTENTE' TO CDC-GLS-CCDC
               MOVE SPACES TO CDC-VRF-CCDC.
       FIN-CH-CPR-POP-NUM-CCDC.
           EXIT.
       DEC-CH-CPR-POP-NUM-CCTB SECTION.
           USE BEFORE REPORTING CH-CPR-POP-NUM-CCTB.
       INI-CH-CPR-POP-NUM-CCTB.
      *     IF WSS-IND-CCTB = 1
      *         MOVE 0 TO WSS-IND-CCTB
      *         MOVE 1 TO PRINT-SWITCH.
           IF WSS-IND-MAYD = 1
               MOVE 0 TO WSS-IND-MAYD
       COPY GNSBGSPI.
           .
           MOVE SPACES TO CTB.
           MOVE POP-NUM-CCTB IN SRT TO CTB-NUM-CCTB IN CTB.
           MOVE FIO-GET-KEY TO FIO-CMND.
      *     PERFORM CTB-FIO-CTB.
           CALL 'CTBPFCTB' USING FIO-VARI CTB.
           IF NOT FIO-STAT-OKS
               MOVE 'CUENTA CONTABLE INEXISTENTE' TO CTB-GLS-CCTB
               MOVE SPACES TO CTB-VRF-CCTB.
      *     IF WSS-IND-CCDC = 1
      *         MOVE 0 TO WSS-IND-CCDC
      *         MOVE 1 TO PRINT-SWITCH.
       FIN-CH-CPR-POP-NUM-CCTB.
           EXIT.
       DEC-DL-CPR SECTION.
           USE BEFORE REPORTING DL-CPR.
       INI-DL-CPR.
       FIN-DL-CPR.
           EXIT.
       END DECLARATIVES.

       MAIN SECTION.
      *------------
       INI-MAIN.
           MOVE 'CTBPLCPR' TO FIO-PROG.
       INI-INP-SRT.
           DISPLAY 'FECHA INICIAL DDMMSSAA :'.
           ACCEPT WSS-FEC-FACC.
           MOVE WSS-NUM-DACC TO WSS-NUM-DDES.
           MOVE WSS-NUM-MACC TO WSS-NUM-MDES.
           MOVE WSS-NUM-SACC TO WSS-NUM-SDES.
           MOVE WSS-NUM-AACC TO WSS-NUM-ADES.

           DISPLAY 'FECHA FINAL DDMMSSAA :'.
           ACCEPT WSS-FEC-FACC.
           MOVE WSS-NUM-DACC TO WSS-NUM-DHAS.
           MOVE WSS-NUM-MACC TO WSS-NUM-MHAS.
           MOVE WSS-NUM-SACC TO WSS-NUM-SHAS.
           MOVE WSS-NUM-AACC TO WSS-NUM-AHAS.
           MOVE ZEROES TO WSS-NUM-APOP.
           MOVE ZEROES TO WSS-NUM-ABGR.
           MOVE ZEROES TO WSS-NUM-ADIF.
           MOVE ZEROES TO WSS-VAL-DIFE.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM CTB-FIO-CDC.
           IF NOT FIO-STAT-OKS
               DISPLAY 'ERROR APERTURA ARCHIVO CDC: ABORTO'
               STOP RUN.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM CTB-FIO-CTB.
           IF NOT FIO-STAT-OKS
               DISPLAY 'ERROR APERTURA ARCHIVO CTB: ABORTO'
               STOP RUN.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM CTB-FIO-BGR.
           IF NOT FIO-STAT-OKS
               DISPLAY 'ERROR APERTURA ARCHIVO BGR ABORTO'
               STOP RUN.
           CALL 'GNSPLHDR' USING RPT-VARI.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM CTB-FIO-POP.
       FST-INP-SRT.
           MOVE FIO-GET-FST TO FIO-CMND.
           PERFORM CTB-FIO-POP.
       INI-OUT-SRT.
           OPEN OUTPUT RPTCPR.
           INITIATE RPT-CPR.
           MOVE SPACES TO CDC.
           MOVE POP-NUM-CCDC IN POP TO CDC-NUM-CCDC IN CDC.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM CTB-FIO-CDC.
           IF NOT FIO-STAT-OKS
               MOVE 'CENTRO DE COSTOS INEXISTENTE' TO CDC-GLS-CCDC
               MOVE SPACES TO CDC-VRF-CCDC.
           MOVE SPACES TO CTB.
           MOVE POP-NUM-CCTB IN POP TO CTB-NUM-CCTB IN CTB.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM CTB-FIO-CTB.
           IF NOT FIO-STAT-OKS
               MOVE 'CUENTA CONTABLE INEXISTENTE' TO CTB-GLS-CCTB
               MOVE SPACES TO CTB-VRF-CCTB.
           MOVE FIO-GET-FST TO FIO-CMND.
           PERFORM CTB-FIO-POP.
       LUP-MAIN.
       LUP-INP-SRT.
           IF NOT FIO-STAT-OKS
                GO TO FIN-MAIN.
           MOVE POP-COD-PROP TO BGR-COD-CBGR.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM CTB-FIO-BGR.
           IF NOT FIO-STAT-OKS
               MOVE ZEROES TO BGR-VAL-VBGR IN BGR.
           IF POP-VAL-PROP IN POP NOT NUMERIC
                DISPLAY 'POP-VAL-PROP ERRONEO'.
           IF BGR-VAL-VBGR IN BGR NOT NUMERIC
                DISPLAY 'BGR-VAL-VBGR ERRONEO'.
       MOV-INP-SRT.
       COPY CTBRMCPR.
       LUP-OUT-SRT.
      *     DISPLAY 'POP-VAL-PROP '.
      *     DISPLAY POP-VAL-PROP IN SRT.
      *     DISPLAY 'BGR-VAL-VBGR '.
      *     DISPLAY BGR-VAL-VBGR IN SRT.
      *     DISPLAY 'CALCULANDO WSS-VAL-DIFE'.
           COMPUTE WSS-VAL-DIFE = BGR-VAL-VBGR IN SRT -
                                  POP-VAL-PROP IN SRT .
      *     DISPLAY 'CALCULADO  WSS-VAL-DIFE'.
      *     DISPLAY WSS-VAL-DIFE.

      *     DISPLAY 'CALCULANDO WSS-NUM-PORC'.
           IF POP-VAL-PROP IN SRT = ZEROES
               MOVE ZEROES TO WSS-NUM-PORC
           ELSE
               COMPUTE WSS-NUM-PORC =
                         ( BGR-VAL-VBGR IN SRT / 
                           POP-VAL-PROP IN SRT ) * 100.
      *     DISPLAY 'CALCULADO  WSS-NUM-PORC'.
      *     DISPLAY WSS-NUM-PORC.

      *     DISPLAY 'CALCULANDO WSS-NUM-APOP'.
           ADD POP-VAL-PROP IN SRT TO WSS-NUM-APOP.
      *     DISPLAY 'CALCULADO  WSS-NUM-APOP'.
      *     DISPLAY WSS-NUM-APOP.

      *     DISPLAY 'CALCULANDO WSS-NUM-ABGR'.
           ADD BGR-VAL-VBGR IN SRT TO WSS-NUM-ABGR.
      *     DISPLAY 'CALCULADO  WSS-NUM-ABGR'.
      *     DISPLAY WSS-NUM-ABGR.

      *     DISPLAY 'CALCULANDO WSS-NUM-ADIF'.
           ADD WSS-VAL-DIFE TO WSS-NUM-ADIF.
      *     DISPLAY 'CALCULADO  WSS-NUM-ADIF'.
      *     DISPLAY WSS-NUM-ADIF.
           GENERATE DL-CPR.
       NXT-INP-SRT.
       NXT-OUT-SRT.
           MOVE FIO-GET-NXT TO FIO-CMND.
           PERFORM CTB-FIO-POP.
           GO TO LUP-MAIN.
       FIN-MAIN.
       FIN-INP-SRT.
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM CTB-FIO-POP.
       FIN-OUT-SRT.
           TERMINATE RPT-CPR.
           CLOSE RPTCPR.
           PERFORM GNS-PRO-END.

       COPY CTBBFPOP.
       COPY GNSBBSYS.

       COPY CTBBFCDC.
       COPY CTBBFCTB.
       COPY CTBBFBGR.

       GNS-PRO-END SECTION.
       INI-GNS-PRO-END.
           STOP RUN.
       FIN-GNS-PRO-END.
           EXIT.
