       IDENTIFICATION DIVISION.
      *=======================
       PROGRAM-ID.      CDCPLRCU.
       AUTHOR.          CONSIST.
       DATE-WRITTEN.    11-Jun-90 07:59 PM.

      * Programa Listador de Reporte RCU con Sort.

       ENVIRONMENT DIVISION.
      *====================
       CONFIGURATION SECTION.
      *---------------------
       SPECIAL-NAMES.
            DECIMAL-POINT IS COMMA.
       INPUT-OUTPUT SECTION.
      *--------------------
       FILE-CONTROL.
      *DOS SELECT GNSSRT         ASSIGN TO SYS001-DA-3330-S-SORTWK1.
      *MVS SELECT GNSSRT         ASSIGN TO        DA-S-SORTWK1.
      *DOS SELECT RPTRCU         ASSIGN TO SYS011-UR-1403-S.
      *MVS SELECT RPTRCU         ASSIGN TO        UT-S-RPTRCU.
           SELECT GNSSRT         ASSIGN TO SYS001-DA-3330-S-SORTWK1.
           SELECT RPTRCU         ASSIGN TO SYS011-UR-1403-S.

       DATA DIVISION.
      *=============
       FILE SECTION.
      *------------
       SD  GNSSRT.
       COPY CDCRRRCU.
       FD  RPTRCU LABEL RECORDS OMITTED
           REPORT IS RPT-RCU
           .

       WORKING-STORAGE SECTION.
      *-----------------------
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-CIN-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TAB-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSG-REQA==.
       COPY CDCBRCIN.
       COPY GNSWGRQA.
       COPY GNSWGUIB.
       COPY GNSWGELS.
       COPY GNSWGIFD.
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGRPT.
       COPY GNSBRTAB.
       COPY GNSBRMSG.
       COPY CDCRWRCU.
       COPY GNSWGSYS.
       01  PGM-STAT.
           03 PGM-STAT-SRT            VALUE ' ' PIC X(01).
              88 PGM-STAT-SRT-OKS     VALUE ' '.
              88 PGM-STAT-SRT-MAL     VALUE 'M'.
           03 PGM-SOKS                VALUE ' ' PIC X(01).
           03 PGM-SMAL                VALUE 'M' PIC X(01).
      *<<<< WSS
       COPY GNSWGFEC.
       COPY GNSWGHOY.
       01  WSS-VARI.
           03 WSS-FEC-FUAS.
              05 WSS-NUM-DUAS                     PIC 9(02).
              05 WSS-NUM-MUAS                     PIC 9(02).
              05 WSS-NUM-SUAS                     PIC 9(02).
              05 WSS-NUM-AUAS                     PIC 9(02).
           03 WSS-FEC-FHOY.
              05 WSS-NUM-DHOY                     PIC 9(02).
              05 WSS-NUM-MHOY                     PIC 9(02).
              05 WSS-NUM-SHOY                     PIC 9(02).
              05 WSS-NUM-AHOY                     PIC 9(02).
           03 WSS-COD-IUSR                        PIC X(12).
           03 WSS-IND-NEXT                        PIC 9(01).
           03 WSS-NUM-TOTA      VALUE ZEROES      PIC 9(06).
           03 WSS-NUM-PASO      VALUE ZEROES      PIC 9(01)V9(05).
           03 WSS-NUM-DIFR      VALUE ZEROES      PIC 9(04).
           03 WSS-TAB-RETE.
              05 WSS-NUM-RETE   OCCURS 9          PIC 9(06).
       COPY TABBRUSR.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-USR-REQA==.
      *>>>>

       REPORT SECTION.
      *--------------
       COPY CDCRFRCU.
           .
       COPY CDCRTRCU.

       PROCEDURE DIVISION.
      *==================
       DECLARATIVES.
       DEC-PH-RCU SECTION.
           USE BEFORE REPORTING PH-RCU.
       INI-PH-RCU.
       FIN-PH-RCU.
           EXIT.
       DEC-FF-RCU SECTION.
           USE BEFORE REPORTING FF-RCU.
       INI-FF-RCU.
      *<<<< FF_RCU
      * Calculo de Porcentajes de Linea de Totales Finales
           DIVIDE SUM-NUM-RET1 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR1 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RET2 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR2 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RET3 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR3 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RET4 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR4 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RET5 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR5 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RET6 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR6 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RET7 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR7 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RET8 BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-POR8 IN WSS-RCU ROUNDED.
           DIVIDE SUM-NUM-RETT BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-PORT IN WSS-RCU ROUNDED.
      *>>>>
       FIN-FF-RCU.
           EXIT.
       END DECLARATIVES.

       MAIN SECTION.
      *------------
       INI-MAIN.
       COPY GNSBGEDB.
           MOVE 'CDCPLRCU' TO FIO-PROG.
           PERFORM BUS-FSIS.
           SORT GNSSRT
       COPY CDCRSRCU.
           INPUT  PROCEDURE IS INP-SRT
           OUTPUT PROCEDURE IS OUT-SRT.
       FIN-MAIN.
           PERFORM GNS-PRO-END.

       INP-SRT SECTION.
      *---------------
       INI-INP-SRT.
      *<<<< INI_INP

      * Inicializa Variables
           MOVE ZEROES TO WSS-TAB-RETE IN WSS-VARI.

           PERFORM GET-FHOY.
      *>>>>
           MOVE FIO-INP TO FIO-CMND.
           PERFORM CDC-FIO-CIN.
       FST-INP-SRT.
           MOVE FIO-GET-FST TO FIO-CMND.
           PERFORM CDC-FIO-CIN.
       LUP-INP-SRT.
           IF NOT FIO-STAT-OKS
              GO TO FIN-INP-SRT.
      *<<<< LUP_INP
      * Proceso de Seleccion y Clasificacion a Partir del Registro CIN
           PERFORM BUS-SRT-REG.
      *>>>>
       MOV-INP-SRT.
       COPY CDCRMRCU.
           RELEASE SRT.
       NXT-INP-SRT.
           MOVE FIO-GET-NXT TO FIO-CMND.
           PERFORM CDC-FIO-CIN.
           GO TO LUP-INP-SRT.
       FIN-INP-SRT.
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM CDC-FIO-CIN.

       OUT-SRT SECTION.
      *---------------
       INI-OUT-SRT.
           IF PGM-STAT-SRT-MAL
               GO TO EXT-OUT-SRT.
           OPEN OUTPUT RPTRCU.
           CALL 'GNSPLHDR' USING RPT-VARI.
           INITIATE RPT-RCU.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
      *<<<< FST_OUT
           MOVE CIN-COD-IUSR IN SRT TO WSS-COD-IUSR IN WSS-VARI.
      *>>>>
       LUP-OUT-SRT.
      *<<<< LUP_OUT
           PERFORM SEL-REG-PRO.
           GO TO NXT-OUT-SRT.
      *>>>>
       GEN-OUT-SRT.
           GENERATE DL-RCU.
       NXT-OUT-SRT.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
           GO TO LUP-OUT-SRT.
       FIN-OUT-SRT.
      *<<<< FIN_OUT
           PERFORM GEN-LIN-OUT.
      *>>>>
           TERMINATE RPT-RCU.
           CLOSE RPTRCU.
       EXT-OUT-SRT.
           EXIT.

       COPY CDCBFCIN.
       COPY GNSBGDTC.
       COPY GNSBGIFD.
       COPY GNSBTABT.
       COPY GNSBBSYS.
       COPY GNSBFTAB.
       COPY GNSBFMSG.
       COPY GNSBGEND.

      *<<<< EOF
      **************************************************************************
      * Formacion y Generacion del Registro SRT al Procesar Registros
       BUS-SRT-REG SECTION.
       INI-BUS-SRT-REG.
      * Complementa Formacion del Registro SRT
           ADD  1  TO WSS-NUM-TOTA IN WSS-VARI.

      * Completa Llenado de Campos y Genera el Registro SRT
      *     COPY COLRMRCU.
      *     RELEASE SRT.
       FIN-BUS-SRT-REG.
           EXIT.
      **************************************************************************
      * Seleccion del Registro para Proceso Mediante Sistema Asignado
       SEL-REG-PRO SECTION.
       INI-SEL-REG-PRO.
           MOVE  1  TO WSS-IND-NEXT IN WSS-VARI.

           IF CIN-COD-IUSR IN SRT NOT = WSS-COD-IUSR IN WSS-VARI
               PERFORM GEN-LIN-OUT
               MOVE ZEROES              TO WSS-TAB-RETE IN WSS-VARI
               MOVE CIN-COD-IUSR IN SRT TO WSS-COD-IUSR IN WSS-VARI.
           PERFORM DET-RET-CIN.

           MOVE  0  TO WSS-IND-NEXT IN WSS-VARI.
       FIN-SEL-REG-PRO.
           EXIT.
      **************************************************************************
      * Calcula Periodo de Retencion a HOY
       DET-RET-CIN SECTION.
       INI-DET-RET-CIN.
           PERFORM DIF-DIA.
           SUBTRACT FEC-NDIA FROM CIN-NUM-DRET IN SRT GIVING
                                            WSS-NUM-DIFR IN WSS-VARI.
           IF WSS-NUM-DIFR < 5
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(1)
           ELSE
           IF WSS-NUM-DIFR < 10
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(2)
           ELSE
           IF WSS-NUM-DIFR < 20
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(3)
           ELSE
           IF WSS-NUM-DIFR < 30
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(4)
           ELSE
           IF WSS-NUM-DIFR < 60
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(5)
           ELSE
           IF WSS-NUM-DIFR < 180
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(6)
           ELSE
           IF WSS-NUM-DIFR < 365
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(7)
           ELSE
               ADD 1 TO WSS-NUM-RETE IN WSS-VARI(8).
           ADD 1 TO WSS-NUM-RETE IN WSS-VARI(9).
       FIN-DET-RET-CIN.
           EXIT.
      **************************************************************************
      *Compara Fechas en Dias
       DIF-DIA SECTION.
       INI-DIF-DIA.
           MOVE CIN-NUM-DUAS IN SRT      TO WSS-NUM-DUAS IN WSS-VARI.
           MOVE CIN-NUM-MUAS IN SRT      TO WSS-NUM-MUAS IN WSS-VARI.
           MOVE CIN-NUM-SUAS IN SRT      TO WSS-NUM-SUAS IN WSS-VARI.
           MOVE CIN-NUM-AUAS IN SRT      TO WSS-NUM-AUAS IN WSS-VARI.
           MOVE HOY-DHOY     IN HOY-VARI TO WSS-NUM-DHOY IN WSS-VARI.
           MOVE HOY-MHOY     IN HOY-VARI TO WSS-NUM-MHOY IN WSS-VARI.
           MOVE HOY-SHOY     IN HOY-VARI TO WSS-NUM-SHOY IN WSS-VARI.
           MOVE HOY-AHOY     IN HOY-VARI TO WSS-NUM-AHOY IN WSS-VARI.
           MOVE WSS-FEC-FUAS IN WSS-VARI TO FEC-FEC1.
           MOVE WSS-FEC-FHOY IN WSS-VARI TO FEC-FEC2.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           MOVE FEC-DIF-DIA  TO FEC-CMND.
           PERFORM PRO-FEC.
       FIN-DIF-DIA.
           EXIT.
      **************************************************************************
      * Genera Lineas de Detalle a Partir de Registro SRT Ordenado
       GEN-LIN-OUT SECTION.
       INI-GEN-LIN-OUT.
      * Mediante BUS-TAB Busca Glosa de Codigo en Tabla USR
           IF WSS-COD-IUSR IN WSS-VARI > SPACES
               MOVE SPACES TO USR-GLS-DCOR IN USR
               MOVE 'CDC'                    TO TAB-COD-SIST
               MOVE 'USR'                    TO TAB-COD-TTAB IN TAB
               MOVE WSS-COD-IUSR IN WSS-VARI TO TAB-COD-CTAB IN TAB
               PERFORM BUS-TAB
               MOVE TAB-GLS-DCOR IN TAB TO WSS-GLS-IUSR IN WSS-RCU
           ELSE
               MOVE SPACES TO WSS-GLS-IUSR IN WSS-RCU.

      * Genera Linea Detalle Periodo Retencion a Partir de Totales Almacenados
           MOVE WSS-NUM-RETE IN WSS-VARI(1) TO WSS-NUM-RET1 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(2) TO WSS-NUM-RET2 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(3) TO WSS-NUM-RET3 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(4) TO WSS-NUM-RET4 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(5) TO WSS-NUM-RET5 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(6) TO WSS-NUM-RET6 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(7) TO WSS-NUM-RET7 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(8) TO WSS-NUM-RET8 IN WSS-RCU.
           MOVE WSS-NUM-RETE IN WSS-VARI(9) TO WSS-NUM-RETT IN WSS-RCU.
           DIVIDE WSS-NUM-RETT IN WSS-RCU BY WSS-NUM-TOTA IN WSS-VARI
                               GIVING WSS-NUM-PASO IN WSS-VARI ROUNDED.
           MULTIPLY WSS-NUM-PASO IN WSS-VARI BY 100
                               GIVING WSS-NUM-RETP IN WSS-RCU ROUNDED.
           GENERATE DL-RCU.
       FIN-GEN-LIN-OUT.
           EXIT.
      **************************************************************************

       COPY GNSBBMSG.
       COPY GNSBBTAB.
       COPY GNSBGFEC.
       COPY GNSBGHOY.
       COPY TABBBUSR.
       COPY TABBVUSR.
       COPY TABBFUSR.
      *>>>>
