       IDENTIFICATION DIVISION.
      *========================
       PROGRAM-ID. DAPPPTPT.
       AUTHOR. CIMA.
       DATE-WRITTEN.    7-OCT-2008 19:27:30 
      *
      * PROGRAMA TRADUCTOR PARA DAP
      *
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
      *----------------------
       SPECIAL-NAMES.
               DECIMAL-POINT IS COMMA.
       DATA DIVISION.
      
       WORKING-STORAGE SECTION.
      *------------------------
       77  WSS-TAG-DAPPPTPT           PIC X(0125) VALUE
           '<IDNPGM NOM=$DAPPPTPT$ VSN=$08.10.06$ GEN=$14-06-2005
      -    '17:16$ FNC=$080905$/>'.
      
       COPY GNSWGCVT.
       COPY GNSWGAMT.
       COPY GNSWCSXI.
      
        01  WSS-CMMA VALUE SPACES.
            03  WSS-ORIG.
                05  WSS-MODO                  PIC X(01).
                05  WSS-CNAL                  PIC X(03).
                05  WSS-IERR                  PIC X(01).
        01  WSS-TCMA                 VALUE +5 PIC S9(04).
       01 WSS-COD-CREQ-BCI             PIC X(15).
      
       COPY DAPWXORD.
       COPY DAPTXWS1.
       COPY DAPTXWS2.
       COPY DAPTXWS3.
       77  WSS-NUM-L9       VALUE ZEROES        PIC 9(09).
       77  WSS-ULT-REG      VALUE ZEROES        PIC 9(02).
       77  WSS-COD-CREQ-011 VALUE SPACES        PIC X(03).
       77  WSS-BKP-MENS VALUE SPACES            PIC X(79).
       01  WSS-CIC-IOPD.
           03  WSS-CAI-IOPD           PIC X(04).
           03  WSS-IIC-IOPD           PIC X(08).
      
       COPY GNSWGSEG.
       COPY GNSWGHOY.
       COPY GNSWGTSK.
       COPY GNSWVNUM.
       COPY GNSWCNUM.
       COPY GNSWGSYS.
      
       COPY GNSBRTXI.
      
       COPY GNSWRTDI.
      
       COPY GNSWGTDI.
      
       COPY GNSBRTXO.
      
       COPY GNSWRTDO.
      
       COPY GNSWGTDO.
      
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGQUE.
       COPY GNSWGFRM.
       COPY GNSWVSCR.
      *
       COPY GNSWGMX1.
      *
       01  WSS-TX-TMP-RED.
           03 WSS-TX-TMP-RED-HDR     PIC X(0100).
           03 WSS-TX-TMP-RED-DAT     PIC X(9400).
      
       01  WSS-VARI.
           03 WSS-TOT-OCC-OPD     VALUE 01 PIC 9(05).
           03 WSS-TOT-OCC-RCC     VALUE 02 PIC 9(05).
           03 WSS-TOT-OCC-CAD     VALUE 03 PIC 9(05).
      
           03 WSS-VAL-EDIT                PIC ZZ.ZZZ.ZZZ.ZZ9,9999.
      
           03 AUX-NUM-OCHO-ALF            PIC X(08).
           03 AUX-NUM-OCHO      REDEFINES
              AUX-NUM-OCHO-ALF            PIC  99999999.
      
           03 WSS-EDT-FEC1.
              05  WSS-FEC-ANO1             PIC X(04).
              05  WSS-FEC-MES1             PIC X(02).
              05  WSS-FEC-DIA1             PIC X(02).
      
           03 WSS-EDT-FEC2.
              05  WSS-FEC-DIA2             PIC X(02).
              05  WSS-FEC-MES2             PIC X(02).
              05  WSS-FEC-ANO2             PIC X(04).
      
       COPY GNSWGAMB.
      
       77  WSS-BKP-AHDR                                PIC X(100).
      
       77  WSS-IND-SEGM        VALUE ZEROES        PIC 9(02).
      
       LINKAGE SECTION.
      *----------------
       01  DFHCOMMAREA.
           02 FILLER                                  PIC X(06).
       COPY GNSLGFIO.
      
       PROCEDURE DIVISION.
      *===================
       MAIN SECTION.
       INI-MAIN.
      * RECIBO IDENTIFICACION DEL PC QUE ENVIO EL MSG.
           MOVE DFHCOMMAREA(1:EIBCALEN) TO SCR-NOM-TCPIP.
      
           MOVE 15 TO SEG-MAX-ELEM.
      
           MOVE +1025 TO SEG-LEN-TSSEG.
           MOVE +9000   TO TDI-LTDI.
           MOVE +9000   TO TDO-LTDO.
           PERFORM GET-TSK-TERM.
      
           MOVE 'GNSPPMTI'   TO SYS-PROG.
           MOVE 0            TO SYS-TCMA.
           MOVE SPACES       TO SYS-CMMA.
      
           MOVE SPACES           TO WSS-RCV.
           MOVE SPACES           TO WSS-SND.
           PERFORM GNS-ERR-QUE.
      
           MOVE SCR-NOM-TCPIP    TO WSS-PTR-COD-TYPE.
       LUP-SEG-LOG.
      *    PERFORM DEL-TSS.
           PERFORM PROCESO-LEE-TS.
      
           IF NOT '1' = WSS-SND-STAT
                PERFORM PRO-REQ.
           IF '1' = WSS-SND-STAT
                 MOVE SPACES TO WSS-SND-DAT
                 PERFORM SND-TS-MSSG
                 GO TO FIN-MAIN.
           IF VUELVE-LEER-TS
               GO TO LUP-SEG-LOG.
      
      
           PERFORM SND-TS-MSSG.
       FIN-MAIN.
           EXEC CICS RETURN END-EXEC.
       EXT-MAIN.
           EXIT.
      
       PRO-REQ SECTION.
       INI-PRO-REQ.
           MOVE WSS-RCV-HDR  TO WSS-HDR.
           MOVE WSS-HDR-CNAL TO WSS-CNAL.
           MOVE WSS-RCV-CREQ TO WSS-COD-CREQ.
      
           IF WSS-COD-CREQ = '085'
              PERFORM PRO-REQ-085
           ELSE
           IF WSS-COD-CREQ = '086'
              PERFORM PRO-REQ-086
           ELSE
      *         Error en Requerimiento.
              MOVE SPACES TO WSS-SND
              MOVE '1' TO WSS-SND-STAT
              MOVE 'ERROR EN CODIGO DE REQUERIMIENTO' TO WSS-SND-MENS.
       FIN-PRO-REQ.
           EXIT.
      
      
       PRO-REQ-085 SECTION.
       INI-PRO-REQ-085.
      * ORR,CON ( Antiguo CIR,CON )
           PERFORM EDT-NUM-PT-REQ-085.
      
           PERFORM MOV-GNS-085-01.
           PERFORM MOV-PT-TX-085-01.
           PERFORM PUT-TDI.
           PERFORM LNK-MTI.
           PERFORM GET-TDO.
           PERFORM MOV-XT-TP-085-01.

           PERFORM VAL-NUM-TP-REQ-085.
       FIN-PRO-REQ-085.
           EXIT.
      
       PRO-REQ-086 SECTION.
       INI-PRO-REQ-086.
      * ORD,CON ( Antiguo CRI,CON )
       FIN-PRO-REQ-086.
           EXIT.
      
       LNK-MTI SECTION.
       INI-LNK-MTI.
            MOVE 'GNSPPMTI'      TO SYS-PROG.
            MOVE WSS-TCMA        TO SYS-TCMA.
            MOVE WSS-CMMA        TO SYS-CMMA.
           MOVE SYS-LINK        TO SYS-CMND.
           PERFORM GNS-PRO-SYS.
           MOVE SPACES TO WSS-SND.
       FIN-LNK-MTI.
           EXIT.
      *
       PUT-TDI SECTION.
       INI-PUT-TDI.
           MOVE 1                      TO TDI-NUM-RECO.
           MOVE FIO-DEL                TO FIO-CMND.
           PERFORM GNS-FIO-TDI.
           MOVE 1                      TO TDI-NUM-RECO.
           MOVE FIO-PUT                TO FIO-CMND.
      
           MOVE WSS-SND TO TDI-GLS-DESC.
           PERFORM GNS-FIO-TDI.
       FIN-PUT-TDI.
           EXIT.
      
       PROCESO-LEE-TS SECTION.
       INI-PROCESO-LEE-TS.
           MOVE ZEROES   TO WSS-NITM-TSPT.
           MOVE +1025    TO WSS-LEN-TSPT.
           PERFORM GET-TSPT.
       FIN-PROCESO-LEE-TS.
           EXIT.
      
      * COLPPTPC-INI ====================
       GET-TSPT SECTION.
       INI-GET-TSPT.
           ADD 1 TO WSS-NITM-TSPT.
           MOVE SCR-NOM-TCPIP    TO WSS-PTR-COD-TYPE.
           MOVE WSS-PTR-GLS-COLA TO QUE-COLA.
           MOVE WSS-NITM-TSPT    TO QUE-NITM.
           MOVE WSS-LEN-TSPT     TO QUE-LITM.
           MOVE QUE-GET          TO QUE-CMND.
           PERFORM GNS-PRO-QUE.
           IF QUE-STAT = QUE-STAT-OKS
              MOVE QUE-ITEM TO WSS-ITEM-TSPT
              MOVE QUE-ITEM TO WSS-PASO
              IF NOT WSS-INDICA-TSPT > SPACES
                 PERFORM DEL-TSS
                 GO TO GET-OLD-TPG
              ELSE
                 PERFORM LEER-SEGMENTO
                 MOVE WSS-PAS-CREQ TO WSS-RCV-CREQ
                 IF WSS-OTRO = 'S'
                    GO TO INI-GET-TSPT
                 ELSE
                    GO TO FIN-GET-TSPT.
           GO TO FIN-GET-TSPT.
       GET-OLD-TPG.
           MOVE WSS-DATA-TSPT TO WSS-ELE-SEGR(WSS-NITM-TSPT).
               GO TO INI-GET-TSPT.
       FIN-GET-TSPT.
           EXIT.
      
       LEER-SEGMENTO SECTION.
       INI-LEER-SEGMENTO.
           MOVE SPACES TO WSS-RCV-CREQ.
           MOVE WSS-INDICA-TSPT TO WSS-SEGMENTACION-TS.
           IF LIMPIAR-TS
              PERFORM LIMPIA-TS
              PERFORM DEL-TSS.
           IF AGRUPACION-FISICA
              MOVE WSS-DATA-TSPT TO WSS-ELE-SEGR(WSS-NITM-TSPT).
           IF AGRUPACION-LOGICA
              IF WSS-INDICA-TSPT = 'J' OR WSS-INDICA-TSPT = 'K'
                 MOVE WSS-DATA-TSPT  TO WSS-ELE-SEGR(WSS-NITM-TSPT)
              ELSE
                 PERFORM SEG-LOG-REQ.
           IF LLAMAR-MONITOR
              MOVE WSS-PAS-CREQ TO WSS-RCV-CREQ
              IF WSS-INDICA-TSPT = 'K' OR WSS-INDICA-TSPT = 'E' OR
                 WSS-INDICA-TSPT = 'H'
                 MOVE 'S' TO WSS-OTRO
                 PERFORM PRO-REQ
      
      
                 IF '1' = WSS-SND-STAT
                    MOVE 'N' TO WSS-OTRO
              GO TO FIN-LEER-SEGMENTO.
           IF VUELVE-LEER-TS
              MOVE 'S' TO WSS-OTRO
              GO TO FIN-LEER-SEGMENTO.
           GO TO FIN-LEER-SEGMENTO.
       FIN-LEER-SEGMENTO.
           EXIT.
      
       LIMPIA-TS SECTION.
       INI-LIMPIA-TS.
           MOVE ZEROES TO WSS-IND-SEGM.
           MOVE SPACES TO WSS-SND.
           MOVE SPACES TO WSS-RCV.
       FIN-LIMPIA-TS.
           EXIT.
      
       SEG-LOG-REQ SECTION.
       INI-SEG-LOG.
           IF WSS-PAS-CREQ = '077' OR
              WSS-PAS-CREQ = '080'
              ADD 1 TO WSS-IND-SEGM
              MOVE SPACES TO WSS-ELE-SEGR(WSS-IND-SEGM)
              MOVE WSS-DATA-TSPT TO WSS-ELE-SEGR(WSS-IND-SEGM).
       FIN-SEG-LOG.
           EXIT.
      
      * COLPPTPC-FIN ====================
      
       GET-TDO SECTION.
       INI-GET-TDO.
           MOVE 1                       TO TDO-NUM-RECO.
           MOVE FIO-GET-KEY             TO FIO-CMND.
           PERFORM GNS-FIO-TDO.
           IF QUE-STAT = QUE-STAT-OKS
               MOVE TDO-COD-STAT   TO WSS-SND-STAT
               MOVE TDO-GLS-MENS   TO WSS-SND-MENS
               MOVE TDO-DESC-OCC   TO WSS-RCV.
       FIN-GET-TDO.
           EXIT.
      
       PRO-TO SECTION.
       INI-PRO-TO.
           MOVE 'TO' TO QUE-COLA.
           MOVE QUE-DEL TO QUE-CMND.
           PERFORM GNS-PRO-QUE.
      
           MOVE 'TO' TO QUE-COLA.
           MOVE +1025 TO QUE-LITM.
           MOVE WSS-SND TO QUE-ITEM.
           MOVE QUE-PUT TO QUE-CMND.
           PERFORM GNS-PRO-QUE.
       FIN-PRO-TO.
           EXIT.
      
       SND-TS-MSSG SECTION.
       INI-SND-TS-MSSG.
      * Borra TS si esta ya existe
           PERFORM BUS-ULT-ELEM.
      *    MOVE SEG-NOM-TSSEG  TO QUE-COLA.
      *    MOVE 'TO'           TO QUE-COLA.
           MOVE SCR-NOM-TCPIP  TO WSS-PTR-COD-TYPE.
           MOVE WSS-PTR-GLS-COLA  TO QUE-COLA.
           MOVE QUE-DEL        TO QUE-CMND.
           PERFORM GNS-PRO-QUE.
           MOVE ZEROES TO SEG-NUM-ITEM.
       LUP-SND-TS-MSSG.
           ADD 1 TO SEG-NUM-ITEM.
      *OLD     MOVE WSS-ELE-SEGS(SEG-NUM-ITEM) TO QUE-ITEM.
           MOVE WSS-ELE-SEGS(SEG-NUM-ITEM) TO WSS-DATA-TSPT.
           IF SEG-NUM-ITEM < WSS-ULT-REG
                MOVE '0' TO WSS-INDICA-TSPT
           ELSE
                MOVE '1' TO WSS-INDICA-TSPT.
      *    MOVE SEG-NOM-TSSEG              TO QUE-COLA.
      *    MOVE 'TO'                       TO QUE-COLA.
           MOVE WSS-ITEM-TSPT TO QUE-ITEM.
           MOVE SCR-NOM-TCPIP     TO WSS-PTR-COD-TYPE.
           MOVE WSS-PTR-GLS-COLA  TO QUE-COLA.
           MOVE SEG-LEN-TSSEG              TO QUE-LITM.
           MOVE QUE-PUT                    TO QUE-CMND.
           PERFORM GNS-PRO-QUE.
           IF WSS-ULT-REG > SEG-NUM-ITEM
              GO TO LUP-SND-TS-MSSG.
       FIN-SND-TS-MSSG.
           EXIT.
      *
       BUS-ULT-ELEM SECTION.
       INI-BUS-ULT-ELEM.
      * Borra TS si esta ya existe
           MOVE SEG-MAX-ELEM TO SEG-NUM-ITEM.
           MOVE 1 TO WSS-ULT-REG.
       LUP-BUS-ULT-ELEM.
           IF SEG-NUM-ITEM NOT > ZEROES
              GO TO FIN-BUS-ULT-ELEM.
           IF WSS-ELE-SEGS(SEG-NUM-ITEM) > SPACES
              MOVE SEG-NUM-ITEM TO WSS-ULT-REG
           ELSE
              SUBTRACT 1 FROM SEG-NUM-ITEM
              GO TO LUP-BUS-ULT-ELEM.
       FIN-BUS-ULT-ELEM.
           EXIT.
      
       COPY GNSBGHOY.
       COPY GNSBHSYS.
       COPY GNSBGSYS.
       COPY GNSBIABT.
      
       COPY GNSBFTXI.
      
       COPY GNSBFTXO.
      
       COPY GNSBGTSK.
      
       COPY DAPTXPD1.
       COPY DAPTXPD2.
       COPY DAPTXPD3.
       COPY DAPTXPD4.
       COPY GNSBGEND.
      
      *Modulo Generico Manejo de DAPas
       GNS-CHK-QUEU SECTION.
       INI-GNS-CHK-QUEU.
           MOVE 1 TO QUE-NITM.
           MOVE QUE-GET TO QUE-CMND.
           PERFORM GNS-PRO-QUE.
       FIN-GNS-CHK-QUEU.
           EXIT.
      
       GNS-QUE-EOQ SECTION.
       INI-GNS-QUE-EOQ.
           MOVE QUE-STAT-EOQ TO QUE-STAT.
           GO TO FIN-GNS-PRO-QUE.
       FIN-GNS-QUE-EOQ.
           EXIT.
      
       GNS-QUE-NEX SECTION.
       INI-GNS-QUE-NEX.
           MOVE QUE-STAT-NEX TO QUE-STAT.
           GO TO FIN-GNS-PRO-QUE.
       FIN-GNS-QUE-NEX.
           EXIT.
      
      **************************************************************
       GNS-ERR-QUE SECTION.
       INI-GNS-ERR-QUE.
           EXEC CICS HANDLE CONDITION
                     QIDERR (GNS-QUE-NEX)
                     ITEMERR(GNS-QUE-EOQ)
                     LENGERR(GNS-QUE-NEX)
           END-EXEC.
       FIN-GNS-ERR-QUE.
           EXIT.
      
       GNS-PRO-QUE SECTION.
       INI-GNS-PRO-QUE.
           MOVE QUE-STAT-OKS TO QUE-STAT.
           IF QUE-CMND = QUE-PUT
               GO TO GNS-PUT-QUE
           ELSE
           IF QUE-CMND = QUE-GET
               GO TO GNS-GET-QUE
           ELSE
           IF QUE-CMND = QUE-MOD
               GO TO GNS-MOD-QUE
           ELSE
           IF QUE-CMND = QUE-DEL
               GO TO GNS-DEL-QUE.
           MOVE 'Comando invalido :' TO QUE-MEN1.
           MOVE QUE-CMND             TO QUE-MEN2.
           EXEC CICS XCTL
                     PROGRAM('GNSPPABT')
                     COMMAREA(QUE-MENS)
                     LENGTH(+79)
           END-EXEC.
      
       GNS-PUT-QUE.
           IF WSS-IND-QUE = '   '
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(QUE-ITEM)
                     LENGTH(QUE-LITM)
                     AUXILIARY
              END-EXEC
           ELSE
           IF WSS-IND-QUE = 'TDI'
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(TDI-GLS-DESC-1)
                     LENGTH(QUE-LITM)
                     AUXILIARY
               END-EXEC
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(TDI-GLS-DESC-2)
                     LENGTH(QUE-LITM)
                     AUXILIARY
              END-EXEC
           ELSE
           IF WSS-IND-QUE = 'TDO'
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(TDO-GLS-DESC-1)
                     LENGTH(QUE-LITM)
                     AUXILIARY
               END-EXEC
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(TDO-GLS-DESC-2)
                     LENGTH(QUE-LITM)
                     AUXILIARY
              END-EXEC.
       FIN-GNS-PUT-QUE.
           GO TO FIN-GNS-PRO-QUE.
      
       GNS-GET-QUE.
           IF WSS-IND-QUE = '   '
               EXEC CICS READQ TS
                     QUEUE(QUE-COLA)
                     INTO(QUE-ITEM)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
              END-EXEC
           ELSE
           IF WSS-IND-QUE = 'TDI'
               EXEC CICS READQ TS
                     QUEUE(QUE-COLA)
                     INTO(TDI-GLS-DESC-1)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
               END-EXEC
               ADD 1  TO  QUE-NITM
               EXEC CICS READQ TS
                     QUEUE(QUE-COLA)
                     INTO(TDI-GLS-DESC-2)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
              END-EXEC
           ELSE
           IF WSS-IND-QUE = 'TDO'
               EXEC CICS READQ TS
                     QUEUE(QUE-COLA)
                     INTO(TDO-GLS-DESC-1)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
               END-EXEC
               ADD 1   TO  QUE-NITM
               EXEC CICS READQ TS
                     QUEUE(QUE-COLA)
                     INTO(TDO-GLS-DESC-2)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
              END-EXEC.
       FIN-GNS-GET-QUE.
           GO TO FIN-GNS-PRO-QUE.
      
       GNS-MOD-QUE.
           IF WSS-IND-QUE = SPACES
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(QUE-ITEM)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
                     REWRITE
               END-EXEC
           ELSE
           IF WSS-IND-QUE = 'TDI'
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(TDI-GLS-DESC)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
                     REWRITE
               END-EXEC
           ELSE
           IF WSS-IND-QUE = 'TDO'
               EXEC CICS WRITEQ TS
                     QUEUE(QUE-COLA)
                     FROM(TDO-GLS-DESC)
                     LENGTH(QUE-LITM)
                     ITEM(QUE-NITM)
                     REWRITE
               END-EXEC.
       FIN-GNS-MOD-QUE.
           GO TO FIN-GNS-PRO-QUE.
      
       GNS-DEL-QUE.
           EXEC CICS DELETEQ TS
                     QUEUE(QUE-COLA)
           END-EXEC.
       FIN-GNS-DEL-QUE.
           GO TO FIN-GNS-PRO-QUE.
       FIN-GNS-PRO-QUE.
           EXIT.
      
       DEL-TSS SECTION.
       INI-DEL-TSS.
            MOVE 'PL01' TO QUE-TERM.
            MOVE TSK-TERM-ALF TO QUE-TYPE.
            MOVE QUE-DEL TO QUE-CMND.
            PERFORM GNS-PRO-QUE.
      
            MOVE 'PL02' TO QUE-TERM.
            MOVE TSK-TERM-ALF TO QUE-TYPE.
            MOVE QUE-DEL TO QUE-CMND.
            PERFORM GNS-PRO-QUE.
      
            MOVE 'TSI ' TO QUE-TYPE.
            MOVE TSK-TERM-ALF TO QUE-TERM.
            MOVE QUE-DEL TO QUE-CMND.
            PERFORM GNS-PRO-QUE.
      
            MOVE 'TSO ' TO QUE-TYPE.
            MOVE TSK-TERM-ALF TO QUE-TERM.
            MOVE QUE-DEL TO QUE-CMND.
            PERFORM GNS-PRO-QUE.
      
            MOVE 'SIS '       TO QUE-TYPE.
            MOVE TSK-TERM-ALF TO QUE-TERM.
            MOVE QUE-DEL      TO QUE-CMND.
            PERFORM GNS-PRO-QUE.
       FIN-DEL-TSS.
           EXIT.
      
       GNX-PRO-QUE SECTION.
       INI-GNX-PRO-QUE.
      *    PERFORM GNS-PRO-QUE.
       FIN-GNX-PRO-QUE.
           EXIT.
