       IDENTIFICATION DIVISION.
      *=======================
       PROGRAM-ID.      DAPPLDPE.
       AUTHOR.          CONSIST.
       DATE-WRITTEN.    16-Mar-92 08:12 PM.

      * Programa Listador de Reporte DPE con Sort.

       ENVIRONMENT DIVISION.
      *====================
       CONFIGURATION SECTION.
      *---------------------
       SPECIAL-NAMES.
            DECIMAL-POINT IS COMMA.
       INPUT-OUTPUT SECTION.
      *--------------------
       FILE-CONTROL.
      *DOS SELECT GNSSRT         ASSIGN TO SYS001-DA-3330-S-SORTWK1.
      *MVS SELECT GNSSRT         ASSIGN TO        DA-S-SORTWK1.
      *DOS SELECT RPTDPE         ASSIGN TO SYS011-UR-1403-S.
      *MVS SELECT RPTDPE         ASSIGN TO        UT-S-RPTDPE.
           SELECT GNSSRT         ASSIGN TO        DA-S-SORTWK1.
           SELECT RPTDPE         ASSIGN TO        UT-S-RPTDPE.

       DATA DIVISION.
      *=============
       FILE SECTION.
      *------------
       SD  GNSSRT.
       COPY DAPRRDPE.
       FD  RPTDPE LABEL RECORDS OMITTED
           REPORT IS RPT-DPE
           .

       WORKING-STORAGE SECTION.
      *-----------------------
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-OPD-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-TAB-REQA==.
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSG-REQA==.
       COPY DAPBROPD.
       COPY GNSWGRQA.
       COPY GNSWGUIB.
       COPY GNSWGELS.
       COPY GNSWVIDD.
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGRPT.
       COPY GNSBRTAB.
       COPY GNSBRMSG.
       COPY DAPRWDPE.
       COPY GNSWGSYS.
       01  PGM-STAT.
           03 PGM-STAT-SRT            VALUE ' ' PIC X(01).
              88 PGM-STAT-SRT-OKS     VALUE ' '.
              88 PGM-STAT-SRT-MAL     VALUE 'M'.
           03 PGM-SOKS                VALUE ' ' PIC X(01).
           03 PGM-SMAL                VALUE 'M' PIC X(01).
      *<<<< WSS
      *Entidades de GNS
       COPY GNSWGFEC.
       COPY GNSWGHOY.
       COPY GNSWGCPT.
       COPY GNSBRMSC.
      *Entidades de TAB
       COPY TABBROFI.
       COPY TABBRVLR.
      *Entidades de DAP
       COPY DAPBRRCC.
      *Entidades de SGC
       COPY SGCBRDBC.

       01  WSS-VARI.
           03  WSS-FEC-FINI.
               05  WSS-NUM-DINI                      PIC 9(02).
               05  WSS-NUM-MINI                      PIC 9(02).
               05  WSS-NUM-SINI                      PIC 9(02).
               05  WSS-NUM-AINI                      PIC 9(02).
           03  WSS-FEC-FFIN.
               05  WSS-NUM-DFIN                      PIC 9(02).
               05  WSS-NUM-MFIN                      PIC 9(02).
               05  WSS-NUM-SFIN                      PIC 9(02).
               05  WSS-NUM-AFIN                      PIC 9(02).
           03  WSS-FEC-FPRI.
               05  WSS-NUM-SPRI                      PIC 9(02).
               05  WSS-NUM-APRI                      PIC 9(02).
               05  WSS-NUM-MPRI                      PIC 9(02).
               05  WSS-NUM-DPRI                      PIC 9(02).
           03  WSS-FEC-FTER.
               05  WSS-NUM-STER                      PIC 9(02).
               05  WSS-NUM-ATER                      PIC 9(02).
               05  WSS-NUM-MTER                      PIC 9(02).
               05  WSS-NUM-DTER                      PIC 9(02).
           03  WSS-FEC-FENT.
               05  WSS-NUM-DENT                      PIC 9(02).
               05  WSS-NUM-MENT                      PIC 9(02).
               05  WSS-NUM-SENT                      PIC 9(02).
               05  WSS-NUM-AENT                      PIC 9(02).
           03  WSS-FEC-FETR.
               05  WSS-NUM-SETR                      PIC 9(02).
               05  WSS-NUM-AETR                      PIC 9(02).
               05  WSS-NUM-METR                      PIC 9(02).
               05  WSS-NUM-DETR                      PIC 9(02).
           03  WSS-FEC-FREA.
               05  WSS-NUM-DREA                      PIC 9(02).
               05  WSS-NUM-MREA                      PIC 9(02).
               05  WSS-NUM-SREA                      PIC 9(02).
               05  WSS-NUM-AREA                      PIC 9(02).
           03  WSS-COD-OFIC                          PIC X(03).
           03  WSS-TOT-OFIC        VALUE ZEROES      PIC 9(05).
           03  WSS-TOT-FENT        VALUE ZEROES      PIC 9(05).
      *>>>>
      *<<<< WSS_DTC
      *Entidades de TAB
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-OFI-REQA==.
      *Entidades de DAP
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-RCC-REQA==.
      *Entidades de SGC
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-DBC-REQA==.
      *Entidades de GNS
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSC-REQA==.
      *>>>>

       REPORT SECTION.
      *--------------
       COPY DAPRFDPE.
           .
       COPY DAPRTDPE.

       PROCEDURE DIVISION.
      *==================
       DECLARATIVES.
       DEC-CF-DPE-OPD-COD-OFIC SECTION.
           USE BEFORE REPORTING CF-DPE-OPD-COD-OFIC.
       INI-CF-DPE-OPD-COD-OFIC.
      *<<<< CF_DPE_OPD_COD_OFIC
           MOVE WSS-TOT-OFIC IN WSS-VARI TO
                          WSS-TOT-OFIC IN WSS-DPE.
           MOVE ZEROES TO WSS-TOT-OFIC IN WSS-VARI.
      *>>>>
       FIN-CF-DPE-OPD-COD-OFIC.
           EXIT.
       DEC-CF-DPE-SRT-FEC-FENT SECTION.
           USE BEFORE REPORTING CF-DPE-SRT-FEC-FENT.
       INI-CF-DPE-SRT-FEC-FENT.
      *<<<< CF_DPE_SRT_FEC_FENT
           MOVE WSS-TOT-FENT IN WSS-VARI TO
                          WSS-TOT-FENT IN WSS-DPE.
           MOVE ZEROES TO WSS-TOT-FENT IN WSS-VARI.
      *>>>>
       FIN-CF-DPE-SRT-FEC-FENT.
           EXIT.
       DEC-PH-DPE SECTION.
           USE BEFORE REPORTING PH-DPE.
       INI-PH-DPE.
      *<<<< IF PH_DPE
           MOVE OPD-COD-OFIC IN SRT TO OFI-COD-OFIC IN OFI.
           PERFORM BUS-OFI.
      *>>>>
       FIN-PH-DPE.
           EXIT.
       END DECLARATIVES.

       MAIN SECTION.
      *------------
       INI-MAIN.
       COPY GNSBGEDB.
           MOVE 'DAPPLDPE' TO FIO-PROG.
           PERFORM GNS-BUS-IDD.
           SORT GNSSRT
       COPY DAPRSDPE.
           INPUT  PROCEDURE IS INP-SRT
           OUTPUT PROCEDURE IS OUT-SRT.
       FIN-MAIN.
           PERFORM GNS-PRO-END.

       INP-SRT SECTION.
      *---------------
       INI-INP-SRT.
      *<<<< INI_INP
           DISPLAY 'INICIO CAPTURA PARAMETROS'.
      * Captura codigo de oficina
           DISPLAY 'INGRESE COD. DE OFICINA (*/XXX) : '.
           ACCEPT  WSS-COD-OFIC IN WSS-VARI.
           DISPLAY WSS-COD-OFIC IN WSS-VARI.

           DISPLAY 'INGRESE FECHA DE TERMINO (DDMMSSAA) : '.
           ACCEPT WSS-FEC-FFIN IN WSS-VARI.
           DISPLAY WSS-FEC-FFIN IN WSS-VARI.

           DISPLAY 'FIN CAPTURA PARAMETROS'.
      *VAL-OFI Valida Codigo de oficina
           IF WSS-COD-OFIC IN WSS-VARI > SPACES AND
              WSS-COD-OFIC IN WSS-VARI NOT = '*'
              DISPLAY WSS-COD-OFIC IN WSS-VARI
              MOVE WSS-COD-OFIC IN WSS-VARI TO OFI-COD-OFIC IN OFI
              PERFORM VAL-OFI
              IF MSG-GLS-MENS = 'COD    NEX'
                 DISPLAY MSG-GLS-MENS
                 MOVE PGM-SMAL TO PGM-STAT-SRT
                 GO TO FIN-INP-SRT.

      *VAL-FEC Valida Fecha de Termino
           DISPLAY WSS-FEC-FFIN IN WSS-VARI.
           MOVE WSS-FEC-FFIN IN WSS-VARI TO FEC-FECH.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           MOVE FEC-FBLK-N TO FEC-FBLK.
           MOVE FEC-CHOY-N TO FEC-CHOY.
           MOVE FEC-VHBL-N TO FEC-VHBL.
           MOVE FEC-VAL-FEC TO FEC-CMND.
           PERFORM PRO-FEC.
           IF NOT FEC-STAT-OKS
               DISPLAY FEC-MENS
               MOVE PGM-SMAL TO PGM-STAT-SRT
               GO TO FIN-INP-SRT.

      *GEN-FEC-INI Genera Fecha de Inicio
           MOVE FEC-RST-DIA              TO FEC-CMND.
           MOVE FEC-FORM-FEC             TO FEC-FORM.
           MOVE 100                      TO FEC-NDIA.
           MOVE WSS-FEC-FFIN IN WSS-VARI TO FEC-FECH.
           PERFORM CAL-FEC.
           MOVE FEC-ITM1 TO WSS-NUM-DINI IN WSS-VARI.
           MOVE FEC-ITM2 TO WSS-NUM-MINI IN WSS-VARI.
           MOVE FEC-ITM3 TO WSS-NUM-SINI IN WSS-VARI.
           MOVE FEC-ITM4 TO WSS-NUM-AINI IN WSS-VARI.

      *VAL-FEC Valida Fecha de Inicio
           DISPLAY 'FECHA INICIO : ' WSS-FEC-FINI IN WSS-VARI.
           MOVE WSS-FEC-FINI IN WSS-VARI TO FEC-FECH.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           MOVE FEC-FBLK-N TO FEC-FBLK.
           MOVE FEC-CHOY-N TO FEC-CHOY.
           MOVE FEC-VHBL-N TO FEC-VHBL.
           MOVE FEC-VAL-FEC TO FEC-CMND.
           PERFORM PRO-FEC.
           IF NOT FEC-STAT-OKS
               DISPLAY FEC-MENS
               MOVE PGM-SMAL TO PGM-STAT-SRT
               GO TO FIN-INP-SRT.
 
           MOVE WSS-NUM-DFIN IN WSS-VARI TO WSS-NUM-DFIN IN WSS-DPE.
           MOVE WSS-NUM-MFIN IN WSS-VARI TO WSS-NUM-MFIN IN WSS-DPE.
           MOVE WSS-NUM-SFIN IN WSS-VARI TO WSS-NUM-SFIN IN WSS-DPE.
           MOVE WSS-NUM-AFIN IN WSS-VARI TO WSS-NUM-AFIN IN WSS-DPE.
           DISPLAY 'FIN VALIDACION PARAMETROS'.
      *>>>>
           MOVE FIO-INP TO FIO-CMND.
           PERFORM DAP-FIO-OPD.
       FST-INP-SRT.
      *<<<< INI_FST_INP
      *Abre archivos VSAM secundarios
           MOVE FIO-INP TO FIO-CMND.
           PERFORM DAP-FIO-RCC.

           MOVE FIO-INP TO FIO-CMND.
           PERFORM SGC-FIO-DBC.

      *Proceso normal de ingreso al SORT
           MOVE WSS-NUM-DINI IN WSS-VARI TO OPD-NUM-DREA IN OPD.
           MOVE WSS-NUM-MINI IN WSS-VARI TO OPD-NUM-MREA IN OPD.
           MOVE WSS-NUM-SINI IN WSS-VARI TO OPD-NUM-SREA IN OPD.
           MOVE WSS-NUM-AINI IN WSS-VARI TO OPD-NUM-AREA IN OPD.
           MOVE WSS-NUM-DINI IN WSS-VARI TO WSS-NUM-DPRI IN WSS-VARI.
           MOVE WSS-NUM-MINI IN WSS-VARI TO WSS-NUM-MPRI IN WSS-VARI.
           MOVE WSS-NUM-SINI IN WSS-VARI TO WSS-NUM-SPRI IN WSS-VARI.
           MOVE WSS-NUM-AINI IN WSS-VARI TO WSS-NUM-APRI IN WSS-VARI.
           MOVE WSS-NUM-DFIN IN WSS-VARI TO WSS-NUM-DTER IN WSS-VARI.
           MOVE WSS-NUM-MFIN IN WSS-VARI TO WSS-NUM-MTER IN WSS-VARI.
           MOVE WSS-NUM-SFIN IN WSS-VARI TO WSS-NUM-STER IN WSS-VARI.
           MOVE WSS-NUM-AFIN IN WSS-VARI TO WSS-NUM-ATER IN WSS-VARI.

      *JVM: Accesa archivo OPD por llave alternativa
           MOVE 'OPD-FEC-FREA' TO FIO-AKEY.
           MOVE FIO-GET-NLS TO FIO-CMND.
           PERFORM DAP-FIO-OPD.
           IF NOT FIO-STAT-OKS
              MOVE PGM-SMAL TO PGM-STAT-SRT
              GO TO FIN-INP-SRT.
           IF OPD-FEC-FREA IN OPD > WSS-FEC-FTER IN WSS-VARI
              MOVE PGM-SMAL TO PGM-STAT-SRT
              GO TO FIN-INP-SRT
           ELSE
              GO TO LUP-INP-SRT.
      *>>>>
           MOVE FIO-GET-FST TO FIO-CMND.
           PERFORM DAP-FIO-OPD.
       LUP-INP-SRT.
           IF NOT FIO-STAT-OKS
              GO TO FIN-INP-SRT.
      *<<<< LUP_INP
      *JVM: Para busqueda sequencial
      *     IF OPD-FEC-FREA IN OPD < WSS-FEC-FPRI IN WSS-VARI OR
      *        OPD-FEC-FREA IN OPD > WSS-FEC-FTER IN WSS-VARI
      *        GO TO NXT-INP-SRT.

      *Controla ingreso de regs. vigentes o no vigentes validos
           IF WSS-COD-OFIC IN WSS-VARI > SPACES AND
              WSS-COD-OFIC IN WSS-VARI NOT = '*'
              IF WSS-COD-OFIC IN WSS-VARI NOT = OPD-COD-OFIC IN OPD
                 GO TO NXT-INP-SRT.

           IF OPD-NUM-RETD IN OPD NOT > ZEROES
                 GO TO NXT-INP-SRT.

      *Genera Fecha de entrega
           MOVE 'TAB'               TO MSC-COD-SIST.
           MOVE 'IPER'              TO MSC-COD-TMSC IN MSC.
           MOVE OPD-IND-RETD IN OPD TO MSC-COD-CMSC IN MSC.
           PERFORM BUS-MSC.
           MOVE OPD-NUM-DREA IN OPD TO WSS-NUM-DREA IN WSS-VARI.
           MOVE OPD-NUM-MREA IN OPD TO WSS-NUM-MREA IN WSS-VARI.
           MOVE OPD-NUM-SREA IN OPD TO WSS-NUM-SREA IN WSS-VARI.
           MOVE OPD-NUM-AREA IN OPD TO WSS-NUM-AREA IN WSS-VARI.
           MOVE WSS-FEC-FREA IN WSS-VARI TO FEC-FECH.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           PERFORM SEL-PER-FENT.
           PERFORM CAL-FEC.
           MOVE FEC-FECH TO WSS-FEC-FENT IN WSS-VARI.
           MOVE WSS-NUM-DENT IN WSS-VARI TO SRT-NUM-DENT IN SRT
                                       WSS-NUM-DETR IN WSS-VARI.
           MOVE WSS-NUM-MENT IN WSS-VARI TO SRT-NUM-MENT IN SRT
                                       WSS-NUM-METR IN WSS-VARI.
           MOVE WSS-NUM-SENT IN WSS-VARI TO SRT-NUM-SENT IN SRT
                                       WSS-NUM-SETR IN WSS-VARI.
           MOVE WSS-NUM-AENT IN WSS-VARI TO SRT-NUM-AENT IN SRT
                                       WSS-NUM-AETR IN WSS-VARI.

           IF WSS-FEC-FETR IN WSS-VARI < WSS-FEC-FTER IN WSS-VARI 
              GO TO NXT-INP-SRT.

           MOVE WSS-FEC-FETR IN WSS-VARI TO SRT-FEC-FENT IN SRT.

           MOVE 1 TO SRT-NUM-NOPD IN SRT.

           MOVE SPACES TO FIO-AKEY.
      *Genera glosas, tasa de interes  						
           MOVE OPD-CAI-IOPD IN OPD TO RCC-CAI-IOPD IN RCC.
           MOVE OPD-IIC-IOPD IN OPD TO RCC-IIC-IOPD IN RCC.
           MOVE 'RCC-KEY-IOPD' TO FIO-AKEY.
           MOVE FIO-GET-KEY    TO FIO-CMND.
           PERFORM DAP-FIO-RCC.
           IF FIO-STAT-OKS
              PERFORM GET-RCC-DBC
           ELSE
              PERFORM RST-DBC.
           
           MOVE 'OPD-FEC-FREA' TO FIO-AKEY.
      *>>>>
       MOV-INP-SRT.
       COPY DAPRMDPE.
           RELEASE SRT.
       NXT-INP-SRT.
      *<<<< INI_NXT_INP
      *Ubica registro en OPD por fecha
           MOVE 'OPD-FEC-FREA' TO FIO-AKEY.
      *>>>>
           MOVE FIO-GET-NXT TO FIO-CMND.
           PERFORM DAP-FIO-OPD.
      *<<<< FIN_NXT_INP
      *Controla ingreso de registros por fecha termino
           IF OPD-FEC-FREA IN OPD > WSS-FEC-FTER IN WSS-VARI
              GO TO FIN-INP-SRT.
      *>>>>
           GO TO LUP-INP-SRT.
       FIN-INP-SRT.
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM DAP-FIO-OPD.

       OUT-SRT SECTION.
      *---------------
       INI-OUT-SRT.
           IF PGM-STAT-SRT-MAL
               GO TO EXT-OUT-SRT.
           OPEN OUTPUT RPTDPE.
           CALL 'GNSPLHDR' USING RPT-VARI.
           INITIATE RPT-DPE.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
       LUP-OUT-SRT.
      *<<<< LUP_OUT
      *Limpia fio-akey para consulta de RCC
           MOVE SPACES TO FIO-AKEY.
      *Genera Glosa Valor de Cambio (moneda)
           MOVE 'TAB' TO TAB-COD-SIST.
           MOVE 'VLR' TO TAB-COD-TTAB IN TAB.
           MOVE OPD-COD-VCAM IN SRT TO TAB-COD-CTAB IN TAB.
           PERFORM BUS-TAB.
           MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-VCAM IN WSS-DPE.
      *Genera Glosa Codigo de Operaciones
      *     MOVE 'TAB' TO TAB-COD-SIST.
      *     MOVE 'AUX' TO TAB-COD-TTAB IN TAB.
      *     MOVE OPD-COD-COPD IN SRT TO TAB-COD-CTAB IN TAB.
      *     PERFORM BUS-TAB.
      *     MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-COPD IN WSS-DPE.
           MOVE OPD-COD-COPD IN SRT TO WSS-GLS-COPD IN WSS-DPE.
      *>>>>
       GEN-OUT-SRT.
           GENERATE DL-DPE.
      *<<<< FIN_GEN_OUT
           ADD SRT-NUM-NOPD IN SRT TO WSS-TOT-OFIC IN WSS-VARI.
           ADD SRT-NUM-NOPD IN SRT TO WSS-TOT-FENT IN WSS-VARI.
      *>>>>
       NXT-OUT-SRT.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
           GO TO LUP-OUT-SRT.
       FIN-OUT-SRT.
           TERMINATE RPT-DPE.
           CLOSE RPTDPE.
       EXT-OUT-SRT.
           EXIT.

       COPY DAPBFOPD.
       COPY GNSBGDTC.
       COPY GNSBGIDD.
       COPY GNSBTABT.
       COPY GNSBBSYS.
       COPY GNSBFTAB.
       COPY GNSBFMSG.
       COPY GNSBGEND.

      *<<<< EOF
      * Lee con CIC CLIENTE archivo DBC
       GET-RCC-DBC SECTION.
       INI-GET-RCC-DBC.
           MOVE RCC-CIC-ICLI IN RCC TO DBC-CIC-ICLI IN DBC.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM SGC-FIO-DBC.
           IF NOT FIO-STAT-OKS
              PERFORM RST-DBC
           ELSE
              MOVE DBC-GLS-NOMC IN DBC TO CPT-STRN
              PERFORM CPT-BLKS
              MOVE CPT-STRN TO DBC-GLS-NOMC IN DBC. 
       FIN-GET-RCC-DBC.
           EXIT.

      * Limpia datos cliente
       RST-DBC SECTION.
       INI-RST-DBC.
           MOVE 'CLIENTE INEXISTENTE' TO DBC-GLS-NOMC IN DBC.
           MOVE SPACES TO DBC-NUM-ICLI IN DBC.
           MOVE SPACES TO DBC-VRF-ICLI IN DBC.
       FIN-RST-DBC.
           EXIT.

       SEL-PER-FENT SECTION.
       INI-SEL-PER-FENT.
           IF MSC-CIC-CMSC = 'D'
              MOVE FEC-SUM-DIA              TO FEC-CMND
              MOVE OPD-NUM-RETD IN OPD      TO FEC-NDIA
           ELSE
           IF MSC-CIC-CMSC = 'M'
              MOVE FEC-SUM-MES              TO FEC-CMND
              MOVE OPD-NUM-RETD IN OPD      TO FEC-NMES
           ELSE
           IF MSC-CIC-CMSC = 'A'
              MOVE FEC-SUM-ANO             TO FEC-CMND
              MOVE OPD-NUM-RETD IN OPD     TO FEC-NANO.
       FIN-SEL-PER-FENT.
           EXIT.
      *Entidades  de GNS
       COPY GNSBGFEC.
       COPY GNSBPFEC.
       COPY GNSBGHOY.
       COPY GNSBBMSG.
       COPY GNSBBTAB.
       COPY GNSBGCPT.
       COPY GNSBBMSC.
       COPY GNSBFMSC.

      *Entidades  de SGC
       COPY SGCBFDBC.

      *Entidades  de DAP
       COPY DAPBFRCC.

      *Entidades  de TAB
       COPY TABBFOFI.
       COPY TABBBOFI.
       COPY TABBVOFI.
      *>>>>
