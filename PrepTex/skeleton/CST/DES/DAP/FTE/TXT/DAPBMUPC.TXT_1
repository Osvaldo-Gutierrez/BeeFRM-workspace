*%! Codigo adicional para modulos de manejo UPC
*% IF SETTAG
*% FNCBQ = "130810"
*% VSNBQ = "13.08.10"
*% FNCBU = "130810"
*% VSNBU = "13.08.10"
*% END
*% IF FIN_PUT_OPD_UPC
      *<<<< FIN_PUT_OPD_UPC
      *>>>> FIN_PUT_OPD_UPC
*% END
*% IF FIN_KEY_UPC_UPC
      *<<<< FIN_KEY_UPC_UPC
      *>>>> FIN_KEY_UPC_UPC
*% END
*% IF INI_VAL_CON_KEY_UPC
      *<<<< INI_VAL_CON_KEY_UPC

      * PERIODO, AMBOS LLENOS O AMBOS VACIOS
           IF OPD-NUM-PVEN IN UPC-FLD > ZEROES AND
              OPD-IND-PVEN IN UPC-FLD NOT > SPACES
                   MOVE 'DAP' TO MSG-COD-SIST
                   MOVE 'UPCPVENINCON' TO MSG-COD-MENS
                   PERFORM GET-MSG
                   MOVE MSG-GLS-DESC TO FRM-MENS
                   MOVE FRM-SUAR-MAL TO FRM-SUAR
                   MOVE FRM-POS-CURS TO OPD-NUM-PVEN-LEN IN UPC-FLD
                   GO TO FIN-VAL-CON-KEY-UPC
           ELSE
           IF OPD-NUM-PVEN IN UPC-FLD NOT > ZEROES AND
              OPD-IND-PVEN IN UPC-FLD > SPACES
                   MOVE 'DAP' TO MSG-COD-SIST
                   MOVE 'UPCPVENINCON' TO MSG-COD-MENS
                   PERFORM GET-MSG
                   MOVE MSG-GLS-DESC TO FRM-MENS
                   MOVE FRM-SUAR-MAL TO FRM-SUAR
                   MOVE FRM-POS-CURS TO OPD-IND-PVEN-LEN IN UPC-FLD
                   GO TO FIN-VAL-CON-KEY-UPC.

      * DEBE INFORMAR AL MENOS PERIODO O FECHA DE TERMINO
           IF OPD-NUM-PVEN IN UPC-FLD NOT > ZEROES AND
              OPD-FEC-FREA IN UPC-FLD NOT > ZEROES
                   MOVE 'UPCPVENFTERX' TO MSG-COD-MENS
                   PERFORM GET-MSG
                   MOVE MSG-GLS-DESC TO FRM-MENS
                   MOVE FRM-SUAR-MAL TO FRM-SUAR
                   MOVE FRM-POS-CURS TO OPD-IND-PVEN-LEN IN UPC-FLD
                   GO TO FIN-VAL-CON-KEY-UPC.

      * FTER OBLIGATORIA PARA MODALIDAD ANTIGUA
           IF FRM-COD-MODA IN UPC-FLD = 'S'
               IF OPD-FEC-FTER IN UPC-FLD NOT > ZEROES
                   MOVE 'DAP' TO MSG-COD-SIST
                   MOVE 'UPCFTEROBLMA' TO MSG-COD-MENS
                   PERFORM GET-MSG
                   MOVE MSG-GLS-DESC TO FRM-MENS
                   MOVE FRM-SUAR-MAL TO FRM-SUAR
                   MOVE FRM-POS-CURS TO OPD-FEC-FTER-LEN IN UPC-FLD
                   GO TO FIN-VAL-CON-KEY-UPC.

      * SI FTER > 0 Y PVEN = 0, CALCULA PVEN COMO DIF DIAS
           IF OPD-NUM-PVEN IN UPC-FLD NOT > ZEROES AND
              OPD-FEC-FREA IN UPC-FLD > ZEROES
                MOVE OPD-FEC-FREA IN UPC-FLD TO FEC-FEC1
                MOVE OPD-FEC-FTER IN UPC-FLD TO FEC-FEC2
                MOVE FEC-FORM-FEC TO FEC-FORM
                MOVE FEC-DIF-DIA TO FEC-CMND
                PERFORM CAL-FEC
                IF FEC-STAT-OKS
                   MOVE FEC-NDIA TO OPD-NUM-PVEN IN UPC-FLD
                   MOVE 'D'      TO OPD-IND-PVEN IN UPC-FLD
                ELSE
                   MOVE 'DAP' TO MSG-COD-SIST
                   MOVE 'UPCPVENERR' TO MSG-COD-MENS
                   PERFORM GET-MSG
                   MOVE MSG-GLS-DESC TO FRM-MENS
                   MOVE FRM-SUAR-MAL TO FRM-SUAR
                   MOVE FRM-POS-CURS TO OPD-FEC-FTER-LEN IN UPC-FLD
                   GO TO FIN-VAL-CON-KEY-UPC.
           
      * A ESTA ALTURA PVEN SIEMPRE > ZEROES
      * PUES ANTERIORMENTE EXIGIO PVEN O FTER 
      * SI PVEN = 0 Y FTER > ZEROES
      * CALCULO PVEN COMO OPD-FEC-FTER MENOS OPD-FEC-FREA
      * POR LO TANTO AHORA CALCULA FRM-FEC-FTER

           IF OPD-NUM-PVEN IN UPC-FLD > ZEROES
               MOVE OPD-FEC-FREA IN UPC-FLD TO FEC-FECH
               PERFORM SEL-PER
               MOVE FEC-FECH TO FRM-FEC-FTER IN UPC-FLD
               IF OPD-FEC-FTER IN UPC-FLD NOT > ZEROES
                     MOVE FRM-FEC-FTER IN UPC-FLD TO
                          OPD-FEC-FTER IN UPC-FLD.

           IF OPD-FEC-FTER IN UPC-FLD NOT =
              FRM-FEC-FTER IN UPC-FLD
                MOVE 'DAP' TO MSG-COD-SIST
                MOVE 'UPCFTERINCO' TO MSG-COD-MENS
                PERFORM GET-MSG
                MOVE MSG-GLS-DESC TO FRM-MENS
                MOVE FRM-SUAR-MAL TO FRM-SUAR
                MOVE FRM-POS-CURS TO OPD-NUM-PVEN-LEN IN UPC-FLD
                GO TO FIN-VAL-CON-KEY-UPC.

      *>>>> INI_VAL_CON_KEY_UPC
*% END
      *<<<< FIN_PUT_OPD_UPC
      *<<<< FIN_PUT_OPD_UPC
*% END
*% IF FIN_VAL_CON_KEY
      *<<<< FIN_VAL_CON_KEY

      *>>>> FIN_VAL_CON_KEY
*% END
*% IF INI_OPD_FEC_FREA
      *<<<< INI_OPD_FEC_FREA
           MOVE FEC-CHOY-N TO FEC-CHOY.
           MOVE FEC-VHBL-N TO FEC-VHBL.
      *>>>> INI_OPD_FEC_FREA
*% END
*% IF INI_OPD_FEC_FTER
      *<<<< INI_OPD_FEC_FTER
           MOVE FEC-CHOY-N TO FEC-CHOY.
           MOVE FEC-VHBL-N TO FEC-VHBL.
      *>>>> INI_OPD_FEC_FTER
*% END
*% IF EOF
      *<<<< EOF

       SEL-PER SECTION.
       INI-SEL-PER.
      * ISP: OBTIENE EN FEC-FECH LA SUMA DE UNA FREA
      * ISP: CARGADA EN FEC-FECH
      *      + UN PERIODO ( OPD-NUM-PVEN u OPD-IND-PVEN )
           IF OPD-IND-PVEN IN UPC-FLD = 'D'
               MOVE FEC-SUM-DIA TO FEC-CMND
               MOVE OPD-NUM-PVEN IN UPC-FLD TO FEC-NDIA
           ELSE
           IF OPD-IND-PVEN IN UPC-FLD = 'M'
               MOVE FEC-SUM-MES TO FEC-CMND
               MOVE OPD-NUM-PVEN IN UPC-FLD TO FEC-NMES
           ELSE
           IF OPD-IND-PVEN IN UPC-FLD = 'A'
               MOVE FEC-SUM-ANO TO FEC-CMND
               MOVE OPD-NUM-PVEN IN UPC-FLD TO FEC-NANO.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           PERFORM CAL-FEC.
       FIN-SEL-PER.
           EXIT.
      *>>>> EOF
*% END
