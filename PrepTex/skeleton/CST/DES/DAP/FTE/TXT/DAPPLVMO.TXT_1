*%! Codigo adicional para archivo VMO
*% IF WSS
      *<<<< WSS
      *Entidades de GNS
       COPY GNSWGFEC.
       COPY GNSWGHOY.
      *Entidades de TAB
       COPY TABBROFI.
       COPY TABBRVLR.
      *Entidades de DAP
       COPY DAPBRVMO.

       01  WSS-VARI.
           03  WSS-FEC-FPRO.
               05  WSS-NUM-DPRO                      PIC 9(02).
               05  WSS-NUM-MPRO                      PIC 9(02).
               05  WSS-NUM-SPRO                      PIC 9(02).
               05  WSS-NUM-APRO                      PIC 9(02).
           03  WSS-FEC-FINI.
               05  WSS-NUM-DINI                      PIC 9(02).
               05  WSS-NUM-MINI                      PIC 9(02).
               05  WSS-NUM-SINI                      PIC 9(02).
               05  WSS-NUM-AINI                      PIC 9(02).
           03  WSS-FEC-FFIN.
               05  WSS-NUM-DFIN                      PIC 9(02).
               05  WSS-NUM-MFIN                      PIC 9(02).
               05  WSS-NUM-SFIN                      PIC 9(02).
               05  WSS-NUM-AFIN                      PIC 9(02).
           03  WSS-FEC-FTER.
               05  WSS-NUM-STER                      PIC 9(02).
               05  WSS-NUM-ATER                      PIC 9(02).
               05  WSS-NUM-MTER                      PIC 9(02).
               05  WSS-NUM-DTER                      PIC 9(02).
           03  WSS-FEC-FFAN.
               05  WSS-NUM-SSAN                      PIC 9(02).
               05  WSS-NUM-AAAN                      PIC 9(02).
               05  WSS-NUM-MMAN                      PIC 9(02).
               05  WSS-NUM-DDAN                      PIC 9(02).
           03  WSS-FEC-FFAC.
               05  WSS-NUM-SSAC                      PIC 9(02).
               05  WSS-NUM-AAAC                      PIC 9(02).
               05  WSS-NUM-MMAC                      PIC 9(02).
               05  WSS-NUM-DDAC                      PIC 9(02).
             03  WSS-IND-COPD         VALUE SPACES   PIC X(06).
             03  WSS-IND-VCAM         VALUE SPACES   PIC X(06).
             03  WSS-IND-OFIC         VALUE SPACES   PIC X(03).
             03  WSS-COD-COPD                        PIC X(06).
             03  WSS-COD-VCAM                        PIC X(06).
             03  WSS-VAL-SACT         VALUE ZEROS    PIC 9(11)V9(4).
             03  WSS-VAL-SANT         VALUE ZEROS    PIC 9(11)V9(4).
             03  WSS-VAL-VARI         VALUE ZEROS    PIC S9(11)V9(4).
             03  WSS-VAL-PORC         VALUE ZEROS    PIC S9(05)V9(4).
             03  WSS-TOT-SACT         VALUE ZEROS    PIC 9(11)V9(4).
             03  WSS-TOT-SANT         VALUE ZEROS    PIC 9(11)V9(4).
             03  WSS-TOT-VARI         VALUE ZEROS    PIC S9(11)V9(4).
             03  WSS-COD-SW0          VALUE ZEROS    PIC 9(01).
             03  WSS-SMAL             VALUE ZEROS    PIC 9(01).
             03  WSS-GLS-DEST.
               05  WSS-GLS-DES1                      PIC X(20).
               05  WSS-GLS-DES2                      PIC X(20).
      *>>>>
*% END
*% IF WSS_DTC
      *<<<< WSS_DTC
      *Entidades de TAB
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-OFI-REQA==.
      *>>>>
*% END
*% IF INI
      *<<<< INI
           DISPLAY ' '.
           DISPLAY 'INICIO CAPTURA PARAMETROS'.
           DISPLAY ' '.
      * Captura parametros 
           DISPLAY 'INGRESE FECHA DE PROCESO (DDMMSSAA) : '.
           ACCEPT WSS-FEC-FPRO IN WSS-VARI.
           DISPLAY WSS-FEC-FPRO IN WSS-VARI.

           DISPLAY 'INGRESE CODIGO MONEDA    (X(06)/*)  : '.
           ACCEPT WSS-COD-VCAM IN WSS-VARI.
           DISPLAY WSS-COD-VCAM IN WSS-VARI.

           DISPLAY 'INGRESE CLASE OPERACION  (X(06)/*)  : '.
           ACCEPT WSS-COD-COPD IN WSS-VARI.
           DISPLAY WSS-COD-COPD IN WSS-VARI.

           DISPLAY 'FIN CAPTURA PARAMETROS'.
           DISPLAY ' '.
           DISPLAY 'INICIO VALIDACION PARAMETROS'.

      *VAL-FEC Valida Fecha de Proceso
           MOVE WSS-FEC-FPRO IN WSS-VARI TO FEC-FECH.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           MOVE FEC-FBLK-N TO FEC-FBLK.
           MOVE FEC-CHOY-N TO FEC-CHOY.
           MOVE FEC-VHBL-N TO FEC-VHBL.
           MOVE FEC-VAL-FEC TO FEC-CMND.
           PERFORM PRO-FEC.
           IF NOT FEC-STAT-OKS
               DISPLAY ' '
               DISPLAY ' PROCESO CANCELADO '
               DISPLAY ' ERROR VALIDACION EN FECHA DE PROCESO: '
                         WSS-FEC-FPRO '  ' FEC-MENS
               PERFORM GNS-PRO-ABT.
 
      *BUS-TAB Valida Codigo de moneda
           IF WSS-COD-VCAM IN WSS-VARI > SPACES AND
              WSS-COD-VCAM IN WSS-VARI NOT = '*'
              MOVE 'TAB' TO TAB-COD-SIST
              MOVE 'VLR' TO TAB-COD-TTAB IN TAB
              MOVE WSS-COD-VCAM IN WSS-VARI TO TAB-COD-CTAB IN TAB
              PERFORM BUS-TAB
              IF MSG-GLS-MENS = 'COD    NEX'
                  DISPLAY ' '
                  DISPLAY ' PROCESO CANCELADO '
                  DISPLAY ' ERROR VALIDACION COD. MONEDA: ' 
                            WSS-COD-VCAM IN WSS-VARI
                  PERFORM GNS-PRO-ABT.

      *BUS-TAB Valida Clase de operacion
           IF WSS-COD-COPD IN WSS-VARI > SPACES AND
              WSS-COD-COPD IN WSS-VARI NOT = '*'
              MOVE 'TAB' TO TAB-COD-SIST
              MOVE 'AUX' TO TAB-COD-TTAB IN TAB
              MOVE WSS-COD-COPD IN WSS-VARI TO TAB-COD-CTAB IN TAB
              PERFORM BUS-TAB
              IF MSG-GLS-MENS = 'COD    NEX'
                  DISPLAY ' '
                  DISPLAY ' PROCESO CANCELADO '
                  DISPLAY ' ERROR VALIDACION CLASE DE OPERACION: ' 
                            WSS-COD-COPD IN WSS-VARI
                  PERFORM GNS-PRO-ABT.

      *Calcula fecha dia habil anterior a fecha proceso
           MOVE WSS-NUM-DPRO TO WSS-NUM-DINI IN WSS-VARI.
           MOVE WSS-NUM-MPRO TO WSS-NUM-MINI IN WSS-VARI.
           MOVE WSS-NUM-SPRO TO WSS-NUM-SINI IN WSS-VARI.
           MOVE WSS-NUM-APRO TO WSS-NUM-AINI IN WSS-VARI.
           PERFORM BUS-ULT-HAB.
           IF MSG-COD-MENS > SPACES 
              DISPLAY ' '
              DISPLAY ' PROCESO CANCELADO '
              DISPLAY ' ERROR EN RUTINA BUSCA FECHA HABIL ANTERIOR: '
                        MSG-COD-MENS ' FS: ' FIO-STAT
              PERFORM GNS-PRO-ABT.

           MOVE WSS-NUM-DINI IN WSS-VARI TO WSS-NUM-DDAN IN WSS-VMO. 
           MOVE WSS-NUM-MINI IN WSS-VARI TO WSS-NUM-MMAN IN WSS-VMO.
           MOVE WSS-NUM-SINI IN WSS-VARI TO WSS-NUM-SSAN IN WSS-VMO.
           MOVE WSS-NUM-AINI IN WSS-VARI TO WSS-NUM-AAAN IN WSS-VMO.
           MOVE WSS-NUM-DPRO IN WSS-VARI TO WSS-NUM-DDAC IN WSS-VMO
                                            WSS-NUM-DDAC IN WSS-VARI.
           MOVE WSS-NUM-MPRO IN WSS-VARI TO WSS-NUM-MMAC IN WSS-VMO
                                            WSS-NUM-MMAC IN WSS-VARI.
           MOVE WSS-NUM-SPRO IN WSS-VARI TO WSS-NUM-SSAC IN WSS-VMO
                                            WSS-NUM-SSAC IN WSS-VARI.
           MOVE WSS-NUM-APRO IN WSS-VARI TO WSS-NUM-AAAC IN WSS-VMO
                                            WSS-NUM-AAAC IN WSS-VARI.
           MOVE WSS-NUM-DPRO IN WSS-VARI TO WSS-NUM-DTER IN WSS-VARI.
           MOVE WSS-NUM-MPRO IN WSS-VARI TO WSS-NUM-MTER IN WSS-VARI.
           MOVE WSS-NUM-SPRO IN WSS-VARI TO WSS-NUM-STER IN WSS-VARI.
           MOVE WSS-NUM-APRO IN WSS-VARI TO WSS-NUM-ATER IN WSS-VARI.
           DISPLAY ' '.
           DISPLAY 'FIN VALIDACION PARAMETROS'.
           DISPLAY ' '.
      *>>>>
*% END
*% IF CF_VMO_OPD_COD_VCAM
      *<<<< IF CF_VMO_OPD_COD_VCAM
           MOVE 1 TO WSS-COD-SW0.
           MOVE WSS-TOT-SACT IN WSS-VARI TO
                                  WSS-TOT-SACT IN WSS-VMO.
           MOVE WSS-TOT-SANT IN WSS-VARI TO
                                  WSS-TOT-SANT IN WSS-VMO.
           MOVE WSS-TOT-VARI IN WSS-VARI TO
                                  WSS-TOT-VARI IN WSS-VMO.
           MOVE ZEROES TO WSS-TOT-SACT IN WSS-VARI.
           MOVE ZEROES TO WSS-TOT-SANT IN WSS-VARI.
           MOVE ZEROES TO WSS-TOT-VARI IN WSS-VARI.
      *>>>>
*% END
*% IF CF_VMO_OPD_COD_COPD
      *<<<< IF CF_VMO_OPD_COD_COPD
           MOVE 1 TO WSS-COD-SW0.
           MOVE WSS-TOT-SACT IN WSS-VARI TO
                                  WSS-TOT-SACT IN WSS-VMO.
           MOVE WSS-TOT-SANT IN WSS-VARI TO
                                  WSS-TOT-SANT IN WSS-VMO.
           MOVE WSS-TOT-VARI IN WSS-VARI TO
                                  WSS-TOT-VARI IN WSS-VMO.
           MOVE ZEROES TO WSS-TOT-SACT IN WSS-VARI.
           MOVE ZEROES TO WSS-TOT-SANT IN WSS-VARI.
           MOVE ZEROES TO WSS-TOT-VARI IN WSS-VARI.
      *>>>>
*% END
*% IF CF_VMO_OPD_COD_OFIC
      *<<<< IF CF_VMO_OPD_COD_OFIC
           MOVE WSS-IND-OFIC IN WSS-VARI TO OFI-COD-OFIC IN OFI.
           PERFORM BUS-OFI.

      *Genera Saldo anterior, Saldo actual y Diferencia
      *segun fechas ingresadas por parametro.
           MOVE 0 TO WSS-SMAL.
           MOVE WSS-VAL-SACT IN WSS-VARI TO 
                                          WSS-VAL-SACT IN WSS-VMO.

           MOVE WSS-IND-VCAM IN WSS-VARI TO VMO-COD-VCAM IN VMO.
           MOVE WSS-IND-COPD IN WSS-VARI TO VMO-COD-COPD IN VMO.
           MOVE WSS-IND-OFIC IN WSS-VARI TO VMO-COD-OFIC IN VMO.
           MOVE FIO-GET-KEY-UPD TO FIO-CMND.
           PERFORM DAP-FIO-VMO.
           IF NOT FIO-STAT-OKS
              MOVE WSS-IND-VCAM IN WSS-VARI TO VMO-COD-VCAM IN VMO
              MOVE WSS-IND-COPD IN WSS-VARI TO VMO-COD-COPD IN VMO
              MOVE WSS-IND-OFIC IN WSS-VARI TO VMO-COD-OFIC IN VMO
              MOVE WSS-NUM-DINI IN WSS-VARI TO VMO-NUM-DPRO IN VMO
              MOVE WSS-NUM-MINI IN WSS-VARI TO VMO-NUM-MPRO IN VMO
              MOVE WSS-NUM-SINI IN WSS-VARI TO VMO-NUM-SPRO IN VMO
              MOVE WSS-NUM-AINI IN WSS-VARI TO VMO-NUM-APRO IN VMO
              MOVE ZEROES                   TO VMO-VAL-SANT IN VMO
              MOVE FIO-PUT TO FIO-CMND
              PERFORM DAP-FIO-VMO
              IF NOT FIO-STAT-OKS 
                 DISPLAY ' ' 
                 DISPLAY ' PROCESO CANCELADO ' 
                 DISPLAY ' ERROR AL GRABAR VMO ' VMO 
                         ' FS: ' FIO-STAT
                 MOVE PGM-SMAL TO PGM-STAT-SRT
                 MOVE 1 TO WSS-SMAL.
     
           MOVE VMO-VAL-SANT IN VMO TO WSS-VAL-SANT IN WSS-VARI.

           MOVE WSS-VAL-SACT IN WSS-VARI TO VMO-VAL-SANT IN VMO.
           MOVE FIO-MOD TO FIO-CMND.
           PERFORM DAP-FIO-VMO.
           IF NOT FIO-STAT-OKS
              DISPLAY ' ' 
              DISPLAY ' PROCESO CANCELADO ' 
              DISPLAY ' ERROR AL REGRABAR VMO ' VMO
                      ' FS: ' FIO-STAT
              MOVE PGM-SMAL TO PGM-STAT-SRT
              MOVE 1 TO WSS-SMAL.

           MOVE WSS-VAL-SANT IN WSS-VARI TO 
                                          WSS-VAL-SANT IN WSS-VMO.
           SUBTRACT WSS-VAL-SANT IN WSS-VARI FROM
                                  WSS-VAL-SACT IN WSS-VARI GIVING 
                                  WSS-VAL-VARI IN WSS-VMO.
 
           IF WSS-VAL-VARI IN WSS-VMO = ZEROES 
              MOVE ZEROES TO WSS-VAL-PORC IN WSS-VMO
           ELSE
              IF WSS-VAL-SANT IN WSS-VARI = ZEROES
                 MOVE ZEROES TO WSS-VAL-PORC IN WSS-VMO
              ELSE
                COMPUTE WSS-VAL-PORC IN WSS-VMO = 
              ((( WSS-VAL-SACT IN WSS-VARI - 
                  WSS-VAL-SANT IN WSS-VARI ) / 
                  WSS-VAL-SANT IN WSS-VARI ) * 100 ).

      *           DIVIDE WSS-VAL-SACT IN WSS-VARI BY 
      *                  WSS-VAL-SANT IN WSS-VARI GIVING
      *                  WSS-VAL-PORC IN WSS-VARI
      *          COMPUTE WSS-VAL-PORC IN WSS-VMO = 
      *        ( ( WSS-VAL-PORC IN WSS-VARI * 100 ) - 100 ).

           ADD WSS-VAL-SACT IN WSS-VMO TO
                                  WSS-TOT-SACT IN WSS-VARI.
           ADD WSS-VAL-SANT IN WSS-VMO TO
                                  WSS-TOT-SANT IN WSS-VARI.
           ADD WSS-VAL-VARI IN WSS-VMO TO
                                  WSS-TOT-VARI IN WSS-VARI.
           MOVE ZEROES TO WSS-VAL-SACT IN WSS-VARI.
           MOVE ZEROES TO WSS-VAL-SANT IN WSS-VARI.
           MOVE ZEROES TO WSS-VAL-VARI IN WSS-VARI.
           MOVE ZEROES TO WSS-VAL-PORC IN WSS-VARI.
      *>>>>
*% END
*% IF PH_VMO
      *<<<< IF PH_VMO
           MOVE 'TAB' TO TAB-COD-SIST.
           MOVE 'VLR' TO TAB-COD-TTAB IN TAB.
           MOVE OPD-COD-VCAM IN SRT TO TAB-COD-CTAB IN TAB.
           PERFORM BUS-TAB.
           MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-VCAM IN WSS-VMO.
      *
           MOVE 'TAB' TO TAB-COD-SIST.
           MOVE 'TIO' TO TAB-COD-TTAB IN TAB.
           MOVE OPD-COD-TOPD IN SRT TO TAB-COD-CTAB IN TAB.
           PERFORM BUS-TAB.
           MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-DES1 IN WSS-VARI.
      *
           MOVE 'TAB' TO TAB-COD-SIST.
           MOVE 'AUX' TO TAB-COD-TTAB IN TAB.
           MOVE OPD-COD-COPD IN SRT TO TAB-COD-CTAB IN TAB.
           PERFORM BUS-TAB.
           MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-DES2 IN WSS-VARI.
           MOVE WSS-GLS-DEST IN WSS-VARI TO
                                        WSS-GLS-COPD IN WSS-VMO.
      *>>>>
*% END
*% IF INI_INP
      *<<<< INI_INP
           MOVE FIO-UPD TO FIO-CMND.
           PERFORM DAP-FIO-VMO.
      *>>>>
*% END
*% IF INI_FST_INP
      *<<<< INI_FST_INP
           MOVE ZEROES TO OPD-FEC-FREA IN OPD.
           MOVE 'OPD-FEC-FREA' TO FIO-AKEY.

           MOVE FIO-GET-NLS TO FIO-CMND.
           PERFORM DAP-FIO-OPD.
           IF NOT FIO-STAT-OKS
               DISPLAY ' '
               DISPLAY ' PROCESO CANCELADO '
               DISPLAY ' ERROR AL ACCESAR OPD POR OPD-FEC-FREA : '
                         OPD-FEC-FREA IN OPD ' FS: ' FIO-STAT
               MOVE PGM-SMAL TO PGM-STAT-SRT
               GO TO FIN-INP-SRT.
           IF OPD-FEC-FREA IN OPD > WSS-FEC-FTER IN WSS-VARI
               DISPLAY 'NO HAY REGISTRO HASTA FECHA DE PROCESO : '
                                        WSS-FEC-FTER IN WSS-VARI
               GO TO FIN-INP-SRT
           ELSE
               GO TO LUP-INP-SRT.
      *>>>>
*% END
*% IF LUP_INP
      *<<<< LUP_INP
      *Controla ingreso de registros validos
           IF WSS-COD-COPD IN WSS-VARI > SPACES AND
              WSS-COD-COPD IN WSS-VARI NOT = '*'
              IF WSS-COD-COPD IN WSS-VARI NOT = OPD-COD-COPD IN OPD
                 GO TO NXT-INP-SRT.

           IF WSS-COD-VCAM IN WSS-VARI > SPACES AND
              WSS-COD-VCAM IN WSS-VARI NOT = '*'
              IF WSS-COD-VCAM IN WSS-VARI NOT = OPD-COD-VCAM IN OPD
                 GO TO NXT-INP-SRT.

           IF OPD-COD-STAT IN OPD NOT = 'G'
              GO TO NXT-INP-SRT.
      *>>>>
*% END
*% IF INI_NXT_INP
      *<<<< INI_NXT_INP
      *Ubica registro en OPD por fecha
           MOVE 'OPD-FEC-FREA' TO FIO-AKEY.
      *>>>>
*% END
*% IF FIN_NXT_INP
      *<<<< FIN_NXT_INP
      *Controla ingreso de registros por fecha termino
           IF OPD-FEC-FREA IN OPD > WSS-FEC-FTER IN WSS-VARI
              GO TO FIN-INP-SRT.
      *>>>>
*% END
*% IF INI_OUT
      *<<<< INI_OUT
           MOVE 0 TO WSS-COD-SW0 IN WSS-VARI.
      *>>>>
*% END
*% IF LUP_OUT
      *<<<< LUP_OUT
      *>>>>
*% END
*% IF FIN_GEN_OUT
      *<<<< FIN_GEN_OUT
           IF WSS-SMAL > 0
              GO TO EXT-OUT-SRT.

           IF OPD-FEC-FREA IN SRT NOT > WSS-FEC-FFAC IN WSS-VARI
              ADD OPD-VAL-SCAP IN SRT TO WSS-VAL-SACT IN WSS-VARI.
           MOVE OPD-COD-VCAM IN SRT TO WSS-IND-VCAM IN WSS-VARI. 
           MOVE OPD-COD-COPD IN SRT TO WSS-IND-COPD IN WSS-VARI. 
           MOVE OPD-COD-OFIC IN SRT TO WSS-IND-OFIC IN WSS-VARI. 
      *>>>>
*% END
*% IF EOF
      *<<<< EOF
      *Entidades  de GNS
       COPY GNSBGFEC.
       COPY GNSBPFEC.
       COPY GNSBGHOY.
       COPY GNSBBMSG.
       COPY GNSBBTAB.
      *Entidades  de TAB
       COPY TABBFOFI.
       COPY TABBBOFI.
       COPY TABBVOFI.
      *Entidades de DAP
       COPY DAPBFVMO.

       BUS-ULT-HAB SECTION.
       INI-BUS-ULT-HAB.
      * BUS-PRIMER-DIA-HABIL
           MOVE WSS-FEC-FINI TO FEC-FECH.
       BUS-PDH.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           MOVE FEC-RST-DIA  TO FEC-CMND.
           MOVE 1            TO FEC-NDIA.
           PERFORM CAL-FEC.
      *VAL-FEC Validar Fecha
           MOVE FEC-FORM-FEC TO FEC-FORM.
           MOVE FEC-FBLK-S   TO FEC-FBLK.
           MOVE FEC-CHOY-N   TO FEC-CHOY.
           MOVE FEC-VHBL-S   TO FEC-VHBL.
           MOVE FEC-VAL-FEC  TO FEC-CMND.
           PERFORM PRO-FEC.
           IF NOT FEC-STAT-HBL
              GO TO BUS-PDH.

       NOT-BUS-PDH.
           MOVE FEC-FECH TO WSS-FEC-FINI.
           DISPLAY ' '.
           DISPLAY ' FECHA HABIL ANTERIOR: ' WSS-FEC-FINI.
           DISPLAY ' '.
       FIN-BUS-ULT-HAB.
           EXIT.
      *>>>>
*% END
