*%! Codigo adicional para archivo IPP
*% IF WSS
      *<<<< WSS
      *Entidades  de GNS
       COPY GNSWGFEC.
       COPY GNSWGHOY.
       COPY GNSBRMSC.
      *Entidades  de TAB
       COPY TABBRUSR.
       COPY TABBROFI.
       COPY TABBRVLR.
       COPY TABBRCAM.

       01  WSS-VARI.
           03 WSS-FEC-FPRO.
              05 WSS-NUM-DPRO                     PIC 9(02).
              05 WSS-NUM-MPRO                     PIC 9(02).
              05 WSS-NUM-SPRO                     PIC 9(02).
              05 WSS-NUM-APRO                     PIC 9(02).
           03 WSS-FEC-FFEC.
              05 WSS-NUM-SFEC                     PIC 9(02).
              05 WSS-NUM-AFEC                     PIC 9(02).
              05 WSS-NUM-MFEC                     PIC 9(02).
              05 WSS-NUM-DFEC                     PIC 9(02).
           03 WSS-COD-OFIC                        PIC X(03). 
           03 WSS-COD-COPD                        PIC X(06). 
           03 WSS-COD-VCAM                        PIC X(03). 
           03 WSS-NUM-TINT        VALUE ZEROS     PIC 9(07)V9999. 
           03 WSS-NUM-PLAZ        VALUE ZEROS     PIC 9(07). 
           03 WSS-NUM-OPER        VALUE ZEROS     PIC 9(07). 
           03 WSS-GLS-DEST.
              05  WSS-GLS-DES1                    PIC X(20).
              05  WSS-GLS-DES2                    PIC X(20).
           03 WSS-COD-TINT.
              05  WSS-COD-BCTI                    PIC X(01).
              05  WSS-COD-PBTI                    PIC X(01).
              05  WSS-COD-MCTI                    PIC X(02).
              05  WSS-COD-CVTI                    PIC X(03).
              05  WSS-GLS-REST                    PIC X(05).
           03 WSS-TAS1            VALUE ZEROS     PIC 9(11)V9(04). 
           03 WSS-TAS2            VALUE ZEROS     PIC 9(11)V9(04). 
           03 WSS-TASA            VALUE ZEROS     PIC 9(11)V9(04). 
           03 WSS-PLZO            VALUE ZEROS     PIC 9(11)V9(02). 
           03 WSS-PLAZO           VALUE ZEROS     PIC 9(07). 
           03 WSS-ACU-TASA        VALUE ZEROS     PIC 9(11)V9(04). 
           03 WSS-ACU-PLZO        VALUE ZEROS     PIC 9(11)V9(02). 
           03 WSS-ACU-CAPT        VALUE ZEROS     PIC 9(11)V9(04). 
           03 WSS-ACU-KIPI        VALUE ZEROS     PIC 9(11)V9(04). 
      *    Tasa Interes Informada
           03  INT-TINT           VALUE ZEROES    PIC 9(03)V9(06).
      *>>>>
*% END
*% IF WSS_DTC
      *<<<< WSS_DTC
      *Entidades  de TAB
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-OFI-REQA==. 
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-USR-REQA==. 
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-CAM-REQA==. 
      *Entidades  de GNS
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-MSC-REQA==. 
      *>>>>
*% END
*% IF CF_IPP_OPD_COD_COPD
      *<<<< CF_IPP_OPD_COD_COPD
           DIVIDE WSS-ACU-TASA IN WSS-VARI BY WSS-ACU-KIPI
                  GIVING WSS-SGV-PINT IN WSS-IPP.   

           DIVIDE WSS-ACU-PLZO IN WSS-VARI BY WSS-ACU-CAPT 
                  GIVING WSS-NUM-PPCT IN WSS-IPP ROUNDED.

           MOVE ZEROES TO WSS-ACU-TASA IN WSS-VARI. 
           MOVE ZEROES TO WSS-ACU-PLZO IN WSS-VARI.
           MOVE ZEROES TO WSS-ACU-CAPT IN WSS-VARI.
           MOVE ZEROES TO WSS-ACU-KIPI IN WSS-VARI.
           MOVE ZEROES TO WSS-NUM-OPER IN WSS-VARI. 
      *>>>>
*% END
*% IF PH_IPP
      *<<<< PH_IPP
      * Mediante BUS-OFI se Obtiene Nombre de la Oficina de Tabla OFI
           IF OPD-COD-OFIC IN SRT > SPACES
               MOVE OPD-COD-OFIC IN SRT TO OFI-COD-OFIC IN OFI
               PERFORM BUS-OFI.

      * Mediante BUS-TAB Busca Tipo de Moneda de Tabla VLR
           IF OPD-COD-VCAM IN SRT > SPACES
               MOVE 'TAB'               TO TAB-COD-SIST
               MOVE 'VLR'               TO TAB-COD-TTAB IN TAB
               MOVE OPD-COD-VCAM IN SRT TO TAB-COD-CTAB IN TAB
               PERFORM BUS-TAB
               MOVE TAB-GLS-DCOR IN TAB TO WSS-GLS-VCAM IN WSS-IPP
           ELSE
               MOVE SPACES TO WSS-GLS-VCAM IN WSS-IPP.

      *Recupera glosa de operacion
           MOVE 'TAB' TO TAB-COD-SIST.
           MOVE 'TIO' TO TAB-COD-TTAB IN TAB.
           MOVE OPD-COD-TOPD IN SRT TO TAB-COD-CTAB IN TAB.
           PERFORM BUS-TAB.
           MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-DES1 IN WSS-VARI.
      *
           MOVE 'TAB' TO TAB-COD-SIST.
           MOVE 'AUX' TO TAB-COD-TTAB IN TAB.
           MOVE OPD-COD-COPD IN SRT TO TAB-COD-CTAB IN TAB.
           PERFORM BUS-TAB.
           MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-DES2 IN WSS-VARI.
           MOVE WSS-GLS-DEST IN WSS-VARI TO
                                        WSS-GLS-COPD IN WSS-IPP.
      *>>>>
*% END
*% IF INI
      *<<<< INI
           DISPLAY ' '.
           DISPLAY 'INICIO CAPTURA DE PARAMETROS'.
           DISPLAY ' '.
      * Captura Fecha de Proceso
           DISPLAY 'FECHA DE PROCESO ( DDMMAAAA )  : '.
           ACCEPT  WSS-FEC-FPRO IN WSS-VARI.
           DISPLAY WSS-FEC-FPRO IN WSS-VARI.
      * Captura codigo de oficina
           DISPLAY 'INGRESE COD. OFICINA  (XXX/*)  : '.
           ACCEPT  WSS-COD-OFIC IN WSS-VARI.
           DISPLAY WSS-COD-OFIC IN WSS-VARI.
      * Captura codigo de moneda
           DISPLAY 'INGRESE COD. MONEDA (X(06)/*)  : '.
           ACCEPT  WSS-COD-VCAM IN WSS-VARI.
           DISPLAY WSS-COD-VCAM IN WSS-VARI.
      * Captura codigo de operacion
           DISPLAY 'INGRESE CLASE OPER. (X(06)/*)  : '.
           ACCEPT  WSS-COD-COPD IN WSS-VARI.
           DISPLAY WSS-COD-COPD IN WSS-VARI.

           DISPLAY 'FIN    CAPTURA    DE PARAMETROS'.
           DISPLAY ' '.
           DISPLAY 'INICIO VALIDACION DE PARAMETROS'.

      *VAL-FEC Valida Fecha de Proceso
           MOVE WSS-FEC-FPRO    IN WSS-VARI TO FEC-FECH.
           MOVE FEC-FORM-FEC TO FEC-FORM.
           MOVE FEC-FBLK-N   TO FEC-FBLK.
           MOVE FEC-CHOY-LE  TO FEC-CHOY.
           MOVE FEC-VHBL-N   TO FEC-VHBL.
           MOVE FEC-VAL-FEC  TO FEC-CMND.
           PERFORM PRO-FEC.
           IF NOT FEC-STAT-OKS
               DISPLAY ' '
               DISPLAY ' PROCESO CANCELADO '
               DISPLAY ' ERROR VALIDACION EN FECHA DE PROCESO: '
                         WSS-FEC-FPRO '  ' FEC-MENS
               PERFORM GNS-PRO-ABT.

      *VAL-OFI Valida Codigo de oficina
           IF WSS-COD-OFIC IN WSS-VARI > SPACES AND
              WSS-COD-OFIC IN WSS-VARI NOT = '*'
              MOVE WSS-COD-OFIC IN WSS-VARI TO OFI-COD-OFIC IN OFI
              PERFORM VAL-OFI
               IF MSG-GLS-MENS = 'COD    NEX'
                  DISPLAY ' '
                  DISPLAY ' PROCESO CANCELADO '
                  DISPLAY ' ERROR VALIDACION OFICINA: ' 
                            WSS-COD-OFIC IN WSS-VARI
                  PERFORM GNS-PRO-ABT.

      *VAL-TAB Valida Codigo de moneda
           IF WSS-COD-VCAM IN WSS-VARI > SPACES AND
              WSS-COD-VCAM IN WSS-VARI NOT = '*'
              MOVE 'TAB'               TO TAB-COD-SIST
              MOVE 'VLR'               TO TAB-COD-TTAB IN TAB
              MOVE WSS-COD-VCAM IN WSS-VARI TO TAB-COD-CTAB IN TAB
              PERFORM BUS-TAB
               IF MSG-GLS-MENS = 'COD    NEX'
                  DISPLAY ' '
                  DISPLAY ' PROCESO CANCELADO '
                  DISPLAY ' ERROR VALIDACION COD. MONEDA: ' 
                            WSS-COD-VCAM IN WSS-VARI
                  PERFORM GNS-PRO-ABT.

      *VAL-TAB Valida Codigo de operacion
           IF WSS-COD-COPD IN WSS-VARI > SPACES AND
              WSS-COD-COPD IN WSS-VARI NOT = '*'
              MOVE 'DAP'               TO TAB-COD-SIST
              MOVE 'AUX'               TO TAB-COD-TTAB IN TAB
              MOVE WSS-COD-COPD IN WSS-VARI TO TAB-COD-CTAB IN TAB
              PERFORM BUS-TAB
               IF MSG-GLS-MENS = 'COD    NEX'
                  DISPLAY ' '
                  DISPLAY ' PROCESO CANCELADO '
                  DISPLAY ' ERROR VALIDACION COD. OPERACION: ' 
                            WSS-COD-COPD IN WSS-VARI
                  PERFORM GNS-PRO-ABT.

           MOVE WSS-NUM-DPRO IN WSS-VARI TO WSS-NUM-DFEC IN WSS-VARI.
           MOVE WSS-NUM-MPRO IN WSS-VARI TO WSS-NUM-MFEC IN WSS-VARI.
           MOVE WSS-NUM-SPRO IN WSS-VARI TO WSS-NUM-SFEC IN WSS-VARI.
           MOVE WSS-NUM-APRO IN WSS-VARI TO WSS-NUM-AFEC IN WSS-VARI.
           DISPLAY ' '.
           DISPLAY 'FIN VALIDACION DE PARAMETROS'.
           DISPLAY ' '.
      *>>>>
*% END
*% IF INI_FST_INP
      *<<<< INI_FST_INP
           MOVE WSS-NUM-DPRO IN WSS-VARI TO OPD-NUM-DCMP IN OPD.
           MOVE WSS-NUM-MPRO IN WSS-VARI TO OPD-NUM-MCMP IN OPD.
           MOVE WSS-NUM-SPRO IN WSS-VARI TO OPD-NUM-SCMP IN OPD.
           MOVE WSS-NUM-APRO IN WSS-VARI TO OPD-NUM-ACMP IN OPD.

      *JVM: Accesa archivo OPD por llave alternativa.
           MOVE 'OPD-FEC-FCMP' TO FIO-AKEY.
           MOVE FIO-GET-NLS TO FIO-CMND.
           PERFORM DAP-FIO-OPD.
           IF NOT FIO-STAT-OKS
               DISPLAY ' '
               DISPLAY ' PROCESO CANCELADO '
               DISPLAY ' ERROR AL ACCESAR OPD POR OPD-FEC-FCMP : '
                                                     FIO-STAT
               MOVE PGM-SMAL TO PGM-STAT-SRT
               GO TO FIN-INP-SRT.
           IF OPD-FEC-FCMP IN OPD > WSS-FEC-FFEC IN WSS-VARI
               DISPLAY ' NO EXISTEN REGS. A FECHA DE PROCESO '
                                     WSS-FEC-FFEC IN WSS-VARI
               GO TO FIN-INP-SRT
           ELSE
               GO TO LUP-INP-SRT.
      *>>>>
*% END
*% IF LUP_INP
      *<<<< LUP_INP
           IF WSS-COD-OFIC IN WSS-VARI > SPACES AND
              WSS-COD-OFIC IN WSS-VARI NOT = '*'
              IF WSS-COD-OFIC IN WSS-VARI NOT = OPD-COD-OFIC IN OPD
                 GO TO NXT-INP-SRT.

           IF WSS-COD-VCAM IN WSS-VARI > SPACES AND
              WSS-COD-VCAM IN WSS-VARI NOT = '*'
              IF WSS-COD-VCAM IN WSS-VARI NOT = OPD-COD-VCAM IN OPD
                 GO TO NXT-INP-SRT.

           IF WSS-COD-COPD IN WSS-VARI > SPACES AND
              WSS-COD-COPD IN WSS-VARI NOT = '*'
              IF WSS-COD-COPD IN WSS-VARI NOT = OPD-COD-COPD IN OPD
                 GO TO NXT-INP-SRT.

           IF OPD-COD-STAT IN OPD NOT = 'G'
              GO TO NXT-INP-SRT.

           IF OPD-VAL-SCAP IN OPD = ZEROES
              GO TO NXT-INP-SRT.

           MOVE 1 TO SRT-NUM-OPER IN SRT.
      *>>>>
*% END
*% IF INI_NXT_INP
      *<<<< INI_NXT_INP
           MOVE 'OPD-FEC-FCMP' TO FIO-AKEY.
      *>>>>
*% END
*% IF FIN_NXT_INP
      *<<<< FIN_NXT_INP
           IF OPD-FEC-FCMP IN OPD > WSS-FEC-FFEC IN WSS-VARI
               GO TO FIN-INP-SRT.
      *>>>>
*% END
*% IF FST_OUT
      *<<<< FST_OUT
           MOVE 'GERENCIA DE FINANZAS - MESA DE DINERO' TO
                                      WSS-GLS-DEST IN WSS-IPP.
           MOVE 'DEPARTAMENTO DE CAPTACIONES' TO
                                      WSS-GLS-ORIG IN WSS-IPP.
           MOVE 'TASAS Y PLAZOS PROM PONDERADOS INV EFECTUADAS HOY'
                                   TO WSS-GLS-MATE IN WSS-IPP.
      *>>>>
*% END
*% IF LUP_OUT
      *<<<< LUP_OUT
      *Limpia Variables de Calculo
           MOVE ZEROES TO WSS-TAS1  IN WSS-VARI
                          WSS-TAS2  IN WSS-VARI 
                          WSS-TASA  IN WSS-VARI 
                          WSS-PLZO  IN WSS-VARI 
                          WSS-PLAZO IN WSS-VARI. 

      *Genera plazo de tasa de interes.
           MOVE OPD-COD-TINT IN SRT TO WSS-COD-TINT IN WSS-VARI.
           IF WSS-COD-PBTI IN WSS-VARI = 'M'
              MOVE 30 TO WSS-PLAZO IN WSS-VARI
           ELSE
           IF WSS-COD-PBTI IN WSS-VARI = 'A'
              MOVE 360 TO WSS-PLAZO IN WSS-VARI
           ELSE
              DISPLAY ' ' 
              DISPLAY 'COD. TASA INTERES ERRONEO ' OPD-COD-TINT IN SRT
              MOVE 1 TO WSS-PLAZO IN WSS-VARI.

           IF WSS-COD-CVTI IN WSS-VARI > SPACES
              PERFORM OBT-TASA-BAS
              MOVE INT-TINT TO OPD-SGV-TINT IN SRT.

      *Genera valor tasa segun formula tasa promedio ponderada
      *
      *      SUM Ki * Ti * Pi
      *Tpp = ----------------    ; donde  Ki = Capital
      *      SUM Ki * Pi                  Ti = Tasa Calculada al plazo
      *                                   Pi = Plazo

           MULTIPLY OPD-VAL-CAPT IN SRT BY OPD-NUM-DURV IN SRT
                    GIVING WSS-TAS1 IN WSS-VARI.

           MULTIPLY WSS-TAS1 IN WSS-VARI BY OPD-SGV-TINT IN SRT
                    GIVING WSS-TASA IN WSS-VARI.

           MOVE OPD-SGV-TINT IN SRT TO WSS-SGV-TINT IN SRT.

      *Genera valor plazo para calculo plazo promedio ponderado
           MULTIPLY OPD-VAL-CAPT IN SRT BY OPD-NUM-DURV IN SRT
                    GIVING WSS-PLZO IN WSS-VARI.

           DISPLAY '   '.
           DISPLAY 'CAPT     ' OPD-VAL-CAPT IN SRT.
           DISPLAY 'COD TASA ' OPD-COD-TINT IN SRT.
           DISPLAY 'TASA     ' OPD-SGV-TINT IN SRT.
           DISPLAY 'DURV     ' OPD-NUM-DURV IN SRT.
           DISPLAY 'PLAZO    ' WSS-PLAZO IN WSS-VARI.
           DISPLAY 'KiPi     ' WSS-TAS1 IN WSS-VARI.
           DISPLAY 'TP       ' WSS-TASA IN WSS-VARI.
           DISPLAY 'PP       ' WSS-PLZO IN WSS-VARI.
           DISPLAY '   '.

      *Recupera glosa de tasa
           MOVE 'TAB'        TO TAB-COD-SIST.
           MOVE 'INT'        TO TAB-COD-TTAB IN TAB.            
           MOVE OPD-COD-TINT IN SRT  TO TAB-COD-CTAB IN TAB.            
           PERFORM BUS-TAB.
           MOVE TAB-GLS-DESC IN TAB TO WSS-GLS-TINT IN WSS-IPP.

      * Mediante BUS-USR Busca Usuario de Tabla USR
      *     IF OPD-COD-EJEC IN SRT > SPACES
      *         MOVE OPD-COD-EJEC IN SRT TO USR-COD-USER IN USR
      *         PERFORM BUS-USR
      *         MOVE USR-GLS-DESC IN USR TO WSS-GLS-EJEC IN WSS-IPP
      *     ELSE
      *         MOVE SPACES TO WSS-GLS-EJEC IN WSS-IPP.
      *>>>>
*% END
*% IF FIN_GEN_OUT
      *<<<< FIN_GEN_OUT
      * Acumula para generar tasas y plazos promedios
           ADD SRT-NUM-OPER IN SRT TO WSS-NUM-OPER IN WSS-VARI.
           ADD WSS-PLZO IN WSS-VARI TO WSS-ACU-PLZO IN WSS-VARI.
           ADD WSS-TASA IN WSS-VARI TO WSS-ACU-TASA IN WSS-VARI.
           ADD WSS-TAS1 IN WSS-VARI TO WSS-ACU-KIPI IN WSS-VARI.
           ADD OPD-VAL-CAPT IN SRT  TO WSS-ACU-CAPT IN WSS-VARI.
      *>>>>
*% END
*% IF EOF
      *<<<< EOF
      *Entidades  de GNS
       COPY GNSBGFEC.
       COPY GNSBGHOY.
       COPY GNSBBMSG.
       COPY GNSBBTAB.
      *Entidades  de TAB
       COPY TABBFCAM.
       COPY TABBFUSR.
       COPY TABBBUSR.
       COPY TABBVUSR.
       COPY TABBFOFI.
       COPY TABBBOFI.
       COPY TABBVOFI.

      * Obtiene tasa base para operaciones con T. Variable
       OBT-TASA-BAS SECTION.
       INI-OBT-TASA-BAS.
           MOVE OPD-SGV-TINT IN SRT TO INT-TINT.
      *Si es tasa variable
           IF ( WSS-COD-CVTI IN WSS-VARI > SPACES )
                MOVE OPD-FEC-FREA IN SRT TO CAM-FEC-FCAM IN CAM(1)
                MOVE OPD-FEC-FREA IN SRT TO CAM-FEC-FCAM IN CAM(2)
                MOVE 'I'          TO CAM-MSC-TVAL IN CAM(1)
                MOVE WSS-COD-CVTI TO CAM-COD-CVAL IN CAM(1)
                MOVE WSS-COD-PBTI TO CAM-COD-TCAM IN CAM(1)
                MOVE OPD-COD-VCAM IN SRT TO CAM-COD-VCAM IN CAM(2)

                MOVE FIO-GET-KEY TO FIO-CMND
                PERFORM TAB-FIO-CAM
                IF ( NOT FIO-STAT-OKS ) OR
                   ( CAM-MSC-STAT IN CAM NOT = 'S' )
                    DISPLAY ' ' 
                    DISPLAY 'NO EXISTE VALOR DE CAMBIO TASA BASE'
                             CAM-KEY-IREG IN CAM
                ELSE
                    ADD CAM-SGV-VCAM IN CAM TO INT-TINT
                    DISPLAY 'TASA BASE ' CAM-SGV-VCAM IN CAM ' '
                         OPD-SGV-TINT IN SRT ' ' INT-TINT.
       FIN-OBT-TASA-BAS.
           EXIT.
      *>>>>
*% END
