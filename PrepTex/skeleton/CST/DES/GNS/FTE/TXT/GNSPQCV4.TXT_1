*%! Codigo adicional para GNSPACV4 Novedades
*% IF SETTAG
*% FNCPQ = "CVTWEB"
*% VSNPQ = "07.02.07"
*% FNCPU = "CVTWEB"
*% VSNPU =  "07.02.07"
*% END
*% NO_HDR_CST = TRUE
*% PGM_PTC = TRUE
*% IF WSS
      *<<<< WSS
      
      *Entidades de GNS
       COPY GNSBRCVM.
       77  WSS-AKEY           VALUE SPACES        PIC X(32).
       COPY GNSWGCV4.
      *>>>> WSS
*% END
*% IF WSS_DTC
      *<<<< WSS_DTC
      *Entidades de SGC
       COPY GNSWGRQA REPLACING ==ADR-REQA== BY ==ADR-CVM-REQA==.
      *>>>>
*% END
*% IF INI_FIO
      *<<<< INI_FIO
           MOVE TSK-TERM-ALF    TO TS-CV4-TERM-OCC.
      *>>>> INI_FIO
*% END
*% IF FND_KEY
      *<<<< FND_KEY
      
           IF FRM-COD-BUSQ IN CV4-FLD = 'F-REVISION'
               MOVE CVP-COD-PAMB IN CV4-FLD TO CVP-COD-RAMB IN CVP
               MOVE FRM-NUM-DDES IN CV4-FLD TO CVP-NUM-DREV IN CVP
               MOVE FRM-NUM-MDES IN CV4-FLD TO CVP-NUM-MREV IN CVP
               MOVE FRM-NUM-SDES IN CV4-FLD TO CVP-NUM-SREV IN CVP
               MOVE FRM-NUM-ADES IN CV4-FLD TO CVP-NUM-AREV IN CVP
               MOVE FRM-HRA-HDES IN CV4-FLD TO CVP-HRA-HREV IN CVP
               MOVE 'CVP-KEY-REVI'      TO WSS-AKEY
           ELSE
               MOVE CVP-COD-PAMB IN CV4-FLD TO CVP-COD-IAMB IN CVP
               MOVE FRM-NUM-DDES IN CV4-FLD TO CVP-NUM-DPFF IN CVP
               MOVE FRM-NUM-MDES IN CV4-FLD TO CVP-NUM-MPFF IN CVP
               MOVE FRM-NUM-SDES IN CV4-FLD TO CVP-NUM-SPFF IN CVP
               MOVE FRM-NUM-ADES IN CV4-FLD TO CVP-NUM-APFF IN CVP
               MOVE FRM-HRA-HDES IN CV4-FLD TO CVP-HRA-HPHF IN CVP
               IF CVP-COD-PROG IN CV4-FLD = '*'
                   MOVE 'CVP-STP-IPFF'   TO WSS-AKEY
               ELSE
                   MOVE 'CVP-KEY-IREG'   TO WSS-AKEY.
      
           IF CVP-COD-PROG IN CV4-FLD = '*'
              MOVE SPACES              TO CVP-COD-PROG IN CVP
              MOVE SPACES              TO CVP-COD-PROG IN CV4-FLD
              MOVE SPACES              TO CVP-COD-PREV IN CVP.

      *     MOVE 'CV4KIREG' TO QUE-COLA.
      *     MOVE QUE-PUT TO QUE-CMND.
      *     MOVE +100 TO QUE-LITM.
      *     MOVE CVP-KEY-IREG IN CVP TO QUE-ITEM.
      *     PERFORM GNS-PRO-QUE.

      *     MOVE 'CV4KREVI' TO QUE-COLA.
      *     MOVE QUE-PUT TO QUE-CMND.
      *     MOVE +100 TO QUE-LITM.
      *     MOVE CVP-KEY-REVI IN CVP TO QUE-ITEM.
      *     PERFORM GNS-PRO-QUE.
      
      *     MOVE 'CV4KFUNC' TO QUE-COLA.
      *     MOVE QUE-PUT TO QUE-CMND.
      *     MOVE +100 TO QUE-LITM.
      *     MOVE CVP-KEY-FUNC IN CVP TO QUE-ITEM.
      *     PERFORM GNS-PRO-QUE.
      
      *     MOVE 'CV4KAKEY' TO QUE-COLA.
      *     MOVE QUE-PUT TO QUE-CMND.
      *     MOVE +100 TO QUE-LITM.
      *     MOVE WSS-AKEY TO QUE-ITEM.
      *     PERFORM GNS-PRO-QUE.
      
           MOVE WSS-AKEY TO FIO-AKEY.

           IF SCR-CMND = 'NLS'
               MOVE FIO-GET-NLS                TO FIO-CMND
               PERFORM GNS-FIO-CVP
               MOVE FIO-STAT TO PGM-STAT-CVP
               IF NOT FIO-STAT-OKS
                  GO TO FIN-FND-KEY.
      
      *>>>>
*% END
*% IF FIN_FND_KEY
      *<<<< FIN_FND_KEY
           IF NOT PGM-STAT-CVP-OKS
               GO TO FIN-FND-KEY.

      * NXN = NeXt Novedad ( No necesariamente next program )
      *       ( Puede ser el mismo programa en otro instante )
           IF SCR-CMND = 'NXN'
               MOVE WSS-AKEY TO FIO-AKEY
               MOVE FIO-GET-NXT                TO FIO-CMND
               PERFORM GNS-FIO-CVP
               MOVE FIO-STAT TO PGM-STAT-CVP
               IF NOT FIO-STAT-OKS
                  GO TO FIN-FND-KEY.

           IF FRM-COD-COPY IN CV4-FLD NOT > SPACES
               MOVE CVP-COD-PAMB IN CVP TO CVM-COD-PAMB IN CVM
               MOVE CVP-COD-PROG IN CVP TO CVM-COD-PROG IN CVM
               MOVE CVP-FEC-FPFF IN CVP TO CVM-FEC-FFFP IN CVM
               MOVE CVP-HRA-HPHF IN CVP TO CVM-HRA-HPHF IN CVM
               MOVE FIO-GET-NLS TO FIO-CMND
               PERFORM PRO-CVM
           ELSE
               MOVE CVP-COD-PAMB IN CVP     TO CVM-COD-CAMB IN CVM
               MOVE FRM-COD-COPY IN CV4-FLD TO CVM-COD-COPY IN CVM
               MOVE CVP-COD-PROG IN CVP     TO CVM-COD-PROG IN CVM
               MOVE CVP-FEC-FPFF IN CVP     TO CVM-FEC-FFFC IN CVM
               MOVE CVP-HRA-HPHF IN CVP     TO CVM-HRA-HCHF IN CVM
               MOVE FIO-GET-KEY TO FIO-CMND
               PERFORM GNS-FIO-CVM
               PERFORM PRO-CVM.
      *>>>> FIN_FND_KEY
*% END
*% IF FIN_SCR_TRL
      *<<<< FIN_SCR_TRL
      *>>>> FIN_SCR_TRL
*% END
*% IF FIN_HBL_FLD
      *<<<< FIN_HBL_FLD
      *>>>> FIN_HBL_FLD
*% END
*% IF SCR_GFLD_VAL_FLD
      *<<<< SCR_GFLD_VAL_FLD
      *>>>>
*% END
*% IF CMN_ING
      *<<<< CMN_ING
      *>>>> CMN_ING
*% END
*% IF FIN_CMN_ING
      *<<<< FIN_CMN_ING
      *>>>> FIN_CMN_ING
*% END
*% IF CMN_MOD_RET
      *<<<< CMN_MOD_RET
      *>>>> CMN_MOD_RET
*% END
*% IF INI_CMN_MOD
      *<<<< INI_CMN_MOD
      *>>>> INI_CMN_MOD
*% END
*% IF CMN_ELI
      *<<<< CMN_ELI
      *>>>> CMN_ELI
*% END
*% IF FIN_CMN_ELI
      *<<<< FIN_CMN_ELI
      *>>>> FIN_CMN_ELI
*% END
*% IF CMN_ACC
      *<<<< CMN_ACC
      *>>>> CMN_ACC
*% END
*% IF EOF_PQ
      *<<<< EOF_PQ
      
      *>>>> EOF_PQ
*% END
*% IF EOF_PU
      *<<<< EOF_PU
      *>>>> EOF_PU
*% END
*% IF EOF
      *<<<< EOF

       PRO-CVM SECTION.
       INI-PRO-CVM.
           MOVE 'CVM-KEY-PROG'      TO FIO-AKEY.
           PERFORM GNS-FIO-CVM.
           MOVE FIO-STAT TO PGM-STAT-CVM.

      * NO ENCUENTRA UN REGISTRO CVM
      *          OR
      * SI ENCUENTRA UN REGISTRO CVM, PERO
      * LAS CLAVES NO COINCIDEN Y ES EL PRIMER
      * ACCESO A CVM ( FIO-GET-NLS )
      * ==> INFORMA QUE NO EXISTEN REGISTROS CVM
           IF NOT FIO-STAT-OKS
                 OR
               ( FIO-CMND = FIO-GET-NLS
                 AND 
                 NOT
                  ( CVP-COD-PAMB IN CVP = CVM-COD-PAMB IN CVM AND
                    CVP-COD-PROG IN CVP = CVM-COD-PROG IN CVM AND
                    CVP-FEC-FPFF IN CVP = CVM-FEC-FFFP IN CVM AND
                    CVP-HRA-HPHF IN CVP = CVM-HRA-HPHF IN CVM
                  )
               )
               MOVE 'GNS'          TO MSG-COD-SIST
               MOVE 'CVM    NEX'   TO MSG-COD-MENS
               PERFORM GET-MSG
               MOVE MSG-GLS-DESC   TO FRM-MENS
               MOVE '00'           TO FIO-STAT
               GO TO FIN-PRO-CVM
           ELSE
      * ENCONTRO UN REGISTRO CVM QUE PERTENECE A UNA
      * 'INSTANCIA'DE CVP
      *
      * ANTES DE GRABAR LA TS VERIFICA QUE LA RECIENTE
      * LECTURA NO HAYA SOBREPASADO EL LIMITE DE
      * OCURRENCIAS PARA CVM
               ADD 1 TO TS-CV4-IDX-OCC
               IF  TS-CV4-IDX-OCC > TS-CV4-TOT-OCC
                    MOVE 'S' TO FRM-COD-HMAS IN CV4-FLD
                    GO TO FIN-PRO-CVM
               ELSE
                    MOVE 'N' TO FRM-COD-HMAS IN CV4-FLD
                    MOVE TS-CV4-IDX-OCC TO FRM-NUM-TOCC IN CV4-FLD

                    MOVE CVM-COD-COPY IN CVM     TO TS-CVM-COD-COPY
                    MOVE FRM-NUM-CORR IN CV4-FLD TO TS-FRM-NUM-CORR
                    MOVE CVM-COD-CVCA IN CVM     TO TS-CVM-COD-CVCA
                    MOVE CVM-COD-ESQL IN CVM     TO TS-CVM-COD-ESQL
                    MOVE CVM-COD-CVDT IN CV4-FLD TO TS-CVM-COD-CVDT
                    MOVE CVM-COD-CVSN IN CVM     TO TS-CVM-COD-CVSN
                    MOVE FRM-GLS-CVDT IN CV4-FLD TO TS-FRM-GLS-CVDT
                    MOVE CVM-COD-CFNC IN CVM     TO TS-CVM-COD-CFNC
                    MOVE FRM-GLS-CFNC IN CV4-FLD TO TS-FRM-GLS-CFNC
                    MOVE CVM-COD-CVGM IN CVM     TO TS-CVM-COD-CVGM
                    MOVE CVM-COD-CGEN IN CVM     TO TS-CVM-COD-CGEN

                    MOVE TS-CV4-COLA-OCC TO QUE-COLA
                    MOVE TS-CV4-LITM-OCC TO QUE-LITM
                    MOVE TS-CV4-OCC      TO QUE-ITEM
                    MOVE QUE-PUT         TO QUE-CMND
                    PERFORM GNX-PRO-QUE
                    MOVE FIO-GET-NXT TO FIO-CMND
                    GO TO INI-PRO-CVM.
       FIN-PRO-CVM.
           EXIT.

       GNX-PRO-QUE SECTION.
       INI-GNX-PRO-QUE.
      *     IF SCR-OFRM-SRV
               PERFORM GNS-PRO-QUE.
       FIN-GNX-PRO-QUE.
           EXIT.

       COPY GNSBFCVM.
      *>>>>
*% END
