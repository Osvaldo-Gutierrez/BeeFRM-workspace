       IDENTIFICATION DIVISION.
      *=======================
       PROGRAM-ID.      GNSPLRFC.
       AUTHOR.          CONSIST.
       DATE-WRITTEN.    14-Oct-91 08:57 PM.

      * Programa Listador de Reporte RFC con Sort.

       ENVIRONMENT DIVISION.
      *====================
       CONFIGURATION SECTION.
      *---------------------
       SPECIAL-NAMES.
            DECIMAL-POINT IS COMMA.
       INPUT-OUTPUT SECTION.
      *--------------------
       FILE-CONTROL.
           SELECT GNSSRT         ASSIGN TO 'SYS$DISK:'.
           SELECT RPTRFC	   ASSIGN TO RPTRFC.

       DATA DIVISION.
      *=============
       FILE SECTION.
      *------------
       SD  GNSSRT.
       COPY GNSRRRFC.
       FD  RPTRFC LABEL RECORDS OMITTED
           REPORT IS RPT-RFC
           .

       WORKING-STORAGE SECTION.
      *-----------------------
       COPY GNSBRREL.
       COPY GNSWCFIO.
       COPY GNSWVFIO.
       COPY GNSWGRPT.
       COPY GNSBRTAB.
       COPY GNSBRMSG.
       COPY GNSRWRFC.
       COPY GNSWGSYS.
       01  PGM-STAT.
           03 PGM-STAT-SRT            VALUE ' ' PIC X(01).
              88 PGM-STAT-SRT-OKS     VALUE ' '.
              88 PGM-STAT-SRT-MAL     VALUE 'M'.
           03 PGM-SOKS                VALUE ' ' PIC X(01).
           03 PGM-SMAL                VALUE 'M' PIC X(01).
      *<<<< WSS
      * COPY DOCWSS IN TXT.
       COPY GNSBRENT.
       01  WSS-VARI.
           03 WSS-TEN1                                 PIC X(01).
              88 WSS-TEN1-MODU           VALUE 'M'.
              88 WSS-TEN1-REGI           VALUE 'R'.
              88 WSS-TEN1-ARCH           VALUE 'A'.
              88 WSS-TEN1-PROG           VALUE 'P'.
              88 WSS-TEN1-FORM           VALUE 'F'.
              88 WSS-TEN1-INFO           VALUE 'I'.
              88 WSS-TEN1-TRAN           VALUE 'T'.
           03 WSS-TEN2                                 PIC X(01).
              88 WSS-TEN2-MODU           VALUE 'M'.
              88 WSS-TEN2-REGI           VALUE 'R'.
              88 WSS-TEN2-ARCH           VALUE 'A'.
              88 WSS-TEN2-PROG           VALUE 'P'.
              88 WSS-TEN2-FORM           VALUE 'F'.
              88 WSS-TEN2-INFO           VALUE 'I'.
              88 WSS-TEN2-TRAN           VALUE 'T'.
           03 WSS-GLS-MODU                             PIC X(13)
                                         VALUE 'odulo        '.
           03 WSS-GLS-REGI                             PIC X(13)
                                         VALUE 'egistro      '.
           03 WSS-GLS-ARCH                             PIC X(13)
                                         VALUE 'rchivo       '.
           03 WSS-GLS-PROG                             PIC X(13)
                                         VALUE 'rograma      '.
           03 WSS-GLS-FORM                             PIC X(13)
                                         VALUE 'ormulario    '.
           03 WSS-GLS-INFO                             PIC X(13)
                                         VALUE 'nforme       '.
           03 WSS-GLS-TRAN                             PIC X(13)
                                         VALUE 'ransaccion   '.
           03 WSS-COD-TMB1.
              05 WSS-COD-TEN1                          PIC X(01).
              05 WSS-COD-MOD1                          PIC X(12).
              05 WSS-COD-BIB1                          PIC X(06).
           03 WSS-COD-TMB2.
              05 WSS-COD-TEN2                          PIC X(01).
              05 WSS-COD-MOD2                          PIC X(12).
              05 WSS-COD-BIB2                          PIC X(06).
           03 DOC-E1E2           OCCURS 100.
              05 DOC-ENT1.
                 07 DOC-TEN1                           PIC X(01).
                 07 DOC-MOD1                           PIC X(12).
                 07 DOC-BIB1                           PIC X(06).
              05 DOC-ENT2.
                 07 DOC-TEN2                           PIC X(01).
                 07 DOC-MOD2                           PIC X(12).
                 07 DOC-BIB2                           PIC X(06).
           03 WSS-SIND.
              05 I              COMP                   PIC 9(04).
              05 ICOL           COMP                   PIC 9(04).
              05 PHIJ           COMP                   PIC 9(04).
              05 UHIJ           COMP     VALUE 0       PIC 9(04).
      *JSS
           03 WSS-INCH                   VALUE 0       PIC 9(01).
              88 WSS-CORTE-TEN2          VALUE 1.
              88 WSS-CORTE-MOD2          VALUE 2.
              88 WSS-CORTE-BIB2          VALUE 3.
      *>>>>

       REPORT SECTION.
      *--------------
       COPY GNSRFRFC.
           .
       COPY GNSRTRFC.

       PROCEDURE DIVISION.
      *==================
       DECLARATIVES.
       DEC-CH-RFC-REL-KEY-TEN2 SECTION.
           USE BEFORE REPORTING CH-RFC-REL-KEY-TEN2.
       INI-CH-RFC-REL-KEY-TEN2.
      *<<<< CH_RFC_REL_KEY_TEN2 OR CH_RFC_REL_KEY_MOD2 OR CH_RFC_REL_KEY_BIB2
           MOVE REL-KEY-TEN2 IN SRT TO WSS-TEN2.
           IF WSS-TEN2-MODU
               MOVE WSS-GLS-MODU TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-REGI
               MOVE WSS-GLS-REGI TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-ARCH
               MOVE WSS-GLS-ARCH TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-PROG
               MOVE WSS-GLS-PROG TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-FORM
               MOVE WSS-GLS-FORM TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-INFO
               MOVE WSS-GLS-INFO TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-TRAN
               MOVE WSS-GLS-TRAN TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
               DISPLAY 'ERROR: TIPO DE ENTIDAD NO CORRESPONDE'
               COPY GNSBGGBK.
           MOVE REL-KEY-TEN2 IN SRT TO ENT-KEY-TENT.
           MOVE REL-KEY-MOD2 IN SRT TO ENT-KEY-MODU.
           MOVE REL-KEY-BIB2 IN SRT TO ENT-KEY-BIBL.
           MOVE FIO-GET-KEY TO FIO-CMND.
           CALL 'GNSPFENT' USING FIO-VARI ENT.
           IF FIO-STAT-OKS
               MOVE ENT-GLS-DESC TO WSS-GLS-DES2 IN WSS-RFC
           ELSE
               MOVE SPACES TO WSS-GLS-DES2 IN WSS-RFC.
      *>>>>
      *<<<< CH_RFC_REL_KEY_TEN2
           MOVE 1 TO WSS-INCH.
      *>>>>
       FIN-CH-RFC-REL-KEY-TEN2.
           EXIT.
       DEC-CH-RFC-REL-KEY-MOD2 SECTION.
           USE BEFORE REPORTING CH-RFC-REL-KEY-MOD2.
       INI-CH-RFC-REL-KEY-MOD2.
      *<<<< CH_RFC_REL_KEY_TEN2 OR CH_RFC_REL_KEY_MOD2 OR CH_RFC_REL_KEY_BIB2
           MOVE REL-KEY-TEN2 IN SRT TO WSS-TEN2.
           IF WSS-TEN2-MODU
               MOVE WSS-GLS-MODU TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-REGI
               MOVE WSS-GLS-REGI TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-ARCH
               MOVE WSS-GLS-ARCH TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-PROG
               MOVE WSS-GLS-PROG TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-FORM
               MOVE WSS-GLS-FORM TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-INFO
               MOVE WSS-GLS-INFO TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-TRAN
               MOVE WSS-GLS-TRAN TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
               DISPLAY 'ERROR: TIPO DE ENTIDAD NO CORRESPONDE'
               COPY GNSBGGBK.
           MOVE REL-KEY-TEN2 IN SRT TO ENT-KEY-TENT.
           MOVE REL-KEY-MOD2 IN SRT TO ENT-KEY-MODU.
           MOVE REL-KEY-BIB2 IN SRT TO ENT-KEY-BIBL.
           MOVE FIO-GET-KEY TO FIO-CMND.
           CALL 'GNSPFENT' USING FIO-VARI ENT.
           IF FIO-STAT-OKS
               MOVE ENT-GLS-DESC TO WSS-GLS-DES2 IN WSS-RFC
           ELSE
               MOVE SPACES TO WSS-GLS-DES2 IN WSS-RFC.
      *>>>>
      *<<<< CH_RFC_REL_KEY_MOD2
           IF WSS-CORTE-TEN2
               SUPPRESS PRINTING
               MOVE 2 TO WSS-INCH
           ELSE
               MOVE 2 TO WSS-INCH.
      *>>>>
       FIN-CH-RFC-REL-KEY-MOD2.
           EXIT.
       DEC-CH-RFC-REL-KEY-BIB2 SECTION.
           USE BEFORE REPORTING CH-RFC-REL-KEY-BIB2.
       INI-CH-RFC-REL-KEY-BIB2.
      *<<<< CH_RFC_REL_KEY_TEN2 OR CH_RFC_REL_KEY_MOD2 OR CH_RFC_REL_KEY_BIB2
           MOVE REL-KEY-TEN2 IN SRT TO WSS-TEN2.
           IF WSS-TEN2-MODU
               MOVE WSS-GLS-MODU TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-REGI
               MOVE WSS-GLS-REGI TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-ARCH
               MOVE WSS-GLS-ARCH TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-PROG
               MOVE WSS-GLS-PROG TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-FORM
               MOVE WSS-GLS-FORM TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-INFO
               MOVE WSS-GLS-INFO TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
           IF WSS-TEN2-TRAN
               MOVE WSS-GLS-TRAN TO WSS-GLS-TEN2 IN WSS-RFC
           ELSE
               DISPLAY 'ERROR: TIPO DE ENTIDAD NO CORRESPONDE'
               COPY GNSBGGBK.
           MOVE REL-KEY-TEN2 IN SRT TO ENT-KEY-TENT.
           MOVE REL-KEY-MOD2 IN SRT TO ENT-KEY-MODU.
           MOVE REL-KEY-BIB2 IN SRT TO ENT-KEY-BIBL.
           MOVE FIO-GET-KEY TO FIO-CMND.
           CALL 'GNSPFENT' USING FIO-VARI ENT.
           IF FIO-STAT-OKS
               MOVE ENT-GLS-DESC TO WSS-GLS-DES2 IN WSS-RFC
           ELSE
               MOVE SPACES TO WSS-GLS-DES2 IN WSS-RFC.
      *>>>>
      *<<<< CH_RFC_REL_KEY_BIB2
           IF WSS-CORTE-MOD2
               SUPPRESS PRINTING
               MOVE 0 TO WSS-INCH
           ELSE
               MOVE 3 TO WSS-INCH.
      *>>>>
       FIN-CH-RFC-REL-KEY-BIB2.
           EXIT.
       DEC-CH-RFC-REL-KEY-TEN1 SECTION.
           USE BEFORE REPORTING CH-RFC-REL-KEY-TEN1.
       INI-CH-RFC-REL-KEY-TEN1.
      *<<<< CH_RFC_REL_KEY_TEN1
           MOVE REL-KEY-TEN1 IN SRT TO WSS-TEN1.
           IF WSS-TEN1-MODU
               MOVE WSS-GLS-MODU TO WSS-GLS-TEN1 IN WSS-RFC
           ELSE
           IF WSS-TEN1-REGI
               MOVE WSS-GLS-REGI TO WSS-GLS-TEN1 IN WSS-RFC
           ELSE
           IF WSS-TEN1-ARCH
               MOVE WSS-GLS-ARCH TO WSS-GLS-TEN1 IN WSS-RFC
           ELSE
           IF WSS-TEN1-PROG
               MOVE WSS-GLS-PROG TO WSS-GLS-TEN1 IN WSS-RFC
           ELSE
           IF WSS-TEN1-FORM
               MOVE WSS-GLS-FORM TO WSS-GLS-TEN1 IN WSS-RFC
           ELSE
           IF WSS-TEN1-INFO
               MOVE WSS-GLS-INFO TO WSS-GLS-TEN1 IN WSS-RFC
           ELSE
           IF WSS-TEN1-TRAN
               MOVE WSS-GLS-TRAN TO WSS-GLS-TEN1 IN WSS-RFC
           ELSE
               DISPLAY 'ERROR: TIPO DE ENTIDAD NO CORRESPONDE'
               COPY GNSBGGBK.
      *>>>>
       FIN-CH-RFC-REL-KEY-TEN1.
           EXIT.
       DEC-DL-RFC SECTION.
           USE BEFORE REPORTING DL-RFC.
       INI-DL-RFC.
       FIN-DL-RFC.
           EXIT.
       END DECLARATIVES.

       MAIN SECTION.
      *------------
       INI-MAIN.
           MOVE 'GNSPLRFC' TO FIO-PROG.
           MOVE FIO-ACCS-UPD TO FIO-ACCS.
            MOVE FIO-ACC      TO FIO-CMND.
           MOVE 'GNS'        TO FIO-SIST.
           PERFORM GNS-FIO-TAB.

           MOVE FIO-INP      TO FIO-CMND.
           MOVE 'GNS'        TO FIO-SIST.
           PERFORM GNS-FIO-TAB.
           SORT GNSSRT
       COPY GNSRSRFC.
           INPUT  PROCEDURE IS INP-SRT
           OUTPUT PROCEDURE IS OUT-SRT.
       FIN-MAIN.
           PERFORM GNS-PRO-END.

       INP-SRT SECTION.
      *---------------
       INI-INP-SRT.
      *<<<< INI_INP
           DISPLAY 'TIPO ENTIDAD   1 : ' WITH NO ADVANCING.
           ACCEPT WSS-COD-TEN1.
           DISPLAY 'NOMBRE ENTIDAD 1 : ' WITH NO ADVANCING.
           ACCEPT WSS-COD-MOD1.
           DISPLAY 'BIBLIOTECA     1 : ' WITH NO ADVANCING.
           ACCEPT WSS-COD-BIB1.

           DISPLAY 'TIPO ENTIDAD   2 : ' WITH NO ADVANCING.
           ACCEPT WSS-COD-TEN2.
           DISPLAY 'NOMBRE ENTIDAD 2 : ' WITH NO ADVANCING.
           ACCEPT WSS-COD-MOD2.
           DISPLAY 'BIBLIOTECA     2 : ' WITH NO ADVANCING.
           ACCEPT WSS-COD-BIB2.

           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           PERFORM GNS-FIO-REL.
      *>>>>
           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           PERFORM GNS-FIO-REL.
           MOVE FIO-INP TO FIO-CMND.
           PERFORM GNS-FIO-REL.
       FST-INP-SRT.
           MOVE FIO-GET-FST TO FIO-CMND.
           PERFORM GNS-FIO-REL.
       LUP-INP-SRT.
           IF NOT FIO-STAT-OKS
              GO TO FIN-INP-SRT.
      *<<<< LUP_INP
           IF NOT ( ( ( WSS-COD-TEN1 = '*' OR REL-COD-TEN1 ) AND
                      ( WSS-COD-MOD1 = '*' OR REL-COD-MOD1 ) AND
                      ( WSS-COD-BIB1 = '*' OR REL-COD-BIB1 ) )  AND
                    ( ( WSS-COD-TEN2 = '*' OR REL-COD-TEN1 ) AND
                      ( WSS-COD-MOD2 = '*' OR REL-COD-MOD1 ) AND
                      ( WSS-COD-BIB2 = '*' OR REL-COD-BIB1 ) ) )
               GO TO LUP-INP-SRT.
           IF NOT ( '*' = WSS-COD-TEN1 AND WSS-COD-MOD1 AND WSS-COD-BIB1
                    AND WSS-COD-TEN2 AND WSS-COD-MOD2 AND WSS-COD-BIB2 )
               PERFORM CHK-ESTA VARYING I FROM 1 BY 1 UNTIL I > UHIJ
                                 OR REL-KEY-ENT2 = DOC-ENT2( I )
               IF I > UHIJ
                   ADD 1 TO UHIJ
                   MOVE REL-KEY-E1E2 TO DOC-E1E2( UHIJ ).
      *>>>>
       MOV-INP-SRT.
       COPY GNSRMRFC.
           RELEASE SRT.
       NXT-INP-SRT.
           MOVE FIO-GET-NXT TO FIO-CMND.
           PERFORM GNS-FIO-REL.
           GO TO LUP-INP-SRT.
       FIN-INP-SRT.
      *<<<< FIN_INP
           ADD 1 UHIJ GIVING PHIJ.
           PERFORM PUT-HIJO VARYING ICOL FROM 1    BY 1
                                         UNTIL ICOL > UHIJ.
           PERFORM GEN-LDET VARYING ICOL FROM PHIJ BY 1
                                         UNTIL ICOL > UHIJ.
      *>>>>
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM GNS-FIO-REL.

       OUT-SRT SECTION.
      *---------------
       INI-OUT-SRT.
           IF PGM-STAT-SRT-MAL
               GO TO EXT-OUT-SRT.
      *<<<< INI_OUT
           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           PERFORM GNS-FIO-ENT.
           MOVE FIO-INP      TO FIO-CMND.
           PERFORM GNS-FIO-ENT.

           MOVE FIO-ACCS-UPD TO FIO-ACCS.
           MOVE FIO-ACC      TO FIO-CMND.
           PERFORM GNS-FIO-REL.
           MOVE FIO-INP      TO FIO-CMND.
           PERFORM GNS-FIO-REL.

           MOVE 'REL-KEY-ENT2'  TO FIO-AKEY.
           MOVE FIO-FND-FST-ALT TO FIO-CMND.
           PERFORM GNS-FIO-REL.
      *>>>>
           OPEN OUTPUT RPTRFC.
           CALL 'GNSPLHDR' USING RPT-VARI.
           INITIATE RPT-RFC.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
       LUP-OUT-SRT.
      *<<<< LUP_OUT
           MOVE REL-KEY-TEN1 IN SRT TO ENT-KEY-TENT.
           MOVE REL-KEY-MOD1 IN SRT TO ENT-KEY-MODU.
           MOVE REL-KEY-BIB1 IN SRT TO ENT-KEY-BIBL.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM GNS-FIO-ENT.
           IF FIO-STAT-OKS
               MOVE ENT-GLS-DESC TO WSS-GLS-DES1 IN WSS-RFC
           ELSE
               MOVE SPACES TO WSS-GLS-DES1 IN WSS-RFC.
      *>>>>
       GEN-OUT-SRT.
           GENERATE DL-RFC.
       NXT-OUT-SRT.
           RETURN GNSSRT AT END
                GO TO FIN-OUT-SRT.
           GO TO LUP-OUT-SRT.
       FIN-OUT-SRT.
      *<<<< FIN_OUT
           MOVE FIO-CLO TO FIO-CMND.
           PERFORM GNS-FIO-ENT.
      *>>>>
           TERMINATE RPT-RFC.
           CLOSE RPTRFC.
       EXT-OUT-SRT.
           EXIT.

       COPY GNSBFREL.
       COPY GNSBBSYS.
       COPY GNSBFTAB.
       COPY GNSBFMSG.

       GNS-PRO-END SECTION.
       INI-GNS-PRO-END.
           STOP RUN.
       FIN-GNS-PRO-END.
           EXIT.

      *<<<< EOF
       PUT-HIJO SECTION.
      *----------------
       INI-PUT-HIJO.
           MOVE DOC-ENT2( ICOL ) TO REL-KEY-ENT1.
           MOVE SPACES           TO REL-KEY-ENT2.
           MOVE FIO-GET-GRT TO FIO-CMND.
           PERFORM GNS-FIO-REL.
           IF NOT ( FIO-STAT-OKS AND DOC-ENT2( ICOL ) = REL-KEY-ENT1 )
               GO TO FIN-PUT-HIJO.
       LUP-PUT-HIJO.
           PERFORM CHK-ESTA VARYING I FROM 1 BY 1 UNTIL I > UHIJ OR
                                      REL-KEY-ENT2 = DOC-ENT2( I ).
           IF I > UHIJ
               ADD 1 TO UHIJ
               MOVE REL-KEY-E1E2 TO DOC-E1E2( UHIJ ).
           MOVE FIO-GET-NXT TO FIO-CMND.
           PERFORM GNS-FIO-REL.
           IF FIO-STAT-OKS AND DOC-ENT2( ICOL ) = REL-KEY-ENT1
               GO TO LUP-PUT-HIJO.
       FIN-PUT-HIJO.
           EXIT.

       GEN-LDET SECTION.
      *----------------
       INI-GEN-LDET.
           MOVE DOC-E1E2( ICOL ) TO SRT.
           MOVE REL-KEY-TEN2 IN SRT TO ENT-KEY-TENT.
           MOVE REL-KEY-MOD2 IN SRT TO ENT-KEY-MODU.
           MOVE REL-KEY-BIB2 IN SRT TO ENT-KEY-BIBL.
           MOVE FIO-GET-KEY TO FIO-CMND.
           PERFORM GNS-FIO-ENT.
           IF FIO-STAT-OKS
               MOVE ENT-GLS-DESC TO WSS-GLS-DES2 IN WSS-RFC
           ELSE
               MOVE SPACES TO WSS-GLS-DES2 IN WSS-RFC.
           GENERATE DL-RFC.
       FIN-GEN-LDET.
           EXIT.

       CHK-ESTA SECTION.
      *----------------
       INI-CHK-ESTA.
       FIN-CHK-ESTA.
           EXIT.

       COPY GNSBFENT.
      *>>>>
