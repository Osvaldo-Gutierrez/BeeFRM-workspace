IDENTIFICATION DIVISION.
*=======================
PROGRAM-ID.	DESGENREL.
AUTHOR. 	GUZMAN Y CIA.

* Procesa Procedimiento para Relaciones, ante un cambio en una Entidad

ENVIRONMENT DIVISION.
*====================

DATA DIVISION.
*=============

WORKING-STORAGE SECTION.
*-----------------------
COPY	FIOWSS		IN	DESTXT.
COPY	DOCWSS		IN	TXT.
COPY	'DESREG.ENT'	FROM	DICTIONARY
	REPLACING
	==ENT==	BY 	==ENT EXTERNAL==.
COPY	'DESREG.REL'	FROM	DICTIONARY
	REPLACING
	==REL==	BY 	==REL EXTERNAL==.
COPY	'DESREG.CTL'	FROM	DICTIONARY
	REPLACING
	==CTL==	BY 	==CTL EXTERNAL==.
01 WSS-VARI.
	03 WSS-CMND				PIC X(80).
	03 WSS-REGI				PIC X(06).
	03 WSS-PNTR			VALUE 7	PIC 9(02).
	03 WSS-COD-TENT				PIC X(01).
		88 WSS-COD-MODU		VALUE 'M'.
		88 WSS-COD-REGI		VALUE 'R'.
		88 WSS-COD-ARCH		VALUE 'A'.
		88 WSS-COD-PROG		VALUE 'P'.
		88 WSS-COD-FORM		VALUE 'F'.
		88 WSS-COD-INFO		VALUE 'I'.
	03 WSS-GLS-TPRO				PIC X(01).
		88 WSS-GENPGM		VALUE 'I'.
		88 WSS-GENLIS		VALUE 'L'.
		88 WSS-GENFRM		VALUE 'F'.
		88 WSS-GENFIO		VALUE 'A'.
		88 WSS-CMP		VALUE 'P'.
		88 WSS-SBR		VALUE 'S'.
	03 DOC-E1E2	OCCURS 100.
		05 DOC-ENT1.
			07 DOC-TEN1		PIC X(01).
			07 DOC-MOD1		PIC X(12).
			07 DOC-BIB1		PIC X(06).
		05 DOC-ENT2.
			07 DOC-TEN2		PIC X(01).
			07 DOC-MOD2		PIC X(12).
			07 DOC-BIB2		PIC X(06).
	03 WSS-SIND	COMP.
		05 I			VALUE 1	PIC 9(04).
		05 IAUX				PIC 9(04).
		05 IMAX				PIC 9(04).
01 DCL-VARI	EXTERNAL.
	03 DCL-CMN1				PIC X(60).
	03 DCL-CMN2				PIC X(60).
	03 DCL-IWRT				PIC 9(01).
		88 DCL-IWRT-NOT		VALUE 0.
		88 DCL-IWRT-YES		VALUE 1.

LINKAGE SECTION.
*---------------
01 LNK-CMND					PIC X(80).

PROCEDURE DIVISION USING LNK-CMND.
*=================================

MAIN SECTION.
*------------
INI-MAIN.
	MOVE ZERO   TO DOC-STAT.
	MOVE SPACES TO DOC-MENS.
	UNSTRING LNK-CMND DELIMITED BY '<' OR '>'
		INTO WSS-CMND DOC-CMND WSS-CMND.
	IF DOC-ING
		PERFORM DOC-IENT
		GO TO FIN-MAIN.
	IF DOC-GEN
		PERFORM DOC-GENT
		GO TO FIN-MAIN.
	IF DOC-PRO
		PERFORM DOC-PENT
		GO TO FIN-MAIN.
	DISPLAY '? Codigo '
		LINE 23 COLUMN 1 WITH BELL REVERSED.
ERR-MAIN.
	DISPLAY	LNK-CMND REVERSED
		'  invalido en DESGENREL : ABORTO'
		LINE 24 COLUMN 1 REVERSED.
	STOP RUN.
FIN-MAIN.
	EXIT PROGRAM.

DOC-IENT SECTION.
*----------------
INI-DOC-IENT.
	PERFORM CHK-ESTA VARYING IAUX FROM 1 BY 1 UNTIL IAUX > IMAX OR
						DOC-ENTI = DOC-ENT2( IAUX ).
	IF IAUX NOT > IMAX
		MOVE 3 TO DOC-STAT
		MOVE 'ENTIDAD ya fue Ingresada' TO DOC-MENS
		GO TO FIN-DOC-IENT.
	MOVE SPACES   TO DOC-ENT1( I ).
	MOVE DOC-ENTI TO DOC-ENT2( I ).
	MOVE I TO IMAX.
	PERFORM PUT-HIJO VARYING I FROM I BY 1 UNTIL I > IMAX.
FIN-DOC-IENT.
	EXIT.

PUT-HIJO SECTION.
*----------------
INI-PUT-HIJO.
	MOVE DOC-ENT2( I ) TO REL-KEY-ENT1.
	MOVE SPACES TO REL-KEY-ENT2.
	CALL 'DESFIOREL' USING '<GET_GRT>'.
	IF NOT ( FIO-STAT-OKS AND DOC-ENT2( I ) = REL-KEY-ENT1 )
		GO TO FIN-PUT-HIJO.
LUP-PUT-HIJO.
	PERFORM CHK-ESTA VARYING IAUX FROM 1 BY 1 UNTIL IAUX > IMAX OR
						REL-KEY-ENT2 = DOC-ENT2( IAUX ).
	IF IAUX > IMAX
		ADD 1 TO IMAX
		MOVE REL-KEY-E1E2 TO DOC-E1E2( IMAX ).
	CALL 'DESFIOREL' USING '<GET_NXT>'.
	IF FIO-STAT-OKS AND DOC-ENT2( I ) = REL-KEY-ENT1
		GO TO LUP-PUT-HIJO.
FIN-PUT-HIJO.
	EXIT.

CHK-ESTA SECTION.
*----------------
INI-CHK-ESTA.
FIN-CHK-ESTA.
	EXIT.

DOC-GENT SECTION.
*----------------
INI-DOC-GENT.
	IF IMAX = 0
		MOVE 4 TO DOC-STAT
		MOVE 'NO ha ingresado ninguna Entidad' TO DOC-MENS
		GO TO FIN-DOC-GENT.
	MOVE 'BCH'       TO FIO-VOID.
	CALL 'DESFIOCTL' USING '<VID>'.
	CALL 'DESFIOCTL' USING '<OUT>'.
	MOVE '$ ''BAT''' TO CTL.
	CALL 'DESFIOCTL' USING '<PUT>'.
	MOVE FIO-ACCS-UPD TO FIO-ACCS.
	CALL 'DESFIOENT' USING '<ACC>'.
	CALL 'DESFIOENT' USING '<INP>'.
	PERFORM WRT-SUBR VARYING I FROM 1 BY 1 UNTIL I > IMAX.
	PERFORM WRT-PROG VARYING I FROM 1 BY 1 UNTIL I > IMAX.
	MOVE 1 TO DCL-IWRT.
	CALL 'DESFIOCTL' USING '<CLO>'.
	CALL 'DESFIOENT' USING '<CLO>'.
FIN-DOC-GENT.
	EXIT.

WRT-SUBR SECTION.
*----------------
INI-WRT-SUBR.
	IF DOC-ENT1(I) = SPACES OR DOC-TEN2(I) NOT = 'P'
		GO TO FIN-WRT-SUBR.
	PERFORM GET-TPRO.
	IF WSS-GENFRM
		MOVE SPACES TO WSS-REGI
		UNSTRING DOC-MOD2(I) DELIMITED BY WSS-REGI INTO WSS-REGI
				     WITH POINTER WSS-PNTR
		MOVE SPACES TO CTL
		STRING '$ FMSEXT ' WSS-REGI DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ GENFRM ' DELIMITED BY SIZE
			  WSS-REGI DELIMITED BY SPACES
			  '.FRM' DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ @DESCOM:COB ' DOC-MOD2( I ) DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ LIBINS OBJ ' DOC-MOD2( I ) DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ DELETE/NOLOG/NOCONFIRM ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES '.*;* '
			DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
	ELSE
	IF WSS-GENFIO
		MOVE SPACES TO WSS-REGI
		UNSTRING DOC-MOD2(I) DELIMITED BY WSS-REGI INTO WSS-REGI
				     WITH POINTER WSS-PNTR
		MOVE SPACES TO CTL
		STRING '$ GENFIO FDL:' DELIMITED BY SIZE
			  WSS-REGI DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ @DESCOM:COB ' DOC-MOD2( I ) DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ LIBINS OBJ ' DOC-MOD2( I ) DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ DELETE/NOLOG/NOCONFIRM ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES '.*;* '
			DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
	ELSE
	IF WSS-SBR
		MOVE SPACES TO CTL
		STRING '$ @DESCOM:COB COB:' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES
			' /NOCOPY/NOLIST' DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ LIBINS OBJ ' DOC-MOD2( I ) DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'.
FIN-WRT-SUBR.
	EXIT.

WRT-PROG SECTION.
*-----------------
INI-WRT-PROG.
	IF DOC-ENT1(I) = SPACES OR DOC-TEN2(I) NOT = 'P'
		GO TO FIN-WRT-PROG.
	PERFORM GET-TPRO.
	IF WSS-GENPGM
		MOVE SPACES TO CTL
		STRING '$ GENPGM ' DOC-MOD2( I ) DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ @DESCOM:COM ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES
			' /NOCOPY/NOLIST' DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ PUT ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES
			'.EXE' DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ DELETE/NOLOG/NOCONFIRM ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES '.*;* '
			DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
	ELSE
	IF WSS-GENLIS
		MOVE SPACES TO CTL
		STRING '$ GENLIS ' DOC-MOD2( I ) DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ @DESCOM:COM ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES
			' /NOCOPY/NOLIST' DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ PUT ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES
			'.EXE' DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
		MOVE SPACES TO CTL
		STRING '$ DELETE/NOLOG/NOCONFIRM ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES '.*;* '
			DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'
	ELSE
	IF WSS-CMP
		MOVE SPACES TO CTL
		STRING '$ COPY COB:' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES
			'.COB []' DELIMITED BY CTL INTO CTL
		MOVE SPACES TO CTL
		STRING '$ @DESCOM:CMP ' DELIMITED BY SIZE
			DOC-MOD2( I ) DELIMITED BY SPACES
			' /NOCOPY/NOLIST' DELIMITED BY CTL INTO CTL
		CALL 'DESFIOCTL' USING '<PUT>'.
FIN-WRT-PROG.
	EXIT.

DOC-PENT SECTION.
*----------------
INI-DOC-PENT.
	MOVE '$ DELETE/NOCONFIRM/NOLOG BCH:;' TO DCL-CMN1.
	MOVE 'SUB BCH DOC' TO DCL-CMN2.
	CALL 'DESPRODCL'.
FIN-DOC-PENT.
	EXIT.

GET-TPRO SECTION.
*----------------
INI-GET-TPRO.
	MOVE DOC-ENT2(I) TO ENT-KEY-ENTI.
	CALL 'DESFIOENT' USING '<GET_KEY>'.
	IF NOT FIO-STAT-OKS
		MOVE 5 TO DOC-STAT
		STRING 'NO existe Programa ' DOC-MOD2(I) ' en archivo Entidades'
			DELIMITED BY DOC-MENS INTO DOC-MENS
			GO TO FIN-MAIN.
	MOVE ENT-GLS-TPRO TO WSS-GLS-TPRO.
FIN-GET-TPRO.
	EXIT.
